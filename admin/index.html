<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Alfa ‚Ä¢ Portal da Chapada</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0b1220;
      --line:rgba(255,255,255,.12);
      --text:#f7f7fb;
      --muted:rgba(247,247,251,.7);

      --y:#ffd24a;
      --y2:#ffbb1a;

      --ok:#1dd6a4;
      --danger:#ff5a67;
      --shadow:0 18px 60px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 20% 0%, rgba(255,210,74,.18), transparent 55%),
        radial-gradient(900px 600px at 80% 10%, rgba(255,187,26,.14), transparent 55%),
        linear-gradient(180deg, #070b14, var(--bg));
      padding:18px 14px 90px;
      min-height:100vh;
    }
    .wrap{max-width:1200px;margin:0 auto}

    .top{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 16px;border-radius:22px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line); box-shadow:var(--shadow);
      backdrop-filter: blur(12px);
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .logo{
      width:46px;height:46px;border-radius:16px;overflow:hidden;
      background:rgba(255,255,255,.06);border:1px solid var(--line);
      display:flex;align-items:center;justify-content:center;
    }
    .logo img{width:100%;height:100%;object-fit:cover}
    .brand h1{margin:0;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .brand p{margin:4px 0 0;color:var(--muted);font-size:12px}

    .btn{
      border:none;cursor:pointer;
      padding:10px 12px;border-radius:14px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      font-weight:800;
      display:inline-flex;align-items:center;gap:8px;
    }
    .btn.y{background:linear-gradient(135deg,var(--y),var(--y2)); color:#201400; border-color:rgba(0,0,0,.08)}
    .btn.ghost{background:transparent}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.small{padding:8px 10px;border-radius:12px;font-size:12px}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px}
    .card{
      border-radius:22px;padding:16px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      backdrop-filter: blur(12px);
    }
    .h{margin:0 0 10px;font-size:14px}
    .sub{color:var(--muted);font-size:12px;margin:0 0 12px}

    .row{display:flex;gap:10px;flex-wrap:wrap}
    .field{flex:1;min-width:190px}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input,select{
      width:100%;
      padding:11px 12px;border-radius:14px;
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--text);
      outline:none;
    }
    input:focus,select:focus{border-color:rgba(255,210,74,.55)}

    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:14px}
    .tab{
      padding:10px 12px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      color:var(--muted);font-weight:900;
      cursor:pointer;
    }
    .tab.active{background:rgba(255,210,74,.18); color:var(--text); border-color:rgba(255,210,74,.45)}

    .toolbar{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      margin:12px 0 0;
    }
    .toolbar input{max-width:360px}

    .grid4{
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:12px;margin-top:12px;
    }
    .item{
      border-radius:18px;padding:12px;
      background:rgba(255,255,255,.05);
      border:1px solid var(--line);
      display:flex;flex-direction:column;gap:10px;
      min-height:170px;
    }
    .itemTop{display:flex;align-items:flex-start;justify-content:space-between;gap:8px}
    .ttl{font-weight:900;line-height:1.15}
    .meta{color:var(--muted);font-size:12px}
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 9px;border-radius:999px;
      font-weight:900;font-size:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
    }
    .pill.ok{background:rgba(29,214,164,.14); border-color:rgba(29,214,164,.35)}
    .pill.off{opacity:.65}

    .menuWrap{position:relative}
    .kebab{
      width:38px;height:38px;border-radius:12px;
      display:flex;align-items:center;justify-content:center;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      cursor:pointer;
      font-weight:900;
    }
    .menu{
      position:absolute;right:0;top:44px;z-index:20;
      min-width:220px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#0b1220;
      box-shadow:0 20px 60px rgba(0,0,0,.55);
      overflow:hidden;
      display:none;
    }
    .menu button{
      width:100%;
      text-align:left;
      padding:10px 12px;
      border:none;
      background:transparent;
      color:var(--text);
      cursor:pointer;
      font-weight:800;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .menu button:hover{background:rgba(255,255,255,.06)}
    .menu button.danger{color:#ff7b86}

    .msg{
      margin-top:12px;padding:12px;border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      color:var(--muted);
      font-size:13px;
    }
    .msg.err{border-color:rgba(255,90,103,.45); color:#ffd0d5}
    .msg.ok{border-color:rgba(29,214,164,.40); color:#c9fff0}

    /* ===== LOGIN com imagem de fundo (coloque um arquivo ../login-bg.jpg se quiser) ===== */
    #login{
      min-height:100vh;
      display:flex;align-items:center;justify-content:center;
      position:relative;
      overflow:hidden;
    }
    #login::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(800px 600px at 20% 0%, rgba(255,210,74,.18), transparent 55%),
        radial-gradient(800px 600px at 80% 10%, rgba(255,187,26,.14), transparent 55%),
        linear-gradient(180deg, #070b14, var(--bg));
      z-index:0;
    }
    /* Se voc√™ criar um arquivo /cafeteria/login-bg.jpg ele aparece */
    #login::after{
      content:"";
      position:absolute; inset:0;
      background-image:url("../login-bg.jpg");
      background-size:cover;
      background-position:center;
      opacity:.30;
      z-index:0;
      pointer-events:none;
    }
    .loginWrap{
      width:100%;
      display:flex;flex-direction:column;
      align-items:center;justify-content:center;
      gap:16px;padding:28px;
      position:relative; z-index:1;
    }
    .loginHeroLogo img{
      width:190px;max-width:70vw;height:auto;display:block;
      filter:drop-shadow(0 10px 25px rgba(0,0,0,.35));
    }
    .loginCard{
      width:min(420px,92vw);
      border-radius:24px;
      padding:20px;
      background:rgba(0,0,0,.30);
      border:1px solid rgba(255,255,255,.14);
      box-shadow:0 25px 90px rgba(0,0,0,.55);
      backdrop-filter: blur(14px);
      text-align:center;
    }
    .loginCard h2{margin:8px 0 0}
    .loginCard p{margin:6px 0 14px;color:var(--muted);font-size:13px}
    .loginForm{text-align:left;margin-top:8px}
    .sp10{height:10px}
    .loginActions{justify-content:center;margin-top:14px;gap:10px}
    .btn.gIcon{
      width:44px;min-width:44px;height:40px;padding:0;border-radius:12px;
      display:flex;align-items:center;justify-content:center
    }
    .gMark{font-weight:900;font-size:18px;line-height:1;letter-spacing:-1px}

    /* ===== MODAL EDITAR (bonitinho) ===== */
    .modalBack{
      position:fixed; inset:0; z-index:9999;
      background:rgba(0,0,0,.60);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
    }
    .modal{
      width:min(860px, 96vw);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow:0 25px 80px rgba(0,0,0,.55);
      backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .modalHead{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
    }
    .modalTitle{font-weight:950;margin:0}
    .modalSub{margin:4px 0 0;color:var(--muted);font-size:12px}
    .xbtn{
      width:40px;height:40px;border-radius:14px;
      display:flex;align-items:center;justify-content:center;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      cursor:pointer;
      font-weight:900;
      color:var(--text);
    }
    .xbtn:hover{background:rgba(255,255,255,.10)}
    .modalBody{padding:16px}
    .formGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .span2{grid-column:1/-1}
    .hint{
      font-size:12px;color:var(--muted);
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      margin-bottom:12px;
    }
    .previewRow{
      display:flex;gap:12px;align-items:center;flex-wrap:wrap;
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
    }
    .prevImg{
      width:56px;height:56px;border-radius:16px;overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      display:flex;align-items:center;justify-content:center;
    }
    .prevImg img{width:100%;height:100%;object-fit:cover}
    .modalFoot{
      display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap;
      padding:14px 16px;
      border-top:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.16);
    }

    @media (max-width:1050px){ .grid4{grid-template-columns:repeat(2,minmax(0,1fr))} }
    @media (max-width:720px){
      .grid2{grid-template-columns:1fr}
      .grid4{grid-template-columns:1fr}
      .formGrid{grid-template-columns:1fr}
    }
  </style>
</head>

<body>

<div class="wrap" id="app" style="display:none">

  <div class="top">
    <div class="brand">
      <div class="logo"><img src="../logo.png" onerror="this.style.display='none';this.parentElement.textContent='ADM'"></div>
      <div style="min-width:0">
        <h1>Admin Alfa</h1>
        <p>Gerencie clientes, categorias e produtos.</p>
      </div>
    </div>
    <div class="row">
      <button class="btn ghost" id="btnReload">üîÑ Recarregar</button>
      <button class="btn y" id="btnSair">üö™ Sair</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="clientes">Clientes</button>
    <button class="tab" data-tab="categorias">Categorias</button>
    <button class="tab" data-tab="produtos">Produtos</button>
  </div>

  <div class="grid2">
    <div class="card">
      <h3 class="h">Criar Cliente</h3>
      <p class="sub">Cria a loja + (opcional) cria login do cliente no Supabase Auth (via API).</p>

      <div class="row">
        <div class="field">
          <label>Nome</label>
          <input id="c_nome" placeholder="Ex: Padaria do Z√©" />
        </div>
        <div class="field">
          <label>Slug</label>
          <input id="c_slug" placeholder="ex: padaria-do-ze" />
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>WhatsApp</label>
          <input id="c_whats" placeholder="6299..." />
        </div>
        <div class="field">
          <label>Tipo de neg√≥cio</label>
          <select id="c_tipo">
            <option value="">Selecione‚Ä¶</option>
            <option>Restaurante</option>
            <option>Mercado</option>
            <option>Padaria</option>
            <option>Lanchonete</option>
            <option>Cafeteria</option>
            <option>Pousada</option>
            <option>Hotel</option>
            <option>Servi√ßos</option>
            <option>Outro</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>Logo URL (opcional)</label>
          <input id="c_logo" placeholder="https://.../logo.png" />
        </div>
        <div class="field">
          <label>Status</label>
          <select id="c_ativo">
            <option value="true">Ativo</option>
            <option value="false">Inativo</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>Email do cliente (opcional)</label>
          <input id="c_email" placeholder="cliente@dominio.com" />
        </div>
        <div class="field">
          <label>Senha do cliente (opcional)</label>
          <input id="c_senha" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn y" id="btnCriarCliente">‚ûï Criar cliente</button>
      </div>

      <div id="msg" class="msg" style="display:none"></div>
    </div>

    <div class="card">
      <h3 class="h">Cadastros</h3>
      <p class="sub">Selecione um cliente e cadastre categorias/produtos com seguran√ßa.</p>

      <div class="row">
        <div class="field">
          <label>Cliente selecionado</label>
          <select id="selCliente"></select>
        </div>
        <div class="field">
          <label>Categoria (para produto)</label>
          <select id="selCategoria"></select>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>Nova categoria</label>
          <input id="cat_nome" placeholder="Ex: Bebidas" />
        </div>
        <div class="field">
          <label>Ordem</label>
          <input id="cat_ordem" type="number" value="0" />
        </div>
      </div>

      <div class="row">
        <button class="btn y" id="btnCriarCategoria">üìÅ Criar categoria</button>
      </div>

      <hr style="border:none;border-top:1px solid rgba(255,255,255,.08);margin:14px 0">

      <div class="row">
        <div class="field">
          <label>Produto</label>
          <input id="p_nome" placeholder="Ex: P√£o de queijo" />
        </div>
        <div class="field">
          <label>Pre√ßo</label>
          <input id="p_preco" type="number" step="0.01" value="0" />
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>Descri√ß√£o</label>
          <input id="p_desc" placeholder="opcional..." />
        </div>
        <div class="field">
          <label>Imagem URL (opcional)</label>
          <input id="p_img" placeholder="https://.../foto.jpg" />
        </div>
      </div>

      <div class="row">
        <button class="btn y" id="btnCriarProduto">üßæ Criar produto</button>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:14px">
    <div class="toolbar">
      <div>
        <h3 class="h" id="listTitle">Clientes</h3>
        <p class="sub" id="listSub">Grid 4 colunas</p>
      </div>
      <input id="search" placeholder="Buscar..." />
    </div>

    <div class="grid4" id="list"></div>
  </div>

</div>

<!-- LOGIN -->
<div id="login">
  <div class="loginWrap">
    <div class="loginHeroLogo">
      <img src="../logo.png" alt="Logo"
           onerror="this.style.display='none';document.getElementById('loginHeroFallback').style.display='block';" />
      <div id="loginHeroFallback" style="display:none;font-weight:900;font-size:28px;letter-spacing:.5px;">Admin Alfa</div>
    </div>

    <div class="loginCard">
      <h2>Entrar</h2>
      <p>Email/senha do Supabase Auth ou Google.</p>

      <div class="loginForm">
        <label>Email</label>
        <input id="email" placeholder="seu@email.com" />
        <div class="sp10"></div>
        <label>Senha</label>
        <input id="senha" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      </div>

      <div class="row loginActions">
        <button class="btn y" id="btnLogin">üîí Entrar</button>
        <button class="btn gIcon" id="btnGoogle" title="Entrar com Google" aria-label="Entrar com Google">
          <span class="gMark">G</span>
        </button>
      </div>

      <div id="loginMsg" class="msg err" style="display:none;margin-top:12px"></div>
    </div>
  </div>
</div>

<!-- MODAL EDITAR CLIENTE -->
<div class="modalBack" id="modalBack" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modalHead">
      <div>
        <div class="modalTitle" id="mTitle">Editar cliente</div>
        <div class="modalSub" id="mSub">Atualize os dados do neg√≥cio.</div>
      </div>
      <button class="xbtn" id="btnCloseModal" title="Fechar">‚úï</button>
    </div>

    <div class="modalBody">
      <div class="hint">
        üîí <strong>Senha n√£o √© vis√≠vel</strong> (nem pro Admin). Use <strong>Enviar link de redefini√ß√£o</strong> pro cliente trocar a senha.
      </div>

      <div class="formGrid">
        <div class="field span2">
          <label>Slug (n√£o edita)</label>
          <input id="m_slug" disabled />
        </div>

        <div class="field">
          <label>Nome</label>
          <input id="m_nome" />
        </div>

        <div class="field">
          <label>WhatsApp</label>
          <input id="m_whatsapp" placeholder="6299..." />
        </div>

        <div class="field">
          <label>Email (login)</label>
          <input id="m_email" placeholder="cliente@email.com" />
        </div>

        <div class="field">
          <label>Instagram</label>
          <input id="m_instagram" placeholder="sem @" />
        </div>

        <div class="field">
          <label>Cidade</label>
          <input id="m_cidade" placeholder="Ex: Cavalcante" />
        </div>

        <div class="field">
          <label>Tipo de neg√≥cio</label>
          <input id="m_tipo_negocio" placeholder="Ex: mercado, pousada..." />
        </div>

        <div class="field span2">
          <label>Endere√ßo</label>
          <input id="m_endereco" placeholder="Rua, n√∫mero, bairro..." />
        </div>

        <div class="field span2">
          <label>Logo URL (opcional)</label>
          <input id="m_logo_url" placeholder="https://.../logo.png" />
        </div>

        <div class="field span2">
          <div class="previewRow">
            <div class="prevImg"><img id="m_logo_prev" alt="preview" style="display:none"/></div>
            <div style="min-width:220px">
              <div class="ttl" style="font-size:13px;margin-bottom:2px">Preview</div>
              <div class="meta" id="m_logo_text">Sem logo</div>
            </div>

            <div class="row" style="margin-left:auto">
              <label style="display:flex;align-items:center;gap:8px;margin:0;color:var(--text)">
                <input type="checkbox" id="m_ativo" style="width:18px;height:18px"/>
                Ativo (publicado)
              </label>
              <button class="btn y small" id="btnLinkSenha">üîë Enviar link</button>
            </div>
          </div>
        </div>
      </div>

      <div id="modalMsg" class="msg err" style="display:none;margin-top:12px"></div>
    </div>

    <div class="modalFoot">
      <button class="btn" id="btnCancelModal">Cancelar</button>
      <button class="btn y" id="btnSaveModal">Salvar</button>
    </div>
  </div>
</div>

<script>
  // ====== CONFIG ======
  const SUPABASE_URL = "https://rgsnmxspyywwouhcdwkj.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_nHPsCV3y79FgexEMAeANWQ_P6jWRDd1";
  const API_BASE = "https://cafeteria-gamma-orpin.vercel.app/api/admin";
  const ALFA_EMAIL = "playmomentsstudios@gmail.com";

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ====== STATE ======
  let session = null;
  let tab = "clientes";
  let clientes = [];
  let categorias = [];
  let produtos = [];
  let editingSlug = null;

  // ====== UI HELPERS ======
  const el = (id)=>document.getElementById(id);
  const show = (id)=>el(id).style.display="block";
  const hide = (id)=>el(id).style.display="none";

  function escapeHtml(str){
    return String(str ?? "").replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function msg(text, type=""){
    const box = el("msg");
    box.style.display = "block";
    box.className = "msg " + (type||"");
    box.textContent = text;
    setTimeout(()=>{ box.style.display="none"; }, 4500);
  }

  function loginMsg(text){
    const box = el("loginMsg");
    box.style.display = "block";
    box.textContent = text;
  }

  function modalMsg(text){
    const box = el("modalMsg");
    if(!text){
      box.style.display="none";
      box.textContent="";
      return;
    }
    box.style.display="block";
    box.textContent=text;
  }

  function slugify(s){
    return String(s||"")
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/[^a-z0-9]+/g, "-")
      .replace(/(^-|-$)+/g, "");
  }

  function money(v){
    return Number(v||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
  }

  function openMenu(id){
    document.querySelectorAll(".menu").forEach(m=>m.style.display="none");
    const m = document.getElementById(id);
    if (m) m.style.display = "block";
  }
  window.addEventListener("click", (e)=>{
    if (!e.target.closest(".menuWrap")) document.querySelectorAll(".menu").forEach(m=>m.style.display="none");
  });

  // ====== AUTH HELPERS ======
  function isAlfa(){
    const email = session?.user?.email || "";
    return String(email).toLowerCase().trim() === ALFA_EMAIL.toLowerCase();
  }

  async function requireAlfa(){
    if(!session) return false;
    if(isAlfa()) return true;
    try{ await sb.auth.signOut(); }catch(_e){}
    session = null;
    el("app").style.display="none";
    show("login");
    loginMsg("Acesso negado: este painel √© apenas para o Admin Alfa.");
    return false;
  }

  // ====== API CALL (Vercel) ======
  async function api(path, method="GET", body=null){
    const token = session?.access_token;
    const headers = {
      "Content-Type":"application/json",
      "Authorization": "Bearer " + token
    };
    const opts = { method, headers };
    if (body) opts.body = JSON.stringify(body);

    const r = await fetch(API_BASE + path, opts);
    const j = await r.json().catch(()=> ({}));
    if (!r.ok) throw new Error(j.error || ("HTTP " + r.status));
    return j;
  }

  // ====== LOAD (API) ======
  async function loadAllApi(){
    const [c1,c2,c3] = await Promise.all([
      api("/clientes","GET"),
      api("/categorias","GET"),
      api("/produtos","GET")
    ]);
    clientes = c1.data || [];
    categorias = c2.data || [];
    produtos = c3.data || [];

    fillClienteSelect();
    fillCategoriaSelect();
  }

  function fillClienteSelect(){
    const s = el("selCliente");
    s.innerHTML = clientes
      .map(c=>`<option value="${escapeHtml(c.slug)}">${escapeHtml(c.nome)} (${escapeHtml(c.slug)})</option>`)
      .join("");
  }

  function fillCategoriaSelect(){
    const cliente_slug = el("selCliente").value;
    const s = el("selCategoria");
    const cats = categorias.filter(x=>x.cliente_slug===cliente_slug);
    s.innerHTML = cats.map(c=>`<option value="${c.id}">${escapeHtml(c.nome)}</option>`).join("");
  }

  el("selCliente").addEventListener("change", ()=>{
    fillCategoriaSelect();
    if (tab !== "clientes") renderList();
  });

  // ====== TABS ======
  document.querySelectorAll(".tab").forEach(b=>{
    b.addEventListener("click", async ()=>{
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      tab = b.dataset.tab;
      await renderList();
    });
  });

  el("search").addEventListener("input", ()=>renderList());

  // ====== RENDER LIST ======
  async function renderList(){
    const q = (el("search").value||"").trim().toLowerCase();
    const listEl = el("list");

    if (tab==="clientes"){
      el("listTitle").textContent = "Clientes";
      el("listSub").textContent = "A√ß√µes: ver publicado, editar, enviar link de senha, ativar/desativar, excluir.";

      let list = clientes.slice();
      if (q) list = list.filter(x=>
        (x.nome||"").toLowerCase().includes(q) ||
        (x.slug||"").toLowerCase().includes(q) ||
        (x.email||"").toLowerCase().includes(q)
      );

      listEl.innerHTML = list.map(c=>{
        const mid = "m_cli_"+c.slug;
        return `
          <div class="item">
            <div class="itemTop">
              <div>
                <div class="ttl">${escapeHtml(c.nome||"‚Äî")}</div>
                <div class="meta">${escapeHtml(c.slug||"")}</div>
                <div class="meta">Email: ${escapeHtml(c.email||"‚Äî")}</div>
              </div>

              <div class="menuWrap">
                <div class="kebab" onclick="openMenu('${mid}')">‚ãØ</div>
                <div class="menu" id="${mid}">
                  <button onclick="verPublicado('${c.slug}')">üåê Ver publicado</button>
                  <button onclick="openEditModal('${c.slug}')">‚úèÔ∏è Editar</button>
                  <button onclick="enviarReset('${escapeHtml(c.email||"")}')">üîë Enviar link de senha</button>
                  <button onclick="toggleCliente('${c.slug}', ${!c.ativo})">${c.ativo ? "‚õî Desativar" : "‚úÖ Ativar"}</button>
                  <button class="danger" onclick="delCliente('${c.slug}')">üóë Excluir</button>
                </div>
              </div>
            </div>

            <div class="row" style="justify-content:space-between;align-items:center">
              <span class="pill ${c.ativo ? "ok":"off"}">${c.ativo ? "Ativo":"Inativo"}</span>
              <span class="meta">${escapeHtml(c.tipo_negocio||"")}</span>
            </div>
            <div class="meta">Whats: ${escapeHtml(c.whatsapp||"‚Äî")}</div>
          </div>
        `;
      }).join("");
      return;
    }

    const cliente_slug = el("selCliente").value;

    if (tab==="categorias"){
      el("listTitle").textContent = "Categorias";
      el("listSub").textContent = "Mostrando do cliente selecionado.";

      let list = categorias.filter(x=>x.cliente_slug===cliente_slug);
      if (q) list = list.filter(x=> (x.nome||"").toLowerCase().includes(q));

      listEl.innerHTML = list.map(c=>{
        const mid = "m_cat_"+c.id;
        return `
          <div class="item">
            <div class="itemTop">
              <div>
                <div class="ttl">${escapeHtml(c.nome||"‚Äî")}</div>
                <div class="meta">ordem: ${Number(c.ordem||0)}</div>
              </div>
              <div class="menuWrap">
                <div class="kebab" onclick="openMenu('${mid}')">‚ãØ</div>
                <div class="menu" id="${mid}">
                  <button onclick="toggleCategoria(${c.id}, ${!c.ativo})">${c.ativo ? "‚õî Desativar" : "‚úÖ Ativar"}</button>
                  <button class="danger" onclick="delCategoria(${c.id})">üóë Excluir</button>
                </div>
              </div>
            </div>
            <span class="pill ${c.ativo ? "ok":"off"}">${c.ativo ? "Ativo":"Inativo"}</span>
          </div>
        `;
      }).join("");
      return;
    }

    // produtos
    el("listTitle").textContent = "Produtos";
    el("listSub").textContent = "Mostrando do cliente selecionado.";

    let list = produtos.filter(x=>x.cliente_slug===cliente_slug);
    if (q) list = list.filter(x=> (x.nome||"").toLowerCase().includes(q));

    listEl.innerHTML = list.map(p=>{
      const mid = "m_prod_"+p.id;
      return `
        <div class="item">
          <div class="itemTop">
            <div>
              <div class="ttl">${escapeHtml(p.nome||"‚Äî")}</div>
              <div class="meta">${money(p.preco)}</div>
            </div>
            <div class="menuWrap">
              <div class="kebab" onclick="openMenu('${mid}')">‚ãØ</div>
              <div class="menu" id="${mid}">
                <button onclick="toggleProduto(${p.id}, ${!p.ativo})">${p.ativo ? "‚õî Desativar" : "‚úÖ Ativar"}</button>
                <button class="danger" onclick="delProduto(${p.id})">üóë Excluir</button>
              </div>
            </div>
          </div>
          <span class="pill ${p.ativo ? "ok":"off"}">${p.ativo ? "Ativo":"Inativo"}</span>
          <div class="meta">${escapeHtml(p.descricao||"")}</div>
        </div>
      `;
    }).join("");
  }

  // ====== ACTIONS (API) ======
  window.verPublicado = function(slug){
    window.open("../?u=" + encodeURIComponent(slug), "_blank");
  }

  window.toggleCliente = async function(slug, ativo){
    try{
      await api("/clientes","PUT",{ slug, ativo });
      await bootLoad();
      msg("Cliente atualizado ‚úÖ","ok");
    }catch(e){
      msg("Erro ao atualizar cliente: " + e.message, "err");
    }
  }

  window.delCliente = async function(slug){
    if (!confirm("Excluir cliente e tudo dele?")) return;
    try{
      await api("/clientes?slug="+encodeURIComponent(slug),"DELETE");
      await bootLoad();
      msg("Cliente exclu√≠do ‚úÖ","ok");
    }catch(e){
      msg("Erro ao excluir cliente: " + e.message, "err");
    }
  }

  window.toggleCategoria = async function(id, ativo){
    try{
      await api("/categorias","PUT",{ id, ativo });
      await bootLoad();
      msg("Categoria atualizada ‚úÖ","ok");
    }catch(e){
      msg("Erro ao atualizar categoria: " + e.message, "err");
    }
  }

  window.delCategoria = async function(id){
    if (!confirm("Excluir categoria (e produtos dela)?")) return;
    try{
      await api("/categorias?id="+encodeURIComponent(id),"DELETE");
      await bootLoad();
      msg("Categoria exclu√≠da ‚úÖ","ok");
    }catch(e){
      msg("Erro ao excluir categoria: " + e.message, "err");
    }
  }

  window.toggleProduto = async function(id, ativo){
    try{
      await api("/produtos","PUT",{ id, ativo });
      await bootLoad();
      msg("Produto atualizado ‚úÖ","ok");
    }catch(e){
      msg("Erro ao atualizar produto: " + e.message, "err");
    }
  }

  window.delProduto = async function(id){
    if (!confirm("Excluir produto?")) return;
    try{
      await api("/produtos?id="+encodeURIComponent(id),"DELETE");
      await bootLoad();
      msg("Produto exclu√≠do ‚úÖ","ok");
    }catch(e){
      msg("Erro ao excluir produto: " + e.message, "err");
    }
  }

  // ====== CREATE (API) ======
  el("btnCriarCliente").addEventListener("click", async ()=>{
    try{
      const nome = el("c_nome").value.trim();
      const slug = el("c_slug").value.trim() || slugify(nome);
      const whatsapp = el("c_whats").value.trim();
      const tipo_negocio = el("c_tipo").value.trim();
      const logo_url = el("c_logo").value.trim();
      const ativo = el("c_ativo").value === "true";

      const email = el("c_email").value.trim();
      const senha = el("c_senha").value.trim();

      if(!nome) throw new Error("Preencha o nome.");
      if(!slug) throw new Error("Slug inv√°lido.");

      const payload = { nome, slug, whatsapp, tipo_negocio, logo_url, ativo };
      if (email && senha) { payload.email = email; payload.senha = senha; }

      const r = await api("/clientes","POST",payload);
      msg(r.warning ? r.warning : "Cliente criado ‚úÖ", r.warning ? "" : "ok");

      el("c_nome").value = "";
      el("c_slug").value = "";
      el("c_whats").value = "";
      el("c_tipo").value = "";
      el("c_logo").value = "";
      el("c_email").value = "";
      el("c_senha").value = "";

      await bootLoad();
    }catch(e){
      msg("Erro ao criar cliente: " + e.message, "err");
    }
  });

  el("btnCriarCategoria").addEventListener("click", async ()=>{
    try{
      const cliente_slug = el("selCliente").value;
      const nome = el("cat_nome").value.trim();
      const ordem = Number(el("cat_ordem").value||0);
      if(!cliente_slug) throw new Error("Selecione um cliente.");
      if(!nome) throw new Error("Digite o nome da categoria.");
      await api("/categorias","POST",{ cliente_slug, nome, ordem, ativo:true });
      msg("Categoria criada ‚úÖ","ok");
      el("cat_nome").value="";
      await bootLoad();
    }catch(e){
      msg("Erro ao criar categoria: " + e.message, "err");
    }
  });

  el("btnCriarProduto").addEventListener("click", async ()=>{
    try{
      const cliente_slug = el("selCliente").value;
      const categoria_id = el("selCategoria").value;
      const nome = el("p_nome").value.trim();
      const preco = Number(el("p_preco").value||0);
      const descricao = el("p_desc").value.trim();
      const imagem_url = el("p_img").value.trim();

      if(!cliente_slug) throw new Error("Selecione um cliente.");
      if(!categoria_id) throw new Error("Selecione uma categoria.");
      if(!nome) throw new Error("Digite o nome do produto.");

      await api("/produtos","POST",{ cliente_slug, categoria_id, nome, preco, descricao, imagem_url, ativo:true });
      msg("Produto criado ‚úÖ","ok");

      el("p_nome").value="";
      el("p_preco").value="0";
      el("p_desc").value="";
      el("p_img").value="";
      await bootLoad();
    }catch(e){
      msg("Erro ao criar produto: " + e.message, "err");
    }
  });

  // ====== MODAL EDITAR ======
  function openModal(){
    el("modalBack").style.display="flex";
    el("modalBack").setAttribute("aria-hidden","false");
  }
  function closeModal(){
    el("modalBack").style.display="none";
    el("modalBack").setAttribute("aria-hidden","true");
    editingSlug = null;
    modalMsg("");
  }

  function updateLogoPreview(){
    const url = (el("m_logo_url").value||"").trim();
    const img = el("m_logo_prev");
    const txt = el("m_logo_text");

    if(!url){
      img.style.display="none";
      txt.textContent="Sem logo";
      return;
    }
    img.style.display="block";
    img.src = url;
    txt.textContent = url;
    img.onerror = ()=>{
      img.style.display="none";
      txt.textContent="URL inv√°lida (n√£o carregou)";
    };
  }

  window.openEditModal = function(slug){
    const c = clientes.find(x=>x.slug===slug);
    if(!c) return msg("Cliente n√£o encontrado.", "err");

    editingSlug = slug;

    el("m_slug").value = c.slug || "";
    el("m_nome").value = c.nome || "";
    el("m_whatsapp").value = c.whatsapp || "";
    el("m_email").value = c.email || "";
    el("m_instagram").value = c.instagram || "";
    el("m_cidade").value = c.cidade || "";
    el("m_tipo_negocio").value = c.tipo_negocio || "";
    el("m_endereco").value = c.endereco || "";
    el("m_logo_url").value = c.logo_url || "";
    el("m_ativo").checked = !!c.ativo;

    el("mTitle").textContent = "Editar cliente";
    el("mSub").textContent = `${c.nome || "Cliente"} ‚Ä¢ ${c.slug}`;

    updateLogoPreview();
    openModal();
  }

  async function saveCliente(){
    if(!editingSlug) return;

    const payload = {
      slug: editingSlug,
      nome: el("m_nome").value.trim(),
      whatsapp: el("m_whatsapp").value.trim(),
      email: el("m_email").value.trim(),
      instagram: el("m_instagram").value.trim().replace(/^@+/, ""),
      cidade: el("m_cidade").value.trim(),
      tipo_negocio: el("m_tipo_negocio").value.trim(),
      endereco: el("m_endereco").value.trim(),
      logo_url: el("m_logo_url").value.trim(),
      ativo: el("m_ativo").checked
    };

    if(!payload.nome) return modalMsg("Preencha o nome.");

    try{
      modalMsg("");
      el("btnSaveModal").disabled = true;

      // Atualiza no backend (Service Role do seu Vercel)
      await api("/clientes","PUT", payload);

      msg("Cliente atualizado ‚úÖ","ok");
      await bootLoad();
      closeModal();
    }catch(e){
      modalMsg("Erro ao salvar: " + (e?.message || e));
    }finally{
      el("btnSaveModal").disabled = false;
    }
  }

  // ====== RESET SENHA (sem backend): envia email de redefini√ß√£o ======
  window.enviarReset = async function(email){
    const alvo = (email||"").trim() || prompt("Email do cliente:", "");
    if(!alvo) return;

    try{
      // P√°gina que vai abrir depois do link do email:
      // /cafeteria/reset.html
      const redirectTo = new URL("../reset.html", window.location.href).href;

      const { error } = await sb.auth.resetPasswordForEmail(alvo, { redirectTo });
      if(error) throw error;

      alert("‚úÖ Link de redefini√ß√£o enviado por e-mail para:\n\n" + alvo + "\n\n(Verifique caixa de entrada/spam)");
    }catch(e){
      alert("‚ùå Falha ao enviar link de senha: " + (e?.message || e));
    }
  }

  // binds modal
  el("btnCloseModal").addEventListener("click", closeModal);
  el("btnCancelModal").addEventListener("click", closeModal);
  el("btnSaveModal").addEventListener("click", saveCliente);
  el("btnLinkSenha").addEventListener("click", ()=>{
    const email = el("m_email").value.trim();
    if(!email) return modalMsg("Preencha o email para enviar o link.");
    enviarReset(email);
  });
  el("m_logo_url").addEventListener("input", updateLogoPreview);

  el("modalBack").addEventListener("click", (e)=>{
    if(e.target === el("modalBack")) closeModal();
  });
  window.addEventListener("keydown", (e)=>{
    if(e.key==="Escape" && el("modalBack").style.display==="flex") closeModal();
  });

  // ====== BOOT ======
  async function bootLoad(){
    await loadAllApi();
    fillCategoriaSelect();
    await renderList();
  }

  // ====== LOGIN ======
  el("btnLogin").addEventListener("click", async ()=>{
    try{
      el("loginMsg").style.display="none";
      const email = el("email").value.trim();
      const password = el("senha").value.trim();

      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      if (error) throw error;

      session = data.session;
      const ok = await requireAlfa();
      if(!ok) return;

      await afterLogin();
    }catch(e){
      loginMsg(e.message || "Falha no login");
    }
  });

  el("btnGoogle").addEventListener("click", async ()=>{
    try{
      await sb.auth.signInWithOAuth({
        provider:"google",
        options:{ redirectTo: window.location.href }
      });
    }catch(e){
      loginMsg(e.message || "Falha no Google");
    }
  });

  async function afterLogin(){
    hide("login");
    el("app").style.display="block";
    await bootLoad();
  }

  el("btnSair").addEventListener("click", async ()=>{
    await sb.auth.signOut();
    session = null;
    el("app").style.display="none";
    show("login");
  });

  el("btnReload").addEventListener("click", bootLoad);

  // init
  (async ()=>{
    const { data } = await sb.auth.getSession();
    session = data.session || null;

    if (session){
      const ok = await requireAlfa();
      if(ok) await afterLogin();
      else show("login");
    }else{
      show("login");
    }

    sb.auth.onAuthStateChange(async (_event, s)=>{
      session = s;
      if(session){
        const ok = await requireAlfa();
        if(ok) await afterLogin();
      }
    });
  })();
</script>

</body>
</html>
