<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin ‚Äî Card√°pio Digital</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg0:#07121f; --bg1:#091a2b;
      --text:#e7eefc; --muted:rgba(231,238,252,.72);
      --card:rgba(255,255,255,.06); --line:rgba(255,255,255,.10);
      --primary:#2b69ff; --primary2:#1a4fd6;
      --accent:#2ee6c5; --danger:#ff5a67;
      --r:20px; --shadow:0 18px 60px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(43,105,255,.35), transparent 55%),
        radial-gradient(900px 700px at 80% 15%, rgba(46,230,197,.18), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      padding: 22px 14px 60px;
    }
    .wrap{max-width:1100px;margin:0 auto}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.075), rgba(255,255,255,.035));
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding:18px;
    }
    .btn{
      cursor:pointer; border:none; color:var(--text);
      padding:11px 14px; border-radius:14px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      font-weight:900; display:inline-flex; gap:10px; align-items:center;
    }
    .btn.primary{background:linear-gradient(135deg,var(--primary),var(--primary2))}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.14);box-shadow:none}
    .btn.danger{background:linear-gradient(135deg, rgba(255,90,103,.95), rgba(255,90,103,.70))}
    input,select,textarea{
      width:100%; padding:12px 12px; border-radius:14px;
      background:rgba(0,0,0,.22); border:1px solid rgba(255,255,255,.14);
      color:var(--text); outline:none;
    }
    label{display:block;font-size:12.5px;font-weight:900;color:rgba(231,238,252,.80);margin:2px 0 6px}
    .row{display:grid; grid-template-columns: repeat(12, 1fr); gap:12px}
    .col12{grid-column:span 12} .col6{grid-column:span 6}
    .muted{color:var(--muted); font-size:13px}
    .top{
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      padding:18px 18px; border-radius: var(--r);
      background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
    }
    .brand{display:flex; gap:12px; align-items:center}
    .logo{
      width:54px; height:54px; border-radius:18px;
      background: linear-gradient(135deg, rgba(43,105,255,.25), rgba(46,230,197,.15));
      border:1px dashed rgba(255,255,255,.25);
      display:flex; align-items:center; justify-content:center;
      font-weight:900; letter-spacing:.6px;
    }
    .tabs{
      display:flex; gap:10px; justify-content:center; margin:12px 0 0;
      padding:8px; border-radius:999px;
      background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.10);
    }
    .tab{
      cursor:pointer; padding:10px 14px; border-radius:999px;
      border:1px solid transparent; background:transparent;
      color:rgba(231,238,252,.85); font-weight:900; min-width:150px;
    }
    .tab.active{background:rgba(43,105,255,.18); border-color:rgba(43,105,255,.35); color:var(--text)}
    .table{margin-top:12px;border-radius:18px;overflow:hidden;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04)}
    .thead,.trow{display:grid; grid-template-columns: 1.8fr 1.1fr .7fr 56px; gap:10px; padding:12px 14px; align-items:center}
    .thead{background:rgba(255,255,255,.06); border-bottom:1px solid rgba(255,255,255,.10); font-size:12px; font-weight:900; color:rgba(231,238,252,.72); text-transform:uppercase}
    .trow{border-bottom:1px solid rgba(255,255,255,.08)} .trow:last-child{border-bottom:none}
    .chip{display:inline-flex; gap:8px; align-items:center; padding:8px 10px; border-radius:999px; font-weight:900; font-size:12px; border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.06)}
    .dot{width:8px;height:8px;border-radius:99px;background:rgba(255,255,255,.35)}
    .chip.ok{background:rgba(46,230,197,.14); border-color:rgba(46,230,197,.30)} .chip.ok .dot{background:var(--accent)}
    .chip.off{background:rgba(255,90,103,.12); border-color:rgba(255,90,103,.22)} .chip.off .dot{background:var(--danger)}
    .kebab{
      width:44px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;
      background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);cursor:pointer;position:relative;user-select:none;justify-self:end
    }
    .menu{
      position:absolute; right:0; top:46px; min-width:190px; padding:8px; border-radius:16px;
      background:rgba(10,22,36,.92); border:1px solid rgba(255,255,255,.14); box-shadow:0 18px 60px rgba(0,0,0,.55);
      display:none; z-index:50;
    }
    .menu.open{display:block}
    .mitem{
      width:100%; display:flex; gap:10px; align-items:center; padding:10px 10px; border-radius:12px;
      background:transparent; border:1px solid transparent; color:rgba(231,238,252,.92); cursor:pointer; font-weight:900; text-align:left
    }
    .mitem:hover{background:rgba(255,255,255,.06); border-color:rgba(255,255,255,.10)}
    .mitem.danger{color:rgba(255,90,103,.95)}
    .toast{margin-top:12px;padding:12px 14px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.05);display:none}
    .toast.show{display:block}
    .toast.err{border-color:rgba(255,90,103,.22);background:rgba(255,90,103,.10)}
    .toast.ok{border-color:rgba(46,230,197,.28);background:rgba(46,230,197,.10)}
    .hidden{display:none!important}
    @media (max-width:640px){ .thead{display:none} .trow{grid-template-columns:1fr; gap:8px} }
  </style>
</head>

<body>
<div class="wrap">

  <div class="top">
    <div class="brand">
      <div class="logo">ADM</div>
      <div>
        <div style="font-weight:900">Admin Alfa</div>
        <div class="muted" id="sub">Login para gerenciar clientes, categorias e produtos.</div>
      </div>
    </div>
    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
      <div class="muted" id="userEmail">‚Äî</div>
      <button class="btn danger" id="btnLogout" disabled>üö™ Sair</button>
    </div>
  </div>

  <!-- LOGIN (clean) -->
  <div class="card" id="loginCard" style="margin-top:14px">
    <div class="row">
      <div class="col12">
        <div style="font-size:18px;font-weight:900;margin-bottom:4px">Entrar</div>
        <div class="muted">Email/senha ou Google (Supabase Auth).</div>
      </div>
      <div class="col12">
        <label>Email</label>
        <input id="email" autocomplete="email" placeholder="admin@email.com" />
      </div>
      <div class="col12">
        <label>Senha</label>
        <input id="senha" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      </div>
      <div class="col12" style="display:flex; gap:10px; flex-wrap:wrap">
        <button class="btn primary" id="btnLogin">üîê Acessar</button>
        <button class="btn ghost" id="btnGoogle">üü¶ Entrar com Google</button>
      </div>
      <div class="col12">
        <div class="toast" id="toast"></div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="app" class="hidden">
    <div class="card" style="margin-top:14px">
      <div class="tabs">
        <button class="tab active" data-tab="clientes">üè™ Clientes</button>
        <button class="tab" data-tab="categorias">üóÇÔ∏è Categorias</button>
        <button class="tab" data-tab="produtos">üßæ Produtos</button>
      </div>

      <div class="row" style="margin-top:12px">
        <div class="col6">
          <label>Busca</label>
          <input id="search" placeholder="Buscar..." />
        </div>
        <div class="col6" style="display:flex; gap:10px; align-items:flex-end; justify-content:flex-end">
          <button class="btn" id="btnReload">üîÑ Recarregar</button>
        </div>
      </div>
    </div>

    <div class="grid" style="display:grid;grid-template-columns:1.05fr .95fr;gap:14px;margin-top:14px">
      <!-- FORM -->
      <div class="card">
        <div style="font-size:18px;font-weight:900" id="formTitle">Cadastrar Cliente</div>
        <div class="muted" id="formSub">Crie cliente + acesso (email/senha) do dono.</div>

        <!-- Clientes -->
        <div id="formClientes" style="margin-top:10px">
          <div class="row">
            <div class="col12">
              <label>Nome</label>
              <input id="cli_nome" placeholder="ex: Cuscuz da Baiana" />
            </div>
            <div class="col6">
              <label>Slug</label>
              <input id="cli_slug" placeholder="ex: cuscuz-da-baiana" />
            </div>
            <div class="col6">
              <label>WhatsApp</label>
              <input id="cli_whatsapp" placeholder="5562..." />
            </div>
            <div class="col12">
              <label>Logo (URL)</label>
              <input id="cli_logo_url" placeholder="https://..." />
            </div>
            <div class="col6">
              <label>Status</label>
              <select id="cli_ativo">
                <option value="true">Ativo</option>
                <option value="false">Inativo</option>
              </select>
            </div>

            <div class="col12" style="height:1px;background:rgba(255,255,255,.10);margin:6px 0"></div>

            <div class="col12">
              <label>Email do dono (login)</label>
              <input id="cli_email" autocomplete="email" placeholder="cliente@email.com" />
            </div>
            <div class="col12">
              <label>Senha do dono</label>
              <input id="cli_senha" type="password" autocomplete="new-password" placeholder="Crie uma senha" />
            </div>

            <div class="col12" style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn" id="btnClear">üßπ Limpar</button>
              <button class="btn accent" id="btnSave">üíæ Salvar</button>
            </div>
          </div>
        </div>

        <!-- Categorias -->
        <div id="formCategorias" class="hidden" style="margin-top:10px">
          <div class="row">
            <div class="col12">
              <label>Cliente (slug)</label>
              <select id="cat_cliente_slug"></select>
            </div>
            <div class="col12">
              <label>Nome</label>
              <input id="cat_nome" placeholder="ex: Bebidas" />
            </div>
            <div class="col6">
              <label>Ordem</label>
              <input id="cat_ordem" type="number" placeholder="1" />
            </div>
            <div class="col6">
              <label>Status</label>
              <select id="cat_ativo">
                <option value="true">Ativa</option>
                <option value="false">Inativa</option>
              </select>
            </div>
            <div class="col12"><button class="btn accent" id="btnSaveCat">üíæ Salvar</button></div>
          </div>
        </div>

        <!-- Produtos -->
        <div id="formProdutos" class="hidden" style="margin-top:10px">
          <div class="row">
            <div class="col12">
              <label>Cliente (slug)</label>
              <select id="p_cliente_slug"></select>
            </div>
            <div class="col12">
              <label>Categoria</label>
              <select id="p_categoria"></select>
            </div>
            <div class="col12">
              <label>Nome</label>
              <input id="p_nome" placeholder="ex: Caf√© coado" />
            </div>
            <div class="col12">
              <label>Descri√ß√£o</label>
              <textarea id="p_desc" placeholder="opcional"></textarea>
            </div>
            <div class="col6">
              <label>Pre√ßo</label>
              <input id="p_preco" type="number" step="0.01" placeholder="9.90" />
            </div>
            <div class="col6">
              <label>Status</label>
              <select id="p_ativo">
                <option value="true">Ativo</option>
                <option value="false">Inativo</option>
              </select>
            </div>
            <div class="col12">
              <label>Imagem (URL) ‚Äî coluna: imagem</label>
              <input id="p_img" placeholder="https://..." />
            </div>
            <div class="col6">
              <label>Ordem</label>
              <input id="p_ordem" type="number" placeholder="1" />
            </div>
            <div class="col12"><button class="btn accent" id="btnSaveProd">üíæ Salvar</button></div>
          </div>
        </div>

        <div class="toast" id="toast2"></div>
      </div>

      <!-- LIST -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:end;gap:10px">
          <div>
            <div style="font-size:18px;font-weight:900" id="listTitle">Clientes</div>
            <div class="muted" id="listSub">Menu ‚ãØ com a√ß√µes.</div>
          </div>
        </div>

        <div class="table">
          <div class="thead" id="thead">
            <div>Nome</div><div>Slug/Ref</div><div>Status</div><div style="text-align:right">‚ãØ</div>
          </div>
          <div id="tbody"></div>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
/* ========= CONFIG ========= */
const SUPABASE_URL = "https://rgsnmxspyywwouhcdwkj.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_nHPsCV3y79FgexEMAeANWQ_P6jWRDd1";

/** üîß Troque para sua URL do Vercel */
const API_BASE = "https://SEU-PROJETO.vercel.app";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let session=null, user=null;
let tab="clientes";
let editing={ clientes:null, categorias:null, produtos:null };
let clientes=[], categorias=[], produtos=[];

const el = (id)=>document.getElementById(id);
const toast = (msg, type="ok", which=1)=>{
  const t = which===1 ? el("toast") : el("toast2");
  t.className = "toast show " + (type==="err" ? "err":"ok");
  t.textContent = msg;
  setTimeout(()=> t.className="toast", 3200);
};
function esc(s){return String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]))}

function closeAllMenus(){ document.querySelectorAll(".menu.open").forEach(m=>m.classList.remove("open")); }
document.addEventListener("click",(e)=>{ if(!e.target.closest(".menu") && !e.target.closest(".kebab")) closeAllMenus(); });

async function apiFetch(path, {method="GET", body=null}={}){
  if(!session?.access_token) throw new Error("Fa√ßa login.");
  const res = await fetch(`${API_BASE}${path}`,{
    method,
    headers:{
      "Content-Type":"application/json",
      "Authorization": `Bearer ${session.access_token}`   // ‚úÖ token do admin logado
    },
    body: body ? JSON.stringify(body) : null
  });
  const json = await res.json().catch(()=> ({}));
  if(!res.ok) throw new Error(json.error || `Erro ${res.status}`);
  return json;
}

/* ========= AUTH ========= */
async function refreshAuth(){
  const { data } = await sb.auth.getSession();
  session = data.session || null;
  user = session?.user || null;

  el("userEmail").textContent = user?.email || "‚Äî";
  el("btnLogout").disabled = !session;

  el("loginCard").classList.toggle("hidden", !!session);
  el("app").classList.toggle("hidden", !session);

  if(session){
    await loadAll();
  }
}

async function loginPass(){
  const email = el("email").value.trim();
  const password = el("senha").value;
  if(!email || !password) return toast("Preencha email e senha.", "err");
  const { error } = await sb.auth.signInWithPassword({ email, password });
  if(error) return toast(error.message, "err");
  toast("Login ok!");
  await refreshAuth();
}

async function loginGoogle(){
  const redirectTo = window.location.origin + window.location.pathname;
  const { error } = await sb.auth.signInWithOAuth({ provider:"google", options:{ redirectTo }});
  if(error) toast(error.message, "err");
}

async function logout(){
  await sb.auth.signOut();
  await refreshAuth();
}

/* ========= TABS ========= */
function setTab(next){
  tab=next;
  document.querySelectorAll(".tab").forEach(b=>b.classList.toggle("active", b.dataset.tab===tab));

  el("formClientes").classList.toggle("hidden", tab!=="clientes");
  el("formCategorias").classList.toggle("hidden", tab!=="categorias");
  el("formProdutos").classList.toggle("hidden", tab!=="produtos");

  if(tab==="clientes"){
    el("formTitle").textContent="Cadastrar Cliente";
    el("formSub").textContent="Crie cliente + acesso (email/senha) do dono.";
    el("listTitle").textContent="Clientes";
    el("listSub").textContent="Menu ‚ãØ com a√ß√µes.";
    el("thead").innerHTML=`<div>Nome</div><div>Slug/Ref</div><div>Status</div><div style="text-align:right">‚ãØ</div>`;
  }else if(tab==="categorias"){
    el("formTitle").textContent="Cadastrar Categoria";
    el("formSub").textContent="Categorias por cliente.";
    el("listTitle").textContent="Categorias";
    el("listSub").textContent="Menu ‚ãØ com a√ß√µes.";
    el("thead").innerHTML=`<div>Nome</div><div>Cliente/Ordem</div><div>Status</div><div style="text-align:right">‚ãØ</div>`;
  }else{
    el("formTitle").textContent="Cadastrar Produto";
    el("formSub").textContent="Produtos por cliente e categoria.";
    el("listTitle").textContent="Produtos";
    el("listSub").textContent="Menu ‚ãØ com a√ß√µes.";
    el("thead").innerHTML=`<div>Nome</div><div>Cliente/Pre√ßo</div><div>Status</div><div style="text-align:right">‚ãØ</div>`;
  }
  render();
}

/* ========= LOAD ========= */
async function loadAll(){
  try{
    const [c1,c2,c3] = await Promise.all([
      apiFetch("/api/admin/clientes"),
      apiFetch("/api/admin/categorias"),
      apiFetch("/api/admin/produtos"),
    ]);
    clientes = c1.data || c1 || [];
    categorias = c2.data || c2 || [];
    produtos = c3.data || c3 || [];
    fillSelects();
    render();
    toast("Carregado.", "ok", 2);
  }catch(e){
    console.error(e);
    toast(e.message, "err", 2);
  }
}

function fillSelects(){
  const opts = `<option value="">Selecione...</option>` + clientes
    .slice().sort((a,b)=>String(a.nome||"").localeCompare(String(b.nome||"")))
    .map(c=>`<option value="${esc(c.slug)}">${esc(c.nome)} (${esc(c.slug)})</option>`).join("");

  el("cat_cliente_slug").innerHTML = opts;
  el("p_cliente_slug").innerHTML = opts;
  rebuildCategoriasSelect();
}
function rebuildCategoriasSelect(){
  const slug = el("p_cliente_slug").value || "";
  const list = categorias.filter(c=>String(c.cliente_slug)===String(slug))
    .slice().sort((a,b)=>Number(a.ordem||0)-Number(b.ordem||0));

  el("p_categoria").innerHTML = `<option value="">Selecione...</option>` +
    list.map(c=>`<option value="${c.id}">${esc(c.nome)} (#${c.id})</option>`).join("");
}

/* ========= CRUD ========= */
function clearForms(){
  ["cli_nome","cli_slug","cli_whatsapp","cli_logo_url","cli_email","cli_senha"].forEach(id=>el(id).value="");
  el("cli_ativo").value="true";
  ["cat_nome","cat_ordem"].forEach(id=>el(id).value="");
  el("cat_ativo").value="true"; el("cat_cliente_slug").value="";
  ["p_nome","p_desc","p_preco","p_img","p_ordem"].forEach(id=>el(id).value="");
  el("p_ativo").value="true"; el("p_cliente_slug").value=""; rebuildCategoriasSelect(); el("p_categoria").value="";
}

async function saveCliente(){
  try{
    const nome = el("cli_nome").value.trim();
    const slug = el("cli_slug").value.trim();
    const whatsapp = el("cli_whatsapp").value.trim();
    const logo_url = el("cli_logo_url").value.trim();
    const ativo = el("cli_ativo").value==="true";

    const email = el("cli_email").value.trim();
    const senha = el("cli_senha").value;

    if(!nome || !slug) throw new Error("Nome e slug obrigat√≥rios.");

    // cria cliente + acesso (endpoint que cria user+vinculo)
    if(email && senha){
      await apiFetch("/api/admin/criarClienteComAcesso", { method:"POST", body:{ nome, slug, whatsapp, logo_url, ativo, email, senha, role:"owner" }});
      toast("Cliente + acesso criado!", "ok", 2);
      clearForms();
      await loadAll();
      return;
    }

    // sem acesso, usa seu endpoint padr√£o
    await apiFetch("/api/admin/clientes", { method:"POST", body:{ action:"create", nome, slug, whatsapp, logo_url, ativo }});
    toast("Cliente criado!", "ok", 2);
    clearForms();
    await loadAll();
  }catch(e){
    console.error(e);
    toast(e.message, "err", 2);
  }
}

async function saveCategoria(){
  try{
    const cliente_slug = el("cat_cliente_slug").value;
    const nome = el("cat_nome").value.trim();
    const ordem = Number(el("cat_ordem").value||0);
    const ativo = el("cat_ativo").value==="true";
    if(!cliente_slug || !nome) throw new Error("Cliente e nome obrigat√≥rios.");

    await apiFetch("/api/admin/categorias", { method:"POST", body:{ action:"create", cliente_slug, nome, ordem, ativo }});
    toast("Categoria criada!", "ok", 2);
    clearForms();
    await loadAll();
  }catch(e){
    console.error(e);
    toast(e.message, "err", 2);
  }
}

async function saveProduto(){
  try{
    const cliente_slug = el("p_cliente_slug").value;
    const categoria_id = Number(el("p_categoria").value||0);
    const nome = el("p_nome").value.trim();
    const descricao = el("p_desc").value.trim();
    const preco = Number(el("p_preco").value||0);
    const imagem = el("p_img").value.trim();
    const ordem = Number(el("p_ordem").value||0);
    const ativo = el("p_ativo").value==="true";

    if(!cliente_slug || !categoria_id || !nome) throw new Error("Cliente, categoria e nome obrigat√≥rios.");

    await apiFetch("/api/admin/produtos", { method:"POST", body:{ action:"create", cliente_slug, categoria_id, nome, descricao, preco, imagem, ordem, ativo }});
    toast("Produto criado!", "ok", 2);
    clearForms();
    await loadAll();
  }catch(e){
    console.error(e);
    toast(e.message, "err", 2);
  }
}

/* ========= LIST ========= */
function chip(ativo, a="Ativo", i="Inativo"){
  return `<span class="chip ${ativo?"ok":"off"}"><span class="dot"></span>${ativo?a:i}</span>`;
}
function kebab(kind, item){
  const id=item.id;
  return `
    <div class="kebab" data-k="${kind}" data-id="${id}">
      <span>‚ãØ</span>
      <div class="menu" id="m-${kind}-${id}">
        <button class="mitem" data-act="toggle" data-k="${kind}" data-id="${id}">‚èª ${item.ativo?"Desativar":"Ativar"}</button>
        <button class="mitem danger" data-act="del" data-k="${kind}" data-id="${id}">üóëÔ∏è Excluir</button>
      </div>
    </div>
  `;
}
function bindMenus(){
  document.querySelectorAll(".kebab").forEach(k=>{
    k.onclick=(e)=>{
      e.stopPropagation();
      const kind=k.dataset.k, id=k.dataset.id;
      const m=document.getElementById(`m-${kind}-${id}`);
      const open=m.classList.contains("open");
      closeAllMenus(); if(!open) m.classList.add("open");
    };
  });
  document.querySelectorAll(".mitem").forEach(b=>{
    b.onclick= async (e)=>{
      e.stopPropagation(); closeAllMenus();
      const kind=b.dataset.k, act=b.dataset.act, id=b.dataset.id;
      await rowAction(kind, act, id);
    };
  });
}
async function rowAction(kind, act, id){
  try{
    const endpoint = kind==="clientes"?"/api/admin/clientes":(kind==="categorias"?"/api/admin/categorias":"/api/admin/produtos");
    if(act==="toggle"){
      const item = (kind==="clientes"?clientes:(kind==="categorias"?categorias:produtos)).find(x=>String(x.id)===String(id));
      await apiFetch(endpoint, { method:"POST", body:{ action:"toggle", id: item.id, ativo: !item.ativo }});
      await loadAll(); return;
    }
    if(act==="del"){
      if(!confirm("Excluir?")) return;
      await apiFetch(endpoint, { method:"POST", body:{ action:"delete", id }});
      await loadAll(); return;
    }
  }catch(e){
    console.error(e);
    toast(e.message, "err", 2);
  }
}

function render(){
  const q=(el("search").value||"").toLowerCase().trim();
  const tbody=el("tbody");

  let list = tab==="clientes"?clientes.slice():tab==="categorias"?categorias.slice():produtos.slice();
  if(q) list = list.filter(x=>JSON.stringify(x).toLowerCase().includes(q));

  if(!list.length){ tbody.innerHTML=`<div class="trow"><div class="muted">Sem itens.</div></div>`; return; }

  if(tab==="clientes"){
    tbody.innerHTML = list.sort((a,b)=>String(a.nome||"").localeCompare(String(b.nome||""))).map(x=>`
      <div class="trow">
        <div><b>${esc(x.nome)}</b><div class="muted">#${esc(x.id)}</div></div>
        <div class="muted">${esc(x.slug||"")}</div>
        <div>${chip(!!x.ativo,"Ativo","Inativo")}</div>
        ${kebab("clientes", x)}
      </div>
    `).join("");
  }else if(tab==="categorias"){
    tbody.innerHTML = list.map(x=>`
      <div class="trow">
        <div><b>${esc(x.nome)}</b><div class="muted">#${esc(x.id)}</div></div>
        <div class="muted">${esc(x.cliente_slug)} ‚Ä¢ ordem:${esc(x.ordem??0)}</div>
        <div>${chip(!!x.ativo,"Ativa","Inativa")}</div>
        ${kebab("categorias", x)}
      </div>
    `).join("");
  }else{
    tbody.innerHTML = list.map(x=>`
      <div class="trow">
        <div><b>${esc(x.nome)}</b><div class="muted">cat:${esc(x.categoria_id)} ‚Ä¢ #${esc(x.id)}</div></div>
        <div class="muted">${esc(x.cliente_slug)} ‚Ä¢ R$ ${esc(x.preco??0)}</div>
        <div>${chip(!!x.ativo,"Ativo","Inativo")}</div>
        ${kebab("produtos", x)}
      </div>
    `).join("");
  }
  bindMenus();
}

/* ========= EVENTS ========= */
document.querySelectorAll(".tab").forEach(b=>b.onclick=()=>setTab(b.dataset.tab));
el("btnLogin").onclick = loginPass;
el("btnGoogle").onclick = loginGoogle;
el("btnLogout").onclick = logout;
el("btnReload").onclick = loadAll;
el("search").oninput = render;

el("btnClear").onclick = clearForms;
el("btnSave").onclick = saveCliente;
el("btnSaveCat").onclick = saveCategoria;
el("btnSaveProd").onclick = saveProduto;
el("p_cliente_slug").onchange = rebuildCategoriasSelect;

sb.auth.onAuthStateChange(()=> refreshAuth());
(async function init(){ await refreshAuth(); setTab("clientes"); })();
</script>
</body>
</html>
