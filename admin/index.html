<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Alfa ‚Ä¢ Portal da Chapada</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#0a0f18;
      --card: rgba(0,0,0,.25);
      --bd: rgba(255,255,255,.10);
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --y:#f1c40f;
      --ok:#2ecc71;
      --bad:#e74c3c;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--txt);
      background: radial-gradient(1200px 600px at 10% 10%, rgba(241,196,15,.12), transparent 60%),
                  radial-gradient(900px 500px at 80% 30%, rgba(46,204,113,.08), transparent 55%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
      overflow-x:hidden;
    }

    /* ===== Layout ===== */
    .wrap{max-width:1180px;margin:0 auto;padding:22px}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding:14px 16px;border:1px solid var(--bd);border-radius:18px;background:rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .brand .logo{
      width:46px;height:46px;border-radius:14px;overflow:hidden;
      border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);
      display:flex;align-items:center;justify-content:center;
    }
    .brand .logo img{width:100%;height:100%;object-fit:cover}
    .brand h1{font-size:16px;margin:0;line-height:1.2}
    .brand p{margin:0;font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:520px}

    .row{display:flex;align-items:center;gap:10px}
    .btn{
      cursor:pointer;border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--txt);
      padding:10px 12px;border-radius:12px;
      font-weight:650;font-size:13px;
      display:inline-flex;align-items:center;gap:8px;
    }
    .btn:hover{background:rgba(255,255,255,.09)}
    .btn.y{background:rgba(241,196,15,.95);color:#101010;border-color:rgba(241,196,15,.55)}
    .btn.y:hover{background:rgba(241,196,15,1)}
    .btn.small{padding:8px 10px;font-size:12px;border-radius:10px}

    .tabs{
      display:flex;gap:8px;flex-wrap:wrap;margin:14px 0 0;
    }
    .tab{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--txt);
      padding:8px 12px;border-radius:999px;
      font-weight:750;font-size:12px;
    }
    .tab.active{
      background:rgba(241,196,15,.18);
      border-color:rgba(241,196,15,.45);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr 1fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      border:1px solid var(--bd);
      border-radius:18px;
      background:rgba(0,0,0,.22);
      padding:14px 14px 12px;
      backdrop-filter: blur(10px);
      min-width:0;
    }
    .card h3{margin:0 0 10px;font-size:14px}
    .card p{margin:0 0 12px;color:var(--muted);font-size:12px}

    .field{display:flex;flex-direction:column;gap:6px;min-width:0}
    .field label{font-size:12px;color:var(--muted)}
    input, select, textarea{
      width:100%;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      border-radius:12px;
      padding:10px 12px;
      color:var(--txt);
      outline:none;
      font-size:13px;
    }
    textarea{min-height:70px;resize:vertical}

    .listWrap{
      margin-top:14px;
      border:1px solid var(--bd);
      border-radius:18px;
      background:rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
      padding:14px;
    }
    .listTop{
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
      margin-bottom:10px;
    }
    .ttl{font-weight:850;font-size:14px}
    .meta{color:var(--muted);font-size:12px}
    .link{color:var(--y);text-decoration:none}
    .link:hover{text-decoration:underline}

    .items{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:12px;
    }
    @media (max-width: 1100px){ .items{grid-template-columns: repeat(3, 1fr)} }
    @media (max-width: 820px){ .items{grid-template-columns: repeat(2, 1fr)} }
    @media (max-width: 520px){ .items{grid-template-columns: 1fr} }

    .item{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      border-radius:16px;
      padding:12px;
      min-width:0;
    }
    .itemTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .kebab{cursor:pointer;user-select:none;padding:2px 8px;border-radius:10px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18)}
    .kebab:hover{background:rgba(0,0,0,.26)}
    .menuWrap{position:relative}
    .menu{
      position:absolute;right:0;top:26px;
      display:none;
      min-width:170px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.78);
      border-radius:14px;
      padding:6px;
      z-index:50;
      backdrop-filter: blur(10px);
    }
    .menu button{
      width:100%;
      background:transparent;
      border:0;
      color:var(--txt);
      padding:10px 10px;
      text-align:left;
      border-radius:12px;
      cursor:pointer;
      font-weight:650;
      font-size:13px;
    }
    .menu button:hover{background:rgba(255,255,255,.08)}
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.15);
      font-size:12px;
      color:var(--txt);
    }
    .pill.ok{background:rgba(46,204,113,.18)}
    .pill.warn{background:rgba(241,196,15,.18)}
    .pill.bad{background:rgba(231,76,60,.18)}
    .empty{
      opacity:.75;
      padding:14px;
      border:1px dashed rgba(255,255,255,.12);
      border-radius:14px;
    }

    /* ===== Aprova√ß√£o ===== */
    .aprovTop{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:10px}
    .aprovList{display:flex;flex-direction:column;gap:10px}
    .aprovItem{
      display:flex;justify-content:space-between;gap:12px;align-items:flex-start;
      padding:12px;border:1px solid rgba(255,255,255,.08);border-radius:12px;background:rgba(0,0,0,.18)
    }

    /* ===== Login (central + logo grande) ===== */
    #login{min-height:100vh}
    .loginWrap{
      min-height:100vh;width:100%;
      display:flex;flex-direction:column;
      align-items:center;justify-content:center;
      gap:18px;padding:28px;
    }
    .loginHeroLogo img{
      width:180px;max-width:70vw;height:auto;display:block;
      filter:drop-shadow(0 10px 25px rgba(0,0,0,.35));
    }
    .loginCard{
      width:min(420px,92vw);
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:18px 18px 16px;
      backdrop-filter: blur(10px);
    }
    .loginCard h2{margin:0 0 6px}
    .loginCard p{margin:0 0 12px;color:var(--muted);font-size:12px}
    .loginForm{margin-top:10px;text-align:left}
    .sp10{height:10px}
    .loginActions{justify-content:center;margin-top:14px;gap:10px}
    .btn.gIcon{
      width:44px;min-width:44px;height:40px;padding:0;border-radius:12px;
      display:flex;align-items:center;justify-content:center
    }
    .gMark{font-weight:900;font-size:18px;line-height:1;letter-spacing:-1px}
    .msg{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.25);font-size:13px}
    .msg.err{border-color:rgba(231,76,60,.35)}
  </style>
</head>

<body>

<!-- LOGIN -->
<div id="login">
  <div class="loginWrap">
    <div class="loginHeroLogo">
      <img src="../logo.png" alt="Logo"
           onerror="this.style.display='none';document.getElementById('loginHeroFallback').style.display='block';" />
      <div id="loginHeroFallback" style="display:none;font-weight:800;font-size:28px;letter-spacing:.5px;">Admin Alfa</div>
    </div>

    <div class="loginCard">
      <h2>Entrar</h2>
      <p>Email/senha do Supabase Auth ou Google.</p>

      <div class="loginForm">
        <label>Email</label>
        <input id="email" placeholder="seu@email.com" />
        <div class="sp10"></div>
        <label>Senha</label>
        <input id="senha" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      </div>

      <div class="row loginActions">
        <button class="btn y" id="btnLogin">üîí Entrar</button>
        <button class="btn gIcon" id="btnGoogle" title="Entrar com Google" aria-label="Entrar com Google">
          <span class="gMark">G</span>
        </button>
      </div>

      <div id="loginMsg" class="msg err" style="display:none;margin-top:12px"></div>
    </div>
  </div>
</div>

<!-- APP -->
<div class="wrap" id="app" style="display:none">

  <div class="top">
    <div class="brand">
      <div class="logo">
        <img src="../logo.png" onerror="this.style.display='none';this.parentElement.textContent='ADM'">
      </div>
      <div style="min-width:0">
        <h1>Admin Alfa</h1>
        <p>Gerencie clientes, categorias e produtos.</p>
      </div>
    </div>

    <div class="row">
      <button class="btn" id="btnReload">üîÑ Recarregar</button>
      <button class="btn y" id="btnLogout">üö™ Sair</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="clientes">Clientes</button>
    <button class="tab" data-tab="categorias">Categorias</button>
    <button class="tab" data-tab="produtos">Produtos</button>
    <button class="tab" data-tab="aprovacao">Cadastros</button>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Criar Cliente</h3>
      <p>Cria a loja + (opcional) cria login do cliente no Supabase Auth.</p>

      <div class="row" style="gap:12px">
        <div class="field">
          <label>Nome</label>
          <input id="c_nome" placeholder="Ex: Padaria do Z√©" />
        </div>
        <div class="field">
          <label>Slug</label>
          <input id="c_slug" placeholder="ex: padaria-do-ze" />
        </div>
      </div>

      <div class="row" style="gap:12px">
        <div class="field">
          <label>WhatsApp</label>
          <input id="c_whats" placeholder="6299..." />
        </div>
        <div class="field">
          <label>Tipo de neg√≥cio</label>
          <select id="c_tipo_negocio">
            <option value="">Selecione...</option>
            <option value="restaurante">Restaurante</option>
            <option value="bar">Bar</option>
            <option value="padaria">Padaria</option>
            <option value="pousada">Pousada</option>
            <option value="mercado">Mercado</option>
            <option value="servicos">Servi√ßos</option>
            <option value="outro">Outro</option>
          </select>
        </div>
      </div>

      <div class="row" style="gap:12px">
        <div class="field">
          <label>Logo URL (opcional)</label>
          <input id="c_logo" placeholder="https://.../logo.png" />
        </div>
        <div class="field">
          <label>Status</label>
          <select id="c_status">
            <option value="ativo" selected>Ativo</option>
            <option value="inativo">Inativo</option>
          </select>
        </div>
      </div>

      <div class="row" style="gap:12px">
        <div class="field">
          <label>Email do cliente (opcional)</label>
          <input id="c_email" placeholder="cliente@dominio.com" />
        </div>
        <div class="field">
          <label>Senha do cliente (opcional)</label>
          <input id="c_senha" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>
      </div>

      <div style="margin-top:12px">
        <button class="btn y" id="btnCriarCliente">‚ûï Criar cliente</button>
      </div>
    </div>

    <div class="card">
      <h3>Cadastros</h3>
      <p>Selecione um cliente e cadastre categorias/produtos com seguran√ßa.</p>

      <div class="row" style="gap:12px">
        <div class="field">
          <label>Cliente selecionado</label>
          <select id="sel_cliente"></select>
        </div>
        <div class="field">
          <label>Categoria (para produto)</label>
          <select id="sel_categoria"></select>
        </div>
      </div>

      <div class="row" style="gap:12px">
        <div class="field">
          <label>Nova categoria</label>
          <input id="cat_nome" placeholder="Ex: Bebidas" />
        </div>
        <div class="field">
          <label>Ordem</label>
          <input id="cat_ordem" type="number" value="0" />
        </div>
      </div>

      <div style="margin-top:10px">
        <button class="btn y" id="btnCriarCategoria">üìÅ Criar categoria</button>
      </div>

      <hr style="border:0;border-top:1px solid rgba(255,255,255,.10);margin:14px 0">

      <div class="row" style="gap:12px">
        <div class="field">
          <label>Produto</label>
          <input id="p_nome" placeholder="Ex: P√£o de queijo" />
        </div>
        <div class="field">
          <label>Pre√ßo</label>
          <input id="p_preco" type="number" step="0.01" value="0" />
        </div>
      </div>

      <div class="row" style="gap:12px">
        <div class="field" style="flex:1">
          <label>Descri√ß√£o</label>
          <input id="p_desc" placeholder="opcional..." />
        </div>
        <div class="field">
          <label>Imagem URL (opcional)</label>
          <input id="p_img" placeholder="https://.../foto.jpg" />
        </div>
      </div>

      <div style="margin-top:10px">
        <button class="btn y" id="btnCriarProduto">üßæ Criar produto</button>
      </div>
    </div>
  </div>

  <div class="listWrap">
    <div class="listTop">
      <div>
        <div class="ttl" id="listTitle">Clientes</div>
        <div class="meta" id="listSubtitle">A√ß√µes: ver publicado, ativar/desativar, excluir.</div>
      </div>
      <input id="search" placeholder="Buscar..." style="min-width:240px">
    </div>

    <div class="items" id="list"></div>
  </div>

</div>

<script>
  // ===== CONFIG =====
  // ‚ö†Ô∏è Cole aqui o seu SUPABASE_URL e SUPABASE_ANON_KEY do projeto
  const SUPABASE_URL = "COLE_AQUI_SUA_SUPABASE_URL";
  const SUPABASE_ANON_KEY = "COLE_AQUI_SUA_SUPABASE_ANON_KEY";

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  let session = null;

  // ===== Admin Alfa enforcement =====
  const ALFA_EMAIL = "playmomentsstudios@gmail.com";
  function isAlfa(){
    const email = session?.user?.email || "";
    return String(email).toLowerCase().trim() === ALFA_EMAIL.toLowerCase();
  }
  async function requireAlfa(){
    if(!session) return false;
    if(isAlfa()) return true;
    try{ await sb.auth.signOut(); }catch(_e){}
    session = null;
    el("app").style.display="none";
    show("login");
    const box = document.getElementById("loginMsg");
    if(box){ box.style.display="block"; box.textContent="Acesso negado: este painel √© apenas para o Admin Alfa."; }
    return false;
  }

  // ===== STATE =====
  let tab = "clientes";
  let clientes = [], categorias = [], produtos = [];
  let cadastros = [];
  let cadastroPublicoAtivo = true;

  // ===== HELPERS =====
  function el(id){ return document.getElementById(id); }
  function show(id){ el(id).style.display="block"; }
  function hide(id){ el(id).style.display="none"; }

  function escapeHtml(str){
    return String(str ?? "")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  function slugify(s){
    return String(s||"").toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/[^a-z0-9\s-]/g,"")
      .trim().replace(/\s+/g,"-").replace(/-+/g,"-");
  }

  function openMenu(id){
    document.querySelectorAll(".menu").forEach(m=>{ if(m.id!==id) m.style.display="none"; });
    const m = document.getElementById(id);
    if(!m) return;
    m.style.display = (m.style.display==="block") ? "none" : "block";
  }
  window.addEventListener("click", (e)=>{
    if(!e.target.closest(".menuWrap")){
      document.querySelectorAll(".menu").forEach(m=>m.style.display="none");
    }
  });

  // ===== AUTH =====
  async function signInEmail(){
    const email = el("email").value.trim();
    const password = el("senha").value;
    const box = el("loginMsg");
    box.style.display="none";

    const { data, error } = await sb.auth.signInWithPassword({ email, password });
    if(error){
      box.style.display="block";
      box.textContent = error.message;
      return;
    }
    session = data.session;
    const ok = await requireAlfa();
    if(!ok) return;
    await afterLogin();
  }

  async function signInGoogle(){
    const box = el("loginMsg");
    box.style.display="none";

    const { error } = await sb.auth.signInWithOAuth({
      provider: "google",
      options: { redirectTo: window.location.href }
    });
    if(error){
      box.style.display="block";
      box.textContent = error.message;
    }
  }

  async function logout(){
    await sb.auth.signOut();
    session = null;
    hide("app");
    show("login");
  }

  // ===== LOADERS =====
  async function loadClientes(){
    const { data, error } = await sb.from("clientes").select("*").order("created_at",{ascending:false});
    if(error) throw error;
    clientes = data || [];
  }

  async function loadCategorias(){
    const { data, error } = await sb.from("categorias").select("*").order("ordem",{ascending:true});
    if(error) throw error;
    categorias = data || [];
  }

  async function loadProdutos(){
    const { data, error } = await sb.from("produtos").select("*").order("created_at",{ascending:false});
    if(error) throw error;
    produtos = data || [];
  }

  async function loadCadastros(){
    const { data, error } = await sb.from("cadastros_clientes").select("*").order("created_at",{ascending:false});
    if(error) throw error;
    cadastros = data || [];
  }

  async function loadCadastroPublicoConfig(){
    const { data, error } = await sb.from("portal_config").select("valor").eq("chave","cadastro_publico_ativo").maybeSingle();
    if(!error){
      cadastroPublicoAtivo = String(data?.valor || "true") === "true";
    }
  }

  async function toggleCadastroPublico(){
    try{
      const novo = !cadastroPublicoAtivo;
      const { error } = await sb.from("portal_config")
        .upsert({ chave:"cadastro_publico_ativo", valor: novo ? "true" : "false" }, { onConflict:"chave" });
      if(error) throw error;
      cadastroPublicoAtivo = novo;
      renderList();
    }catch(e){
      alert("Falha ao alternar cadastro p√∫blico: " + (e?.message || e));
    }
  }

  async function loadAll(){
    await loadClientes();
    await loadCategorias();
    await loadProdutos();
    await loadCadastroPublicoConfig();
    await loadCadastros();
    fillSelects();
    renderList();
  }

  function fillSelects(){
    const sel = el("sel_cliente");
    sel.innerHTML = clientes.map(c=>`<option value="${escapeHtml(c.slug)}">${escapeHtml(c.nome)} (${escapeHtml(c.slug)})</option>`).join("");
    fillCategoriasForSelected();
  }

  function fillCategoriasForSelected(){
    const clienteSlug = el("sel_cliente").value;
    const selCat = el("sel_categoria");
    const list = categorias.filter(x=>x.cliente_id===clienteSlug || x.cliente_slug===clienteSlug || x.cliente===clienteSlug || x.slug_cliente===clienteSlug);
    // fallback: se categorias n√£o tiver cliente_slug, mostra todas
    const use = list.length ? list : categorias;
    selCat.innerHTML = use.map(c=>`<option value="${c.id}">${escapeHtml(c.nome)}</option>`).join("");
  }

  // ===== ACTIONS: criar cliente/categoria/produto =====
  async function criarCliente(){
    const nome = el("c_nome").value.trim();
    const slug = (el("c_slug").value.trim() || slugify(nome));
    const whatsapp = el("c_whats").value.trim();
    const logo_url = el("c_logo").value.trim() || null;
    const status = el("c_status").value;
    const tipo_negocio = el("c_tipo_negocio").value || null;

    if(!nome || !slug){
      return alert("Preencha nome e slug.");
    }

    const payload = {
      nome,
      slug,
      whatsapp: whatsapp || "",
      ativo: status==="ativo",
      logo_url,
      tipo_negocio,
      tipo: "portal"
    };

    const { error } = await sb.from("clientes").insert(payload);
    if(error) return alert("Erro ao criar cliente: " + error.message);

    // opcional: criar auth user (se voc√™ j√° tiver rotina server-side, aqui fica s√≥ o cadastro)
    alert("Cliente criado!");
    await loadClientes();
    fillSelects();
    renderList();
  }

  async function criarCategoria(){
    const clienteSlug = el("sel_cliente").value;
    const nome = el("cat_nome").value.trim();
    const ordem = Number(el("cat_ordem").value || 0);

    if(!clienteSlug || !nome) return alert("Selecione cliente e preencha nome da categoria.");

    const payload = {
      cliente_slug: clienteSlug,
      nome,
      ordem,
      ativo: true
    };

    const { error } = await sb.from("categorias").insert(payload);
    if(error) return alert("Erro ao criar categoria: " + error.message);

    el("cat_nome").value="";
    await loadCategorias();
    fillCategoriasForSelected();
    renderList();
    alert("Categoria criada!");
  }

  async function criarProduto(){
    const clienteSlug = el("sel_cliente").value;
    const categoriaId = el("sel_categoria").value;
    const nome = el("p_nome").value.trim();
    const descricao = el("p_desc").value.trim() || null;
    const preco = Number(el("p_preco").value || 0);
    const imagem_url = el("p_img").value.trim() || null;

    if(!clienteSlug || !categoriaId || !nome) return alert("Selecione cliente, categoria e preencha nome do produto.");

    const payload = {
      cliente_slug: clienteSlug,
      categoria_id: categoriaId,
      nome,
      descricao,
      preco,
      imagem_url,
      ativo: true,
      ordem: 0
    };

    const { error } = await sb.from("produtos").insert(payload);
    if(error) return alert("Erro ao criar produto: " + error.message);

    el("p_nome").value="";
    el("p_desc").value="";
    el("p_preco").value="0";
    el("p_img").value="";
    await loadProdutos();
    renderList();
    alert("Produto criado!");
  }

  // ===== Aprova√ß√£o =====
  async function aprovarCadastro(id){
    try{
      const { data: cad, error } = await sb.from("cadastros_clientes").select("*").eq("id", id).single();
      if(error) throw error;

      const base = slugify(cad.nome_negocio || "negocio").slice(0,40) || "negocio";
      let slug = base;

      const { data: ex } = await sb.from("clientes").select("slug").eq("slug", slug).maybeSingle();
      if(ex?.slug) slug = `${base}-${String(Date.now()).slice(-4)}`;

      const payload = {
        nome: cad.nome_negocio,
        slug,
        whatsapp: cad.whatsapp || "",
        ativo: true,
        tipo: "portal",
        tipo_negocio: String(cad.categoria || "comercio").toLowerCase()
      };

      const { error: cErr } = await sb.from("clientes").insert(payload);
      if(cErr) throw cErr;

      const { error: uErr } = await sb.from("cadastros_clientes")
        .update({ status:"aprovado", cliente_slug: slug, aprovado_em: new Date().toISOString() })
        .eq("id", id);
      if(uErr) throw uErr;

      await loadClientes();
      await loadCadastros();
      fillSelects();
      renderList();
      alert("Cadastro aprovado e cliente criado!");
    }catch(e){
      alert("Falha ao aprovar: " + (e?.message || e));
    }
  }

  async function rejeitarCadastro(id){
    try{
      const { error } = await sb.from("cadastros_clientes")
        .update({ status:"rejeitado", rejeitado_em: new Date().toISOString() })
        .eq("id", id);
      if(error) throw error;

      await loadCadastros();
      renderList();
      alert("Cadastro rejeitado.");
    }catch(e){
      alert("Falha ao rejeitar: " + (e?.message || e));
    }
  }

  // ===== RENDER: Aprova√ß√£o =====
  function renderAprovacao(q, listEl){
    el("listTitle").textContent = "Cadastros (aprova√ß√£o)";
    el("listSubtitle").textContent = "Aprovar/Rejeitar cadastros p√∫blicos + ativar/desativar landing.";

    const pendentes = cadastros.filter(r => String(r.status||"").toLowerCase()==="pendente").length;

    const top = `
      <div class="aprovTop">
        <div class="row" style="gap:10px;flex-wrap:wrap">
          <span class="pill ${cadastroPublicoAtivo ? "ok" : "bad"}">
            ${cadastroPublicoAtivo ? "Cadastro p√∫blico ATIVO" : "Cadastro p√∫blico DESATIVADO"}
          </span>
          <button class="btn" onclick="toggleCadastroPublico()">${cadastroPublicoAtivo ? "Desativar" : "Ativar"}</button>
          <span class="meta">Pendentes: <strong>${pendentes}</strong></span>
        </div>
        <div class="meta">Use a busca acima para filtrar.</div>
      </div>
    `;

    let rows = cadastros.slice();
    if(q){
      rows = rows.filter(r=>{
        const blob = [r.nome_negocio,r.cidade,r.categoria,r.whatsapp,r.email,r.instagram,r.endereco,r.mensagem,r.status]
          .filter(Boolean).join(" ").toLowerCase();
        return blob.includes(q);
      });
    }

    if(!rows.length){
      listEl.innerHTML = top + `<div class="empty">Nenhum cadastro encontrado.</div>`;
      return;
    }

    listEl.innerHTML = top + `<div class="aprovList">` + rows.map(r=>{
      const st = String(r.status||"pendente").toLowerCase();
      const badge = st==="pendente" ? `<span class="pill warn">Pendente</span>` : st==="aprovado" ? `<span class="pill ok">Aprovado</span>` : `<span class="pill bad">Rejeitado</span>`;
      const when = r.created_at ? new Date(r.created_at).toLocaleString() : "";
      const wpp = String(r.whatsapp||"").replace(/\D/g,"");
      const wppLink = wpp ? `<a class="link" target="_blank" rel="noreferrer" href="https://wa.me/${wpp}">WhatsApp</a>` : "";

      return `
        <div class="aprovItem">
          <div>
            <div class="row" style="gap:10px;align-items:center;flex-wrap:wrap">
              <div class="ttl">${escapeHtml(r.nome_negocio||"‚Äî")}</div>
              ${badge}
            </div>
            <div class="meta">
              ${escapeHtml(r.cidade||"‚Äî")} ‚Ä¢ ${escapeHtml(r.categoria||"‚Äî")} ‚Ä¢ ${escapeHtml(r.whatsapp||"‚Äî")}
              ${wppLink ? " ‚Ä¢ "+wppLink : ""}
            </div>
            <div class="meta">${when}${r.email ? " ‚Ä¢ "+escapeHtml(r.email) : ""}${r.instagram ? " ‚Ä¢ @"+escapeHtml(r.instagram) : ""}</div>
            ${r.endereco ? `<div class="meta"><strong>Endere√ßo:</strong> ${escapeHtml(r.endereco)}</div>` : ``}
            ${r.mensagem ? `<div class="meta"><strong>Mensagem:</strong> ${escapeHtml(r.mensagem)}</div>` : ``}
          </div>

          <div class="row" style="gap:10px;flex-wrap:wrap;justify-content:flex-end">
            ${st==="pendente" ? `
              <button class="btn y small" onclick="aprovarCadastro('${r.id}')">Aprovar</button>
              <button class="btn small" onclick="rejeitarCadastro('${r.id}')">Rejeitar</button>
            ` : ``}
          </div>
        </div>
      `;
    }).join("") + `</div>`;
  }

  // ===== RENDER LIST =====
  function renderList(){
    const q = (el("search").value||"").trim().toLowerCase();
    const listEl = el("list");

    if (tab==="aprovacao"){
      return renderAprovacao(q, listEl);
    }

    if (tab==="clientes"){
      el("listTitle").textContent = "Clientes";
      el("listSubtitle").textContent = "A√ß√µes: ver publicado, ativar/desativar, excluir.";

      let list = clientes.slice();
      if (q) list = list.filter(x=>
        (x.nome||"").toLowerCase().includes(q) || (x.slug||"").toLowerCase().includes(q)
      );

      listEl.className="items";
      listEl.innerHTML = list.map(c=>{
        const mid = "m_cli_"+c.slug;
        return `
          <div class="item">
            <div class="itemTop">
              <div style="min-width:0">
                <div class="ttl">${escapeHtml(c.nome||"‚Äî")}</div>
                <div class="meta">${escapeHtml(c.slug||"")}</div>
              </div>
              <div class="menuWrap">
                <div class="kebab" onclick="openMenu('${mid}')">‚ãØ</div>
                <div class="menu" id="${mid}">
                  <button onclick="alert('Ver publicado: '+ '${c.slug}')">üëÅÔ∏è Ver publicado</button>
                  <button onclick="alert('Ativar/Desativar (implementar)')">‚úÖ Ativar/Desativar</button>
                  <button onclick="alert('Excluir (implementar)')">üóëÔ∏è Excluir</button>
                </div>
              </div>
            </div>
            <div class="meta" style="margin-top:8px">${escapeHtml(c.tipo_negocio||c.tipo||"")}</div>
          </div>
        `;
      }).join("");
      return;
    }

    if (tab==="categorias"){
      el("listTitle").textContent = "Categorias";
      el("listSubtitle").textContent = "Lista geral de categorias (ordem/ativo).";

      let list = categorias.slice();
      if (q) list = list.filter(x=> (x.nome||"").toLowerCase().includes(q));

      listEl.className="items";
      listEl.innerHTML = list.map(c=>{
        return `
          <div class="item">
            <div class="ttl">${escapeHtml(c.nome||"‚Äî")}</div>
            <div class="meta">ordem: ${c.ordem ?? 0} ‚Ä¢ ativo: ${c.ativo ? "sim" : "n√£o"}</div>
          </div>
        `;
      }).join("");
      return;
    }

    if (tab==="produtos"){
      el("listTitle").textContent = "Produtos";
      el("listSubtitle").textContent = "Lista geral de produtos (pre√ßo/ativo).";

      let list = produtos.slice();
      if (q) list = list.filter(x=> (x.nome||"").toLowerCase().includes(q));

      listEl.className="items";
      listEl.innerHTML = list.map(p=>{
        return `
          <div class="item">
            <div class="ttl">${escapeHtml(p.nome||"‚Äî")}</div>
            <div class="meta">R$ ${Number(p.preco||0).toFixed(2)} ‚Ä¢ ativo: ${p.ativo ? "sim" : "n√£o"}</div>
          </div>
        `;
      }).join("");
      return;
    }
  }

  // ===== After login =====
  async function afterLogin(){
    hide("login");
    show("app");
    await loadAll();
  }

  // ===== UI binds =====
  document.querySelectorAll(".tab").forEach(b=>{
    b.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      tab = b.dataset.tab;
      renderList();
    });
  });

  el("search").addEventListener("input", renderList);
  el("sel_cliente").addEventListener("change", fillCategoriasForSelected);

  el("btnLogin").onclick = signInEmail;
  el("btnGoogle").onclick = signInGoogle;
  el("btnLogout").onclick = logout;
  el("btnReload").onclick = async ()=>{ await loadAll(); };

  el("btnCriarCliente").onclick = criarCliente;
  el("btnCriarCategoria").onclick = criarCategoria;
  el("btnCriarProduto").onclick = criarProduto;

  // ===== Boot =====
  (async ()=>{
    const { data } = await sb.auth.getSession();
    session = data.session;

    if (session){
      const ok = await requireAlfa();
      if(ok) await afterLogin();
    }else{
      show("login"); hide("app");
    }

    sb.auth.onAuthStateChange(async (_event, s)=>{
      session = s;
      if(session){
        const ok = await requireAlfa();
        if(ok) await afterLogin();
      }
    });
  })();
</script>

</body>
</html>
