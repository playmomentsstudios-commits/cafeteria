<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Painel Alfa ‚Äî Card√°pio Digital</title>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg0:#07121f;
      --bg1:#091a2b;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.08);
      --line:rgba(255,255,255,.10);
      --text:#e7eefc;
      --muted:rgba(231,238,252,.72);

      /* Paleta azul + acento (combina com seu layout) */
      --primary:#2b69ff;      /* azul vivo */
      --primary2:#1a4fd6;     /* azul profundo */
      --accent:#2ee6c5;       /* teal/menta */
      --accent2:#18b79b;

      --ok:#2ee6c5;
      --warn:#ffcc66;
      --danger:#ff5a67;

      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius: 22px;
      --radius2: 14px;
      --glass: blur(14px);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(43,105,255,.35), transparent 55%),
        radial-gradient(900px 700px at 80% 15%, rgba(46,230,197,.18), transparent 55%),
        radial-gradient(1100px 900px at 50% 95%, rgba(43,105,255,.20), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      padding: 28px 18px 60px;
    }

    a{color:inherit}
    .wrap{max-width: 1200px; margin:0 auto}
    .topbar{
      display:flex; gap:16px; align-items:center; justify-content:space-between;
      padding: 18px 20px;
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      backdrop-filter: var(--glass);
    }
    .brand{
      display:flex; gap:14px; align-items:center;
      min-width: 260px;
    }
    .logo{
      width:64px; height:64px; border-radius: 18px;
      background: linear-gradient(135deg, rgba(43,105,255,.25), rgba(46,230,197,.15));
      border: 1px dashed rgba(255,255,255,.25);
      display:flex; align-items:center; justify-content:center;
      font-weight:800; letter-spacing:.5px; color: rgba(231,238,252,.88);
    }
    .brand h1{margin:0; font-size: 20px; line-height: 1.1}
    .brand p{margin:4px 0 0; color: var(--muted); font-size: 12.5px}

    .pillrow{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center;
    }
    .pill{
      display:flex; gap:8px; align-items:center;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(231,238,252,.92);
      font-size: 12.5px;
      white-space:nowrap;
    }
    .pill b{font-weight:800}
    .btn{
      cursor:pointer;
      border: none;
      color: var(--text);
      padding: 11px 14px;
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 10px 30px rgba(0,0,0,.20);
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      display:inline-flex; align-items:center; gap:9px;
      font-weight:700;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.18)}
    .btn:active{transform: translateY(0)}
    .btn.primary{
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      border-color: rgba(255,255,255,.18);
    }
    .btn.accent{
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #06201a;
      border-color: rgba(0,0,0,.05);
    }
    .btn.danger{
      background: linear-gradient(135deg, rgba(255,90,103,.95), rgba(255,90,103,.70));
      border-color: rgba(255,255,255,.10);
    }
    .btn.ghost{
      background: transparent;
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: none;
    }
    .btn.small{
      padding: 9px 11px;
      border-radius: 12px;
      font-weight:700;
      font-size: 13px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 18px;
      margin-top: 18px;
    }

    .card{
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.075), rgba(255,255,255,.035));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      backdrop-filter: var(--glass);
      padding: 18px;
      overflow:hidden;
    }
    .card h2{margin:0 0 4px; font-size: 18px}
    .sub{margin:0 0 14px; color: var(--muted); font-size: 13px}

    .stats{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }
    .stat{
      border-radius: 18px;
      padding: 14px 14px 12px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
    }
    .stat .k{color: var(--muted); font-size: 12px}
    .stat .v{font-size: 20px; font-weight: 900; margin-top: 4px}
    .tabs{
      display:flex; gap:10px; justify-content:center; margin-top: 14px;
      padding: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
    }
    .tab{
      cursor:pointer;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: transparent;
      color: rgba(231,238,252,.85);
      font-weight: 800;
      display:flex; gap:8px; align-items:center;
      min-width: 120px; justify-content:center;
    }
    .tab.active{
      background: rgba(43,105,255,.18);
      border-color: rgba(43,105,255,.35);
      color: var(--text);
    }

    .formRow{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
      margin-top: 12px;
    }
    .field{grid-column: span 6}
    .field.sm{grid-column: span 3}
    .field.lg{grid-column: span 9}
    label{
      display:block;
      font-size: 12.5px;
      color: rgba(231,238,252,.80);
      margin: 2px 0 6px;
      font-weight: 800;
    }
    input, select, textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.14);
      color: var(--text);
      outline:none;
      transition: border-color .12s ease, background .12s ease;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(46,230,197,.45);
      background: rgba(0,0,0,.26);
    }
    textarea{min-height: 90px; resize: vertical}

    .rowActions{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      margin-top: 10px;
    }

    .divider{
      height:1px;
      background: rgba(255,255,255,.10);
      margin: 14px 0;
    }

    /* LISTA compacta por linha */
    .listHead{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-top: 8px;
    }
    .searchWrap{
      display:flex; gap:10px; align-items:center; width: 100%;
    }
    .searchWrap input{max-width: 460px}
    .table{
      margin-top: 12px;
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .trow, .thead{
      display:grid;
      grid-template-columns: 1.5fr 1.1fr 1fr .7fr 56px;
      gap: 10px;
      padding: 12px 14px;
      align-items:center;
    }
    .thead{
      background: rgba(255,255,255,.06);
      border-bottom: 1px solid rgba(255,255,255,.10);
      color: rgba(231,238,252,.72);
      font-size: 12px;
      font-weight: 900;
      letter-spacing: .2px;
      text-transform: uppercase;
    }
    .trow{
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .trow:last-child{border-bottom:none}
    .cellSmall{font-size: 13.5px; color: rgba(231,238,252,.92)}
    .muted{color: var(--muted); font-size: 13px}
    .mono{font-family: var(--mono)}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      justify-self: start;
    }
    .chip.ok{background: rgba(46,230,197,.14); border-color: rgba(46,230,197,.30)}
    .chip.off{background: rgba(255,90,103,.12); border-color: rgba(255,90,103,.22)}
    .dot{width:8px; height:8px; border-radius:99px; background: rgba(255,255,255,.35)}
    .chip.ok .dot{background: var(--ok)}
    .chip.off .dot{background: var(--danger)}

    /* Bot√£o 3 pontos + menu */
    .kebab{
      width: 44px; height: 40px;
      border-radius: 12px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.12);
      cursor:pointer;
      transition: background .12s ease, transform .12s ease, border-color .12s ease;
      position: relative;
      user-select:none;
    }
    .kebab:hover{background: rgba(255,255,255,.08); transform: translateY(-1px); border-color: rgba(255,255,255,.18)}
    .kebab:active{transform: translateY(0)}
    .kebab span{letter-spacing: 2px; font-weight: 900}

    .menu{
      position:absolute;
      right: 0;
      top: 46px;
      min-width: 180px;
      padding: 8px;
      border-radius: 16px;
      background: rgba(10, 22, 36, .92);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      backdrop-filter: var(--glass);
      display:none;
      z-index: 50;
    }
    .menu.open{display:block}
    .mitem{
      width:100%;
      display:flex; align-items:center; gap:10px;
      padding: 10px 10px;
      border-radius: 12px;
      background: transparent;
      border: 1px solid transparent;
      color: rgba(231,238,252,.92);
      cursor:pointer;
      font-weight: 800;
      text-align:left;
    }
    .mitem:hover{background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.10)}
    .mitem.danger{color: rgba(255,90,103,.95)}
    .ico{width:18px; display:inline-flex; justify-content:center}

    .toast{
      margin-top: 14px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: rgba(231,238,252,.90);
      display:none;
    }
    .toast.show{display:block}
    .toast.ok{border-color: rgba(46,230,197,.28); background: rgba(46,230,197,.10)}
    .toast.err{border-color: rgba(255,90,103,.22); background: rgba(255,90,103,.10)}

    .loginGrid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 16px;
      align-items: start;
    }
    .hint{
      border-radius: 18px;
      padding: 14px;
      background: rgba(46,230,197,.09);
      border: 1px solid rgba(46,230,197,.18);
      color: rgba(231,238,252,.90);
      font-size: 13px;
      line-height: 1.4;
    }
    .hint b{color: rgba(231,238,252,.98)}
    .smallNote{color: var(--muted); font-size: 12.5px; margin-top: 10px}

    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr}
      .loginGrid{grid-template-columns: 1fr}
      .trow, .thead{
        grid-template-columns: 1.6fr 1.1fr 1fr .8fr 56px;
      }
    }
    @media (max-width: 640px){
      .topbar{flex-direction:column; align-items:stretch}
      .pillrow{justify-content:flex-start}
      .stats{grid-template-columns: 1fr}
      .tabs{flex-wrap:wrap}
      .trow, .thead{
        grid-template-columns: 1fr;
        gap: 8px;
      }
      .thead{display:none}
      .kebab{justify-self:end}
      .trow{padding: 14px}
      .trow .muted{font-size: 12.5px}
    }
  </style>
</head>

<body>
<div class="wrap">

  <!-- TOP -->
  <div class="topbar">
    <div class="brand">
      <div class="logo" id="logoBox">LOGO</div>
      <div>
        <h1>Painel Alfa ‚Äî Card√°pio Digital</h1>
        <p>Super Admin ‚Ä¢ CRUD seguro via Vercel (Service Role) ‚Ä¢ UI compacta</p>
      </div>
    </div>

    <div class="pillrow">
      <div class="pill">Status: <b id="statusTxt">Deslogado</b></div>
      <div class="pill">API: <b id="apiTxt">‚Äî</b></div>
      <button class="btn danger small" id="btnLogout" disabled>üö™ Sair</button>
    </div>
  </div>

  <!-- MAIN GRID -->
  <div class="grid">
    <!-- LEFT: Dashboard + Tabs -->
    <div class="card">
      <h2>Vis√£o geral</h2>
      <p class="sub">Resumo r√°pido e navega√ß√£o entre Clientes, Categorias e Produtos.</p>

      <div class="stats">
        <div class="stat">
          <div class="k">Clientes</div>
          <div class="v" id="countClientes">‚Äî</div>
        </div>
        <div class="stat">
          <div class="k">Categorias</div>
          <div class="v" id="countCategorias">‚Äî</div>
        </div>
        <div class="stat">
          <div class="k">Produtos</div>
          <div class="v" id="countProdutos">‚Äî</div>
        </div>
      </div>

      <div class="tabs" style="margin-top:16px">
        <button class="tab active" data-tab="clientes">üë• Clientes</button>
        <button class="tab" data-tab="categorias">üóÇÔ∏è Categorias</button>
        <button class="tab" data-tab="produtos">üßæ Produtos</button>
      </div>

      <div class="toast" id="toast"></div>

      <div class="divider"></div>

      <!-- LOGIN -->
      <div id="loginArea">
        <h2>Login</h2>
        <p class="sub">Entre com um usu√°rio do Supabase Auth. Depois, o painel habilita CRUD via API Vercel.</p>

        <div class="loginGrid">
          <div>
            <div class="formRow">
              <div class="field lg" style="grid-column: span 12">
                <label>Email</label>
                <input id="email" placeholder="seu@email.com" autocomplete="email" />
              </div>
              <div class="field lg" style="grid-column: span 12">
                <label>Senha</label>
                <input id="senha" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
              </div>
            </div>

            <div class="rowActions">
              <div style="display:flex; gap:10px; flex-wrap:wrap">
                <button class="btn primary" id="btnLogin">üîê Entrar</button>
                <button class="btn ghost" id="btnGoogle">üü¶ Entrar com Google</button>
              </div>
              <div class="smallNote">Dica: se travar, veja ‚ÄúDiagn√≥stico‚Äù no final da p√°gina.</div>
            </div>
          </div>

          <div class="hint">
            <b>Checklist r√°pido</b><br/>
            ‚Ä¢ Redirect URLs no Supabase devem incluir seu /admin/<br/>
            ‚Ä¢ CORS na API Vercel permite <span class="mono">playmomentsstudios-commits.github.io</span><br/>
            ‚Ä¢ O painel envia <span class="mono">Authorization: Bearer access_token</span>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Forms -->
    <div class="card">
      <h2 id="formTitle">Cadastrar Cliente</h2>
      <p class="sub" id="formSub">Crie a loja e gere o link publicado.</p>

      <!-- CLIENTES FORM -->
      <div id="formClientes">
        <div class="formRow">
          <div class="field" style="grid-column: span 12">
            <label>Nome do neg√≥cio</label>
            <input id="c_nome" placeholder="ex: Cafeteria do Jo√£o"/>
          </div>
          <div class="field" style="grid-column: span 7">
            <label>Slug</label>
            <input id="c_slug" placeholder="ex: cafeteria-do-joao"/>
          </div>
          <div class="field" style="grid-column: span 5">
            <label>WhatsApp</label>
            <input id="c_whats" placeholder="ex: 6299..."/>
          </div>
          <div class="field sm" style="grid-column: span 6">
            <label>Status do cliente</label>
            <select id="c_ativo">
              <option value="true">Ativo</option>
              <option value="false">Inativo</option>
            </select>
          </div>
          <div class="field sm" style="grid-column: span 6">
            <label>&nbsp;</label>
            <button class="btn accent" id="btnSalvarCliente">üíæ Salvar</button>
          </div>
        </div>
      </div>

      <!-- CATEGORIAS FORM -->
      <div id="formCategorias" style="display:none">
        <div class="formRow">
          <div class="field" style="grid-column: span 12">
            <label>Cliente dono da categoria</label>
            <select id="cat_cliente"></select>
          </div>
          <div class="field" style="grid-column: span 8">
            <label>Nome da categoria</label>
            <input id="cat_nome" placeholder="ex: Cuscuz, Bebidas, Doces"/>
          </div>
          <div class="field sm" style="grid-column: span 4">
            <label>Ordem</label>
            <input id="cat_ordem" type="number" placeholder="ex: 1"/>
          </div>
          <div class="field sm" style="grid-column: span 6">
            <label>Status</label>
            <select id="cat_ativo">
              <option value="true">Ativa</option>
              <option value="false">Inativa</option>
            </select>
          </div>
          <div class="field sm" style="grid-column: span 6">
            <label>&nbsp;</label>
            <button class="btn accent" id="btnSalvarCategoria">üíæ Salvar</button>
          </div>
        </div>
      </div>

      <!-- PRODUTOS FORM -->
      <div id="formProdutos" style="display:none">
        <div class="formRow">
          <div class="field" style="grid-column: span 12">
            <label>Cliente</label>
            <select id="p_cliente"></select>
          </div>
          <div class="field" style="grid-column: span 12">
            <label>Categoria</label>
            <select id="p_categoria"></select>
          </div>
          <div class="field" style="grid-column: span 12">
            <label>Nome do produto</label>
            <input id="p_nome" placeholder="ex: Cuscuz da Baiana"/>
          </div>
          <div class="field" style="grid-column: span 12">
            <label>Descri√ß√£o</label>
            <textarea id="p_desc" placeholder="opcional"></textarea>
          </div>
          <div class="field sm" style="grid-column: span 6">
            <label>Pre√ßo</label>
            <input id="p_preco" type="number" step="0.01" placeholder="ex: 12.50"/>
          </div>
          <div class="field sm" style="grid-column: span 6">
            <label>Status</label>
            <select id="p_ativo">
              <option value="true">Ativo</option>
              <option value="false">Inativo</option>
            </select>
          </div>
          <div class="field" style="grid-column: span 12">
            <label>URL da imagem (opcional)</label>
            <input id="p_img" placeholder="https://..."/>
          </div>
          <div class="field" style="grid-column: span 12">
            <button class="btn accent" id="btnSalvarProduto">üíæ Salvar</button>
          </div>
        </div>
      </div>

      <div class="smallNote" id="publicHint" style="margin-top:12px">
        Link p√∫blico: <span class="mono">?u=slug</span> (ex: <span class="mono">?u=cafeteria-do-joao</span>).
      </div>
    </div>
  </div>

  <!-- LISTS -->
  <div class="card" style="margin-top:18px">
    <div class="listHead">
      <div>
        <h2 id="listTitle" style="margin:0">Clientes cadastrados</h2>
        <div class="sub" id="listSub" style="margin:4px 0 0">A√ß√µes no menu ‚ãØ (ver, copiar link, editar, duplicar, ativar/desativar, excluir).</div>
      </div>

      <div class="searchWrap">
        <input id="search" placeholder="Buscar por nome ou slug..." />
        <button class="btn small" id="btnReload">üîÑ Recarregar</button>
      </div>
    </div>

    <div class="table" id="tableWrap">
      <div class="thead" id="thead">
        <div>Nome</div><div>Slug</div><div>WhatsApp</div><div>Status</div><div style="text-align:right">‚ãØ</div>
      </div>
      <div id="tbody"></div>
    </div>
  </div>

  <!-- DIAGN√ìSTICO -->
  <div class="card" style="margin-top:18px">
    <h2>Diagn√≥stico</h2>
    <p class="sub">Aqui aparece carregamento, erros de API e sess√£o.</p>
    <div id="diag" style="
      font-family: var(--mono);
      font-size: 12px;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      padding: 12px;
      max-height: 240px;
      overflow:auto;"></div>
  </div>

</div>

<script>
/* =======================
   CONFIG
======================= */
const SUPABASE_URL = "https://rgsnmxspyywwouhcdwkj.supabase.co";
const SUPABASE_KEY = "sb_publishable_nHPsCV3y79FgexEMAeANWQ_P6jWRDd1";

// seu dom√≠nio Vercel (API)
const API_BASE_DEFAULT = "https://cafeteria-gamma-orpin.vercel.app";
let API_BASE = API_BASE_DEFAULT;

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* =======================
   STATE
======================= */
let session = null;
let tab = "clientes";

let cache = {
  clientes: [],
  categorias: [],
  produtos: [],
};

let editing = { clientes:null, categorias:null, produtos:null };

/* =======================
   UI HELPERS
======================= */
const el = (id) => document.getElementById(id);
const diag = (msg, ok=true) => {
  const box = el("diag");
  const t = new Date().toLocaleTimeString("pt-BR");
  box.innerHTML = `[${t}] ${ok ? "‚úÖ" : "‚ùå"} ${msg}<br/>` + box.innerHTML;
};

const toast = (msg, type="ok") => {
  const t = el("toast");
  t.className = "toast show " + (type === "err" ? "err" : "ok");
  t.textContent = msg;
  setTimeout(()=>{ t.className="toast"; }, 3600);
};

const money = (v) => (Number(v||0)).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});

/* =======================
   AUTH
======================= */
async function refreshSessionUI() {
  const { data } = await sb.auth.getSession();
  session = data.session || null;

  el("statusTxt").textContent = session ? (session.user?.email || "Logado") : "Deslogado";
  el("btnLogout").disabled = !session;
  el("apiTxt").textContent = API_BASE ? new URL(API_BASE).host : "‚Äî";

  el("loginArea").style.display = session ? "none" : "block";

  if (session) {
    diag("AuthStateChange: SIGNED_IN");
    await loadAll();
  } else {
    diag("AuthStateChange: SIGNED_OUT");
    cache = { clientes:[], categorias:[], produtos:[] };
    renderCounts();
    renderList();
  }
}

async function loginWithPassword() {
  const email = el("email").value.trim();
  const password = el("senha").value;

  if (!email || !password) return toast("Preencha email e senha.", "err");

  const { data, error } = await sb.auth.signInWithPassword({ email, password });
  if (error) {
    diag("Login error: " + error.message, false);
    return toast(error.message, "err");
  }
  session = data.session;
  toast("Logado com sucesso!");
  await refreshSessionUI();
}

async function loginWithGoogle() {
  // redireciona e volta pra mesma URL do /admin/
  const redirectTo = window.location.origin + window.location.pathname;
  const { error } = await sb.auth.signInWithOAuth({
    provider: "google",
    options: { redirectTo }
  });
  if (error) {
    diag("Google OAuth error: " + error.message, false);
    toast(error.message, "err");
  }
}

async function logout() {
  await sb.auth.signOut();
  toast("Voc√™ saiu.");
  await refreshSessionUI();
}

sb.auth.onAuthStateChange((event) => {
  diag("AuthStateChange: " + event);
});

/* =======================
   API (Vercel)
======================= */
function authHeaders() {
  if (!session?.access_token) return {};
  return { "Authorization": "Bearer " + session.access_token };
}

async function api(path, opts={}) {
  const url = API_BASE.replace(/\/$/,"") + path;
  const headers = {
    "Content-Type": "application/json",
    ...(opts.headers || {}),
    ...authHeaders(),
  };

  const res = await fetch(url, { ...opts, headers });

  // se CORS falhar, nem chega aqui (vira Failed to fetch)
  let body = null;
  try { body = await res.json(); } catch {}

  if (!res.ok) {
    const msg = body?.error || `HTTP ${res.status}`;
    throw new Error(msg);
  }
  return body;
}

/* =======================
   LOAD DATA
======================= */
async function loadAll() {
  try{
    diag("loadAll: iniciando...");
    const [c1,c2,c3] = await Promise.all([
      api("/api/admin/clientes", { method:"GET" }),
      api("/api/admin/categorias", { method:"GET" }),
      api("/api/admin/produtos", { method:"GET" }),
    ]);

    cache.clientes = c1.data || [];
    cache.categorias = c2.data || [];
    cache.produtos = c3.data || [];
    diag("loadAll: ok ("+cache.clientes.length+" clientes, "+cache.categorias.length+" categorias, "+cache.produtos.length+" produtos)");

    renderCounts();
    fillSelects();
    renderList();
  } catch(e){
    diag("loadAll: Failed to fetch ("+ e.message +")", false);
    toast(e.message, "err");
  }
}

/* =======================
   COUNTS + SELECTS
======================= */
function renderCounts() {
  el("countClientes").textContent = cache.clientes.length || "‚Äî";
  el("countCategorias").textContent = cache.categorias.length || "‚Äî";
  el("countProdutos").textContent = cache.produtos.length || "‚Äî";
}

function fillSelects(){
  // categorias: select cliente
  const selCat = el("cat_cliente");
  const selPCli = el("p_cliente");

  const optionsClientes = cache.clientes
    .slice()
    .sort((a,b)=> (a.nome||"").localeCompare(b.nome||""))
    .map(c => `<option value="${c.slug}">${c.nome} (${c.slug})</option>`)
    .join("");

  selCat.innerHTML = `<option value="">Selecione...</option>` + optionsClientes;
  selPCli.innerHTML = `<option value="">Selecione...</option>` + optionsClientes;

  // produtos: select categoria depende do cliente
  updateCategoriasForProduto();
}

function updateCategoriasForProduto(){
  const clienteSlug = el("p_cliente").value;
  const sel = el("p_categoria");
  const cats = cache.categorias.filter(x => !clienteSlug || x.cliente_slug === clienteSlug);

  sel.innerHTML =
    `<option value="">Selecione...</option>` +
    cats
      .slice()
      .sort((a,b)=> (a.ordem||0)-(b.ordem||0))
      .map(c => `<option value="${c.id}">${c.nome} (ordem ${c.ordem||0})</option>`)
      .join("");
}

/* =======================
   TABS
======================= */
function setTab(next){
  tab = next;
  document.querySelectorAll(".tab").forEach(b=>{
    b.classList.toggle("active", b.dataset.tab === tab);
  });

  // forms visibilidade
  el("formClientes").style.display = tab==="clientes" ? "block" : "none";
  el("formCategorias").style.display = tab==="categorias" ? "block" : "none";
  el("formProdutos").style.display = tab==="produtos" ? "block" : "none";

  // title/sub
  if (tab==="clientes"){
    el("formTitle").textContent = editing.clientes ? "Editar Cliente" : "Cadastrar Cliente";
    el("formSub").textContent = "Crie a loja e gere o link publicado.";
    el("listTitle").textContent = "Clientes cadastrados";
    el("listSub").textContent = "A√ß√µes no menu ‚ãØ (ver, copiar link, editar, duplicar, ativar/desativar, excluir).";
  }
  if (tab==="categorias"){
    el("formTitle").textContent = editing.categorias ? "Editar Categoria" : "Cadastrar Categoria";
    el("formSub").textContent = "Organize o card√°pio por categorias.";
    el("listTitle").textContent = "Categorias cadastradas";
    el("listSub").textContent = "A√ß√µes no menu ‚ãØ (editar, duplicar, ativar/desativar, excluir).";
  }
  if (tab==="produtos"){
    el("formTitle").textContent = editing.produtos ? "Editar Produto" : "Cadastrar Produto";
    el("formSub").textContent = "Cadastre produtos e associe uma categoria.";
    el("listTitle").textContent = "Produtos cadastrados";
    el("listSub").textContent = "A√ß√µes no menu ‚ãØ (editar, duplicar, ativar/desativar, excluir).";
  }

  renderList();
}

/* =======================
   LIST RENDER (compact row + kebab menu)
======================= */
function closeAllMenus(){
  document.querySelectorAll(".menu.open").forEach(m => m.classList.remove("open"));
}

document.addEventListener("click", (e)=>{
  // fecha menus ao clicar fora
  const isMenu = e.target.closest(".menu");
  const isKebab = e.target.closest(".kebab");
  if (!isMenu && !isKebab) closeAllMenus();
});

function renderList(){
  const tbody = el("tbody");
  const search = (el("search").value || "").trim().toLowerCase();

  let items = [];
  if (tab==="clientes") items = cache.clientes;
  if (tab==="categorias") items = cache.categorias;
  if (tab==="produtos") items = cache.produtos;

  // filtro simples
  if (search){
    items = items.filter(x => JSON.stringify(x).toLowerCase().includes(search));
  }

  // headers vari√°veis
  const thead = el("thead");
  if (tab==="clientes"){
    thead.innerHTML = `<div>Nome</div><div>Slug</div><div>WhatsApp</div><div>Status</div><div style="text-align:right">‚ãØ</div>`;
  }
  if (tab==="categorias"){
    thead.innerHTML = `<div>Nome</div><div>Cliente</div><div>Ordem</div><div>Status</div><div style="text-align:right">‚ãØ</div>`;
  }
  if (tab==="produtos"){
    thead.innerHTML = `<div>Nome</div><div>Cliente</div><div>Pre√ßo</div><div>Status</div><div style="text-align:right">‚ãØ</div>`;
  }

  if (!items.length){
    tbody.innerHTML = `<div class="trow"><div class="muted">Nada por aqui ainda‚Ä¶</div></div>`;
    return;
  }

  tbody.innerHTML = items.map(item => {
    const ativo = !!item.ativo;
    const chip = `<span class="chip ${ativo ? "ok":"off"}"><span class="dot"></span>${ativo ? "Ativo" : "Inativo"}</span>`;

    if (tab==="clientes"){
      const nome = item.nome || "‚Äî";
      const slug = item.slug || "‚Äî";
      const whats = item.whatsapp || "‚Äî";

      return `
        <div class="trow" data-id="${item.id}">
          <div class="cellSmall"><b>${escapeHtml(nome)}</b><div class="muted mono">${escapeHtml(item.id||"")}</div></div>
          <div class="cellSmall mono">${escapeHtml(slug)}</div>
          <div class="cellSmall mono">${escapeHtml(whats)}</div>
          <div>${chip}</div>
          <div style="display:flex; justify-content:flex-end">
            ${kebabMenuHtml("clientes", item)}
          </div>
        </div>`;
    }

    if (tab==="categorias"){
      const nome = item.nome || "‚Äî";
      const cliente = item.cliente_slug || "‚Äî";
      const ordem = item.ordem ?? 0;
      return `
        <div class="trow" data-id="${item.id}">
          <div class="cellSmall"><b>${escapeHtml(nome)}</b><div class="muted mono">${escapeHtml(item.id||"")}</div></div>
          <div class="cellSmall mono">${escapeHtml(cliente)}</div>
          <div class="cellSmall mono">${escapeHtml(String(ordem))}</div>
          <div>${chip}</div>
          <div style="display:flex; justify-content:flex-end">
            ${kebabMenuHtml("categorias", item)}
          </div>
        </div>`;
    }

    // produtos
    const nome = item.nome || "‚Äî";
    const cliente = item.cliente_slug || "‚Äî";
    const preco = money(item.preco || 0);
    return `
      <div class="trow" data-id="${item.id}">
        <div class="cellSmall"><b>${escapeHtml(nome)}</b><div class="muted mono">${escapeHtml(item.id||"")}</div></div>
        <div class="cellSmall mono">${escapeHtml(cliente)}</div>
        <div class="cellSmall mono">${escapeHtml(preco)}</div>
        <div>${chip}</div>
        <div style="display:flex; justify-content:flex-end">
          ${kebabMenuHtml("produtos", item)}
        </div>
      </div>`;
  }).join("");

  // bind menus
  bindMenus();
}

function kebabMenuHtml(kind, item){
  // kind: clientes/categorias/produtos
  const id = item.id;

  // Itens extra para cliente
  const clienteExtras = (kind==="clientes") ? `
    <button class="mitem" data-act="ver" data-kind="${kind}" data-id="${id}"><span class="ico">üëÅÔ∏è</span>Ver publicado</button>
    <button class="mitem" data-act="link" data-kind="${kind}" data-id="${id}"><span class="ico">üîó</span>Copiar link</button>
  ` : ``;

  return `
    <div class="kebab" data-kebab="${kind}" data-id="${id}">
      <span>‚ãØ</span>
      <div class="menu" id="menu-${kind}-${id}">
        ${clienteExtras}
        <button class="mitem" data-act="edit" data-kind="${kind}" data-id="${id}"><span class="ico">‚úèÔ∏è</span>Editar</button>
        <button class="mitem" data-act="dup" data-kind="${kind}" data-id="${id}"><span class="ico">üìÑ</span>Duplicar</button>
        <button class="mitem" data-act="toggle" data-kind="${kind}" data-id="${id}"><span class="ico">‚èª</span>${item.ativo ? "Desativar" : "Ativar"}</button>
        <button class="mitem danger" data-act="del" data-kind="${kind}" data-id="${id}"><span class="ico">üóëÔ∏è</span>Excluir</button>
      </div>
    </div>
  `;
}

function bindMenus(){
  document.querySelectorAll(".kebab").forEach(k => {
    k.addEventListener("click", (e)=>{
      e.stopPropagation();
      const kind = k.dataset.kebab;
      const id = k.dataset.id;
      const menu = document.getElementById(`menu-${kind}-${id}`);
      if (!menu) return;
      const isOpen = menu.classList.contains("open");
      closeAllMenus();
      if (!isOpen) menu.classList.add("open");
    });
  });

  document.querySelectorAll(".mitem").forEach(btn=>{
    btn.addEventListener("click", async (e)=>{
      e.stopPropagation();
      closeAllMenus();
      const act = btn.dataset.act;
      const kind = btn.dataset.kind;
      const id = btn.dataset.id;

      await handleAction(kind, act, id);
    });
  });
}

function escapeHtml(str){
  return String(str ?? "").replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

/* =======================
   ACTIONS
======================= */
function findById(kind, id){
  const arr = cache[kind] || [];
  return arr.find(x => String(x.id) === String(id));
}

async function handleAction(kind, act, id){
  const item = findById(kind, id);
  if (!item) return;

  if (act === "ver" && kind==="clientes"){
    const url = `${window.location.origin.replace(/\/admin\/?$/,"/")}?u=${encodeURIComponent(item.slug)}`;
    window.open(url, "_blank");
    return;
  }

  if (act === "link" && kind==="clientes"){
    const url = `${window.location.origin.replace(/\/admin\/?$/,"/")}?u=${encodeURIComponent(item.slug)}`;
    await navigator.clipboard.writeText(url);
    toast("Link copiado!");
    return;
  }

  if (act === "edit"){
    editing[kind] = item;
    toast("Editando: " + (item.nome || item.slug || item.id));
    setTab(kind); // garante que o form certo aparece

    if (kind==="clientes"){
      el("c_nome").value = item.nome || "";
      el("c_slug").value = item.slug || "";
      el("c_whats").value = item.whatsapp || "";
      el("c_ativo").value = String(!!item.ativo);
      el("formTitle").textContent = "Editar Cliente";
    }
    if (kind==="categorias"){
      el("cat_cliente").value = item.cliente_slug || "";
      el("cat_nome").value = item.nome || "";
      el("cat_ordem").value = item.ordem ?? 0;
      el("cat_ativo").value = String(!!item.ativo);
      el("formTitle").textContent = "Editar Categoria";
    }
    if (kind==="produtos"){
      el("p_cliente").value = item.cliente_slug || "";
      updateCategoriasForProduto();
      el("p_categoria").value = item.categoria_id || "";
      el("p_nome").value = item.nome || "";
      el("p_desc").value = item.descricao || "";
      el("p_preco").value = item.preco ?? 0;
      el("p_img").value = item.imagem_url || "";
      el("p_ativo").value = String(!!item.ativo);
      el("formTitle").textContent = "Editar Produto";
    }
    return;
  }

  if (act === "dup"){
    if (!confirm("Duplicar este item?")) return;

    if (kind==="clientes"){
      // duplica mudando slug
      const newSlug = (item.slug || "novo") + "-copia";
      await api("/api/admin/clientes", {
        method:"POST",
        body: JSON.stringify({
          nome: (item.nome || "Cliente") + " (C√≥pia)",
          slug: newSlug,
          whatsapp: item.whatsapp || "",
          ativo: item.ativo ?? true
        })
      });
      toast("Cliente duplicado!");
      await loadAll();
      return;
    }

    if (kind==="categorias"){
      await api("/api/admin/categorias", {
        method:"POST",
        body: JSON.stringify({
          cliente_slug: item.cliente_slug,
          nome: (item.nome || "Categoria") + " (C√≥pia)",
          ordem: (item.ordem ?? 0) + 1,
          ativo: item.ativo ?? true
        })
      });
      toast("Categoria duplicada!");
      await loadAll();
      return;
    }

    if (kind==="produtos"){
      await api("/api/admin/produtos", {
        method:"POST",
        body: JSON.stringify({
          cliente_slug: item.cliente_slug,
          categoria_id: item.categoria_id,
          nome: (item.nome || "Produto") + " (C√≥pia)",
          descricao: item.descricao || "",
          preco: item.preco ?? 0,
          imagem_url: item.imagem_url || "",
          ativo: item.ativo ?? true
        })
      });
      toast("Produto duplicado!");
      await loadAll();
      return;
    }
  }

  if (act === "toggle"){
    const next = !item.ativo;
    const endpoint = kind==="clientes" ? "/api/admin/clientes"
      : kind==="categorias" ? "/api/admin/categorias"
      : "/api/admin/produtos";

    await api(endpoint, {
      method:"PATCH",
      body: JSON.stringify({ id: item.id, ativo: next })
    });

    toast(next ? "Ativado!" : "Desativado!");
    await loadAll();
    return;
  }

  if (act === "del"){
    if (!confirm("Tem certeza que deseja excluir?")) return;
    const endpoint = kind==="clientes" ? "/api/admin/clientes"
      : kind==="categorias" ? "/api/admin/categorias"
      : "/api/admin/produtos";

    await api(`${endpoint}?id=${encodeURIComponent(item.id)}`, { method:"DELETE" });
    toast("Exclu√≠do.");
    await loadAll();
    return;
  }
}

/* =======================
   SAVE (FORMS)
======================= */
async function salvarCliente(){
  try{
    const payload = {
      nome: el("c_nome").value.trim(),
      slug: el("c_slug").value.trim(),
      whatsapp: el("c_whats").value.trim(),
      ativo: el("c_ativo").value === "true",
    };

    if (!payload.nome || !payload.slug) return toast("Nome e slug s√£o obrigat√≥rios.", "err");

    if (editing.clientes){
      await api("/api/admin/clientes", { method:"PATCH", body: JSON.stringify({ id: editing.clientes.id, ...payload }) });
      toast("Cliente atualizado!");
    } else {
      await api("/api/admin/clientes", { method:"POST", body: JSON.stringify(payload) });
      toast("Cliente criado!");
    }

    editing.clientes = null;
    el("c_nome").value = ""; el("c_slug").value = ""; el("c_whats").value = "";
    el("c_ativo").value = "true";
    await loadAll();
  } catch(e){
    diag("Salvar cliente: "+e.message, false);
    toast(e.message, "err");
  }
}

async function salvarCategoria(){
  try{
    const payload = {
      cliente_slug: el("cat_cliente").value,
      nome: el("cat_nome").value.trim(),
      ordem: Number(el("cat_ordem").value || 0),
      ativo: el("cat_ativo").value === "true",
    };

    if (!payload.cliente_slug || !payload.nome) return toast("Cliente e nome s√£o obrigat√≥rios.", "err");

    if (editing.categorias){
      await api("/api/admin/categorias", { method:"PATCH", body: JSON.stringify({ id: editing.categorias.id, ...payload }) });
      toast("Categoria atualizada!");
    } else {
      await api("/api/admin/categorias", { method:"POST", body: JSON.stringify(payload) });
      toast("Categoria criada!");
    }

    editing.categorias = null;
    el("cat_nome").value = ""; el("cat_ordem").value = "";
    el("cat_ativo").value = "true";
    await loadAll();
  } catch(e){
    diag("Salvar categoria: "+e.message, false);
    toast(e.message, "err");
  }
}

async function salvarProduto(){
  try{
    const payload = {
      cliente_slug: el("p_cliente").value,
      categoria_id: el("p_categoria").value ? Number(el("p_categoria").value) : null,
      nome: el("p_nome").value.trim(),
      descricao: el("p_desc").value.trim(),
      preco: Number(el("p_preco").value || 0),
      imagem_url: el("p_img").value.trim(),
      ativo: el("p_ativo").value === "true",
    };

    if (!payload.cliente_slug || !payload.categoria_id || !payload.nome)
      return toast("Cliente, categoria e nome s√£o obrigat√≥rios.", "err");

    if (editing.produtos){
      await api("/api/admin/produtos", { method:"PATCH", body: JSON.stringify({ id: editing.produtos.id, ...payload }) });
      toast("Produto atualizado!");
    } else {
      await api("/api/admin/produtos", { method:"POST", body: JSON.stringify(payload) });
      toast("Produto criado!");
    }

    editing.produtos = null;
    el("p_nome").value = ""; el("p_desc").value=""; el("p_preco").value="";
    el("p_img").value=""; el("p_ativo").value="true";
    await loadAll();
  } catch(e){
    diag("Salvar produto: "+e.message, false);
    toast(e.message, "err");
  }
}

/* =======================
   EVENTS
======================= */
document.querySelectorAll(".tab").forEach(b=>{
  b.addEventListener("click", ()=> setTab(b.dataset.tab));
});

el("btnLogin").addEventListener("click", loginWithPassword);
el("btnGoogle").addEventListener("click", loginWithGoogle);
el("btnLogout").addEventListener("click", logout);

el("btnSalvarCliente").addEventListener("click", salvarCliente);
el("btnSalvarCategoria").addEventListener("click", salvarCategoria);
el("btnSalvarProduto").addEventListener("click", salvarProduto);

el("btnReload").addEventListener("click", loadAll);
el("search").addEventListener("input", ()=> renderList());

el("p_cliente").addEventListener("change", ()=>{
  updateCategoriasForProduto();
});

/* =======================
   INIT
======================= */
(function init(){
  // tenta pegar API base via querystring ?api=https://...
  const qs = new URLSearchParams(location.search);
  const apiQ = qs.get("api");
  if (apiQ) API_BASE = apiQ;

  diag("UI iniciada. API_BASE=" + API_BASE);
  refreshSessionUI();
})();
</script>
</body>
</html>
