<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Alfa ‚Ä¢ Portal da Chapada</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#0a0f18;
      --card: rgba(0,0,0,.25);
      --bd: rgba(255,255,255,.10);
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --y:#f1c40f;
      --ok:#2ecc71;
      --bad:#e74c3c;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--txt);
      background: radial-gradient(1200px 600px at 10% 10%, rgba(241,196,15,.12), transparent 60%),
                  radial-gradient(900px 500px at 80% 30%, rgba(46,204,113,.08), transparent 55%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
      overflow-x:hidden;
    }

    /* ===== Layout ===== */
    .wrap{max-width:1180px;margin:0 auto;padding:22px}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding:14px 16px;border:1px solid var(--bd);border-radius:18px;background:rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .brand .logo{
      width:46px;height:46px;border-radius:14px;overflow:hidden;
      border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);
      display:flex;align-items:center;justify-content:center;
    }
    .brand .logo img{width:100%;height:100%;object-fit:cover}
    .brand h1{font-size:16px;margin:0;line-height:1.2}
    .brand p{margin:0;font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:520px}

    .row{display:flex;align-items:center;gap:10px}
    .btn{
      cursor:pointer;border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--txt);
      padding:10px 12px;border-radius:12px;
      font-weight:650;font-size:13px;
      display:inline-flex;align-items:center;gap:8px;
    }
    .btn:hover{background:rgba(255,255,255,.09)}
    .btn.y{background:rgba(241,196,15,.95);color:#101010;border-color:rgba(241,196,15,.55)}
    .btn.y:hover{background:rgba(241,196,15,1)}
    .btn.small{padding:8px 10px;font-size:12px;border-radius:10px}

    .tabs{
      display:flex;gap:8px;flex-wrap:wrap;margin:14px 0 0;
    }
    .tab{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--txt);
      padding:8px 12px;border-radius:999px;
      font-weight:750;font-size:12px;
    }
    .tab.active{
      background:rgba(241,196,15,.18);
      border-color:rgba(241,196,15,.45);
    }

    .listWrap{
      margin-top:14px;
      border:1px solid var(--bd);
      border-radius:18px;
      background:rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
      padding:14px;
    }
    .listTop{
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
      margin-bottom:10px;
    }
    .ttl{font-weight:850;font-size:14px}
    .meta{color:var(--muted);font-size:12px}
    .link{color:var(--y);text-decoration:none}
    .link:hover{text-decoration:underline}

    .items{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:12px;
    }
    @media (max-width: 1100px){ .items{grid-template-columns: repeat(3, 1fr)} }
    @media (max-width: 820px){ .items{grid-template-columns: repeat(2, 1fr)} }
    @media (max-width: 520px){ .items{grid-template-columns: 1fr} }

    .item{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      border-radius:16px;
      padding:12px;
      min-width:0;
    }

    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.15);
      font-size:12px;
      color:var(--txt);
    }
    .pill.ok{background:rgba(46,204,113,.18)}
    .pill.warn{background:rgba(241,196,15,.18)}
    .pill.bad{background:rgba(231,76,60,.18)}

    .empty{
      opacity:.75;
      padding:14px;
      border:1px dashed rgba(255,255,255,.12);
      border-radius:14px;
    }

    /* ===== Aprova√ß√£o ===== */
    .aprovList{display:flex;flex-direction:column;gap:10px}
    .aprovItem{
      display:flex;justify-content:space-between;gap:12px;align-items:flex-start;
      padding:12px;border:1px solid rgba(255,255,255,.08);border-radius:12px;background:rgba(0,0,0,.18)
    }

    /* ===== Login (central + logo grande) ===== */
    #login{min-height:100vh}
    .loginWrap{
      min-height:100vh;width:100%;
      display:flex;flex-direction:column;
      align-items:center;justify-content:center;
      gap:18px;padding:28px;
    }
    .loginHeroLogo img{
      width:190px;max-width:70vw;height:auto;display:block;
      filter:drop-shadow(0 10px 25px rgba(0,0,0,.35));
    }
    .loginCard{
      width:min(420px,92vw);
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:18px 18px 16px;
      backdrop-filter: blur(10px);
    }
    .loginCard h2{margin:0 0 6px}
    .loginCard p{margin:0 0 12px;color:var(--muted);font-size:12px}
    .loginForm{margin-top:10px;text-align:left}
    .loginForm label{font-size:12px;color:var(--muted)}
    input{
      width:100%;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      border-radius:12px;
      padding:10px 12px;
      color:var(--txt);
      outline:none;
      font-size:13px;
    }
    .sp10{height:10px}
    .loginActions{justify-content:center;margin-top:14px;gap:10px}
    .btn.gIcon{
      width:44px;min-width:44px;height:40px;padding:0;border-radius:12px;
      display:flex;align-items:center;justify-content:center
    }
    .gMark{font-weight:900;font-size:18px;line-height:1;letter-spacing:-1px}
    .msg{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.25);font-size:13px}
    .msg.err{border-color:rgba(231,76,60,.35)}

    /* ===== Modal bonitinho ===== */
    .modalBack{
      position:fixed;inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .modal{
      width:min(720px, 96vw);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      background:rgba(0,0,0,.75);
      backdrop-filter: blur(10px);
      overflow:hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
    }
    .modalHead{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
    }
    .modalHead .title{font-weight:900}
    .modalHead .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .x{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--txt);
      width:38px;height:38px;border-radius:12px;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;
    }
    .x:hover{background:rgba(255,255,255,.09)}
    .modalBody{padding:14px 16px}
    .formGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 760px){
      .formGrid{grid-template-columns:1fr}
    }
    .field{display:flex;flex-direction:column;gap:6px;min-width:0}
    .field label{font-size:12px;color:var(--muted)}
    .field input, .field select{
      width:100%;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      border-radius:12px;
      padding:10px 12px;
      color:var(--txt);
      outline:none;
      font-size:13px;
    }
    .row2{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .toggle{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      border-radius:12px;
    }
    .toggle input{width:18px;height:18px}
    .preview{
      display:flex;gap:12px;align-items:center;
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      border-radius:12px;
    }
    .prevImg{
      width:54px;height:54px;border-radius:14px;
      overflow:hidden;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      display:flex;align-items:center;justify-content:center;
      flex:0 0 auto;
    }
    .prevImg img{width:100%;height:100%;object-fit:cover}
    .modalFoot{
      display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap;
      padding:14px 16px;
      border-top:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
    }
    .hint{font-size:12px;color:var(--muted)}
  </style>
</head>

<body>

<!-- LOGIN -->
<div id="login">
  <div class="loginWrap">
    <div class="loginHeroLogo">
      <img src="../logo.png" alt="Logo"
           onerror="this.style.display='none';document.getElementById('loginHeroFallback').style.display='block';" />
      <div id="loginHeroFallback" style="display:none;font-weight:800;font-size:28px;letter-spacing:.5px;">Admin Alfa</div>
    </div>

    <div class="loginCard">
      <h2>Entrar</h2>
      <p>Email/senha do Supabase Auth ou Google.</p>

      <div class="loginForm">
        <label>Email</label>
        <input id="email" placeholder="seu@email.com" />
        <div class="sp10"></div>
        <label>Senha</label>
        <input id="senha" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      </div>

      <div class="row loginActions">
        <button class="btn y" id="btnLogin">üîí Entrar</button>
        <button class="btn gIcon" id="btnGoogle" title="Entrar com Google" aria-label="Entrar com Google">
          <span class="gMark">G</span>
        </button>
      </div>

      <div id="loginMsg" class="msg err" style="display:none;margin-top:12px"></div>
    </div>
  </div>
</div>

<!-- APP -->
<div class="wrap" id="app" style="display:none">

  <div class="top">
    <div class="brand">
      <div class="logo">
        <img src="../logo.png" onerror="this.style.display='none';this.parentElement.textContent='ADM'">
      </div>
      <div style="min-width:0">
        <h1>Admin Alfa</h1>
        <p>Gerencie clientes e aprova√ß√µes.</p>
      </div>
    </div>

    <div class="row">
      <button class="btn" id="btnReload">üîÑ Recarregar</button>
      <button class="btn y" id="btnLogout">üö™ Sair</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="clientes">Clientes</button>
    <button class="tab" data-tab="cadastros">Cadastros</button>
  </div>

  <div class="listWrap">
    <div class="listTop">
      <div>
        <div class="ttl" id="listTitle">Clientes</div>
        <div class="meta" id="listSubtitle">Editar dados + gerar link de senha.</div>
      </div>
      <input id="search" placeholder="Buscar..." style="min-width:240px">
    </div>

    <div class="items" id="list"></div>
  </div>

</div>

<!-- MODAL EDITAR CLIENTE -->
<div class="modalBack" id="modalBack" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mTitle">
    <div class="modalHead">
      <div>
        <div class="title" id="mTitle">Editar cliente</div>
        <div class="sub" id="mSub">Atualize os dados do neg√≥cio.</div>
      </div>
      <button class="x" id="btnCloseModal" title="Fechar">‚úï</button>
    </div>

    <div class="modalBody">
      <div class="hint" style="margin-bottom:10px;">
        ‚ö†Ô∏è Senha n√£o √© vis√≠vel. Para acesso use <strong>Link de senha</strong>.
      </div>

      <div class="formGrid">
        <div class="field" style="grid-column:1/-1">
          <label>Slug (n√£o edita)</label>
          <input id="m_slug" disabled />
        </div>

        <div class="field">
          <label>Nome</label>
          <input id="m_nome" />
        </div>

        <div class="field">
          <label>WhatsApp</label>
          <input id="m_whatsapp" placeholder="6299..." />
        </div>

        <div class="field">
          <label>Email (login)</label>
          <input id="m_email" placeholder="cliente@email.com" />
        </div>

        <div class="field">
          <label>Instagram</label>
          <input id="m_instagram" placeholder="sem @" />
        </div>

        <div class="field">
          <label>Cidade</label>
          <input id="m_cidade" placeholder="Ex: Cavalcante" />
        </div>

        <div class="field">
          <label>Tipo de neg√≥cio</label>
          <input id="m_tipo_negocio" placeholder="Ex: mercado, pousada..." />
        </div>

        <div class="field" style="grid-column:1/-1">
          <label>Endere√ßo</label>
          <input id="m_endereco" placeholder="Rua, n√∫mero, bairro..." />
        </div>

        <div class="field" style="grid-column:1/-1">
          <label>Logo URL (opcional)</label>
          <input id="m_logo_url" placeholder="https://.../logo.png" />
        </div>

        <div class="field" style="grid-column:1/-1">
          <div class="row2">
            <div class="toggle">
              <input type="checkbox" id="m_ativo" />
              <label for="m_ativo" style="margin:0;color:var(--txt)">Ativo (publicado)</label>
            </div>

            <div class="preview" style="flex:1;min-width:220px">
              <div class="prevImg"><img id="m_logo_prev" alt="logo preview" /></div>
              <div style="min-width:0">
                <div class="ttl" style="font-size:13px;margin-bottom:2px">Preview</div>
                <div class="meta" id="m_logo_text">Sem logo</div>
              </div>
            </div>

            <button class="btn small" id="btnLinkSenhaModal">üîë Link de senha</button>
          </div>
        </div>
      </div>

      <div id="modalMsg" class="msg err" style="display:none;margin-top:12px"></div>
    </div>

    <div class="modalFoot">
      <button class="btn" id="btnCancel">Cancelar</button>
      <button class="btn y" id="btnSave">Salvar</button>
    </div>
  </div>
</div>

<script>
  // ===== CONFIG (seus dados) =====
  const SUPABASE_URL = "https://rgsnmxspyywwouhcdwkj.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJnc25teHNweXl3d291aGNkd2tqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MzI3NzIsImV4cCI6MjA4MzUwODc3Mn0.dxj35rJ_g_952_VvwV4mjFraB1b0BLdsxHw_wYiQNQI";

  const API_BASE = "https://cafeteria-gamma-orpin.vercel.app/api";

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  let session = null;

  let tab = "clientes";
  let clientes = [];
  let cadastros = [];
  let editingSlug = null;

  function el(id){ return document.getElementById(id); }
  function show(id){ el(id).style.display="block"; }
  function hide(id){ el(id).style.display="none"; }

  function escapeHtml(str){
    return String(str ?? "")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  async function apiFetch(path, options = {}){
    const token = session?.access_token;
    const headers = {
      "Content-Type": "application/json",
      ...(options.headers || {})
    };
    if (token) headers["Authorization"] = "Bearer " + token;

    const res = await fetch(API_BASE + path, { ...options, headers });
    const json = await res.json().catch(()=> ({}));
    if (!res.ok) throw new Error(json.error || ("HTTP " + res.status));
    return json;
  }

  // ===== AUTH =====
  async function signInEmail(){
    const email = el("email").value.trim();
    const password = el("senha").value;
    const box = el("loginMsg");
    box.style.display="none";

    const { data, error } = await sb.auth.signInWithPassword({ email, password });
    if(error){
      box.style.display="block";
      box.textContent = error.message;
      return;
    }
    session = data.session;
    await afterLogin();
  }

  async function signInGoogle(){
    const box = el("loginMsg");
    box.style.display="none";

    const { error } = await sb.auth.signInWithOAuth({
      provider: "google",
      options: { redirectTo: window.location.href }
    });
    if(error){
      box.style.display="block";
      box.textContent = error.message;
    }
  }

  async function logout(){
    await sb.auth.signOut();
    session = null;
    hide("app");
    show("login");
  }

  // ===== LOAD =====
  async function loadAll(){
    const data = await apiFetch("/admin/listar");
    clientes = data.clientes || [];
    cadastros = data.cadastros || [];
    renderList();
  }

  // ===== RENDER =====
  function renderClientes(q){
    el("listTitle").textContent = "Clientes";
    el("listSubtitle").textContent = "Editar dados + gerar link de senha.";

    let list = clientes.slice();
    if (q) list = list.filter(x =>
      (x.nome||"").toLowerCase().includes(q) ||
      (x.slug||"").toLowerCase().includes(q) ||
      (x.email||"").toLowerCase().includes(q)
    );

    if(!list.length){
      el("list").innerHTML = `<div class="empty">Nenhum cliente encontrado.</div>`;
      return;
    }

    el("list").innerHTML = list.map(c=>{
      const ativoPill = c.ativo ? `<span class="pill ok">Ativo</span>` : `<span class="pill bad">Inativo</span>`;
      const email = c.email ? escapeHtml(c.email) : "‚Äî";
      return `
        <div class="item">
          <div class="ttl">${escapeHtml(c.nome||"‚Äî")}</div>
          <div class="meta">${escapeHtml(c.slug||"")} ‚Ä¢ ${escapeHtml(c.cidade||"")}</div>

          <div class="meta" style="margin-top:8px">
            ${ativoPill}
            <span class="pill warn">${escapeHtml(c.tipo_negocio||c.tipo||"")}</span>
          </div>

          <div class="meta" style="margin-top:8px">Email: <strong>${email}</strong></div>

          <div class="row" style="margin-top:10px;flex-wrap:wrap">
            <button class="btn small" onclick="openEdit('${escapeHtml(c.slug)}')">‚úèÔ∏è Editar</button>
            <button class="btn y small" onclick="resetSenhaCliente('${escapeHtml(c.email||"")}')">üîë Link de senha</button>
          </div>
        </div>
      `;
    }).join("");
  }

  function renderCadastros(q){
    el("listTitle").textContent = "Cadastros (aprova√ß√£o)";
    el("listSubtitle").textContent = "Aprovar cria usu√°rio Auth e gera link de senha.";

    let rows = cadastros.slice();
    if(q){
      rows = rows.filter(r=>{
        const blob = [r.nome_negocio,r.cidade,r.categoria,r.whatsapp,r.email,r.instagram,r.endereco,r.mensagem,r.status]
          .filter(Boolean).join(" ").toLowerCase();
        return blob.includes(q);
      });
    }

    if(!rows.length){
      el("list").innerHTML = `<div class="empty">Nenhum cadastro encontrado.</div>`;
      return;
    }

    el("list").innerHTML = `<div class="aprovList">` + rows.map(r=>{
      const st = String(r.status||"pendente").toLowerCase();
      const badge = st==="pendente" ? `<span class="pill warn">Pendente</span>` : st==="aprovado" ? `<span class="pill ok">Aprovado</span>` : `<span class="pill bad">Rejeitado</span>`;
      const when = r.created_at ? new Date(r.created_at).toLocaleString() : "";
      return `
        <div class="aprovItem">
          <div>
            <div class="row" style="gap:10px;align-items:center;flex-wrap:wrap">
              <div class="ttl">${escapeHtml(r.nome_negocio||"‚Äî")}</div>
              ${badge}
            </div>
            <div class="meta">${escapeHtml(r.cidade||"‚Äî")} ‚Ä¢ ${escapeHtml(r.categoria||"‚Äî")} ‚Ä¢ ${escapeHtml(r.whatsapp||"‚Äî")}</div>
            <div class="meta">${when}${r.email ? " ‚Ä¢ "+escapeHtml(r.email) : ""}${r.instagram ? " ‚Ä¢ @"+escapeHtml(r.instagram) : ""}</div>
            ${r.endereco ? `<div class="meta"><strong>Endere√ßo:</strong> ${escapeHtml(r.endereco)}</div>` : ``}
            ${r.mensagem ? `<div class="meta"><strong>Mensagem:</strong> ${escapeHtml(r.mensagem)}</div>` : ``}
          </div>

          <div class="row" style="gap:10px;flex-wrap:wrap;justify-content:flex-end">
            ${st==="pendente" ? `<button class="btn y small" onclick="aprovarCadastro('${r.id}')">Aprovar</button>` : ``}
          </div>
        </div>
      `;
    }).join("") + `</div>`;
  }

  function renderList(){
    const q = (el("search").value||"").trim().toLowerCase();
    if(tab==="clientes") return renderClientes(q);
    if(tab==="cadastros") return renderCadastros(q);
  }

  // ===== ACTIONS =====
  async function aprovarCadastro(id){
    try{
      const resp = await apiFetch("/admin/aprovar-cadastro", {
        method:"POST",
        body: JSON.stringify({ cadastro_id: id })
      });
      if(resp.recovery_link){
        alert("‚úÖ Aprovado!\n\nLink de senha:\n\n" + resp.recovery_link);
      }else{
        alert("‚úÖ Aprovado!");
      }
      await loadAll();
    }catch(e){
      alert("Falha ao aprovar: " + (e?.message || e));
    }
  }
  window.aprovarCadastro = aprovarCadastro;

  async function resetSenhaCliente(email){
    const em = (email||"").trim();
    const alvo = em || prompt("Email do cliente:", "");
    if(!alvo) return;

    try{
      const resp = await apiFetch("/admin/reset-senha", {
        method:"POST",
        body: JSON.stringify({ email: alvo })
      });
      alert("üîë Link de senha:\n\n" + (resp.recovery_link || "(sem link)"));
    }catch(e){
      alert("Falha ao gerar link: " + (e?.message || e));
    }
  }
  window.resetSenhaCliente = resetSenhaCliente;

  // ===== MODAL =====
  function setModalMsg(msg){
    const box = el("modalMsg");
    if(!msg){
      box.style.display="none";
      box.textContent="";
      return;
    }
    box.style.display="block";
    box.textContent=msg;
  }

  function updateLogoPreview(){
    const url = el("m_logo_url").value.trim();
    const img = el("m_logo_prev");
    const txt = el("m_logo_text");

    if(!url){
      img.style.display="none";
      txt.textContent="Sem logo";
      return;
    }
    img.style.display="block";
    img.src = url;
    txt.textContent=url;
    img.onerror = ()=>{
      img.style.display="none";
      txt.textContent="URL inv√°lida (n√£o carregou)";
    };
  }

  function openModal(){
    el("modalBack").style.display="flex";
    el("modalBack").setAttribute("aria-hidden","false");
    setModalMsg("");
  }
  function closeModal(){
    el("modalBack").style.display="none";
    el("modalBack").setAttribute("aria-hidden","true");
    editingSlug = null;
    setModalMsg("");
  }

  function openEdit(slug){
    const c = clientes.find(x => x.slug === slug);
    if(!c) return alert("Cliente n√£o encontrado.");

    editingSlug = slug;

    el("m_slug").value = c.slug || "";
    el("m_nome").value = c.nome || "";
    el("m_whatsapp").value = c.whatsapp || "";
    el("m_email").value = c.email || "";
    el("m_instagram").value = c.instagram || "";
    el("m_cidade").value = c.cidade || "";
    el("m_tipo_negocio").value = c.tipo_negocio || c.tipo || "";
    el("m_endereco").value = c.endereco || "";
    el("m_logo_url").value = c.logo_url || "";
    el("m_ativo").checked = !!c.ativo;

    el("mTitle").textContent = "Editar cliente";
    el("mSub").textContent = `${c.nome || "Cliente"} ‚Ä¢ ${c.slug}`;

    updateLogoPreview();
    openModal();
  }
  window.openEdit = openEdit;

  async function saveEdit(){
    if(!editingSlug) return;

    const payload = {
      slug: editingSlug,
      nome: el("m_nome").value.trim(),
      whatsapp: el("m_whatsapp").value.trim(),
      email: el("m_email").value.trim().toLowerCase(),
      instagram: el("m_instagram").value.trim().replace(/^@+/, ""),
      cidade: el("m_cidade").value.trim(),
      tipo_negocio: el("m_tipo_negocio").value.trim(),
      endereco: el("m_endereco").value.trim(),
      logo_url: el("m_logo_url").value.trim(),
      ativo: el("m_ativo").checked
    };

    if(!payload.nome) return setModalMsg("Preencha o nome.");
    if(!payload.whatsapp) return setModalMsg("Preencha o WhatsApp.");
    if(!payload.email) return setModalMsg("Preencha o email.");

    try{
      setModalMsg("");
      el("btnSave").disabled = true;

      const resp = await apiFetch("/admin/editar-cliente", {
        method:"POST",
        body: JSON.stringify(payload)
      });

      if(resp.authEmailUpdated){
        alert("‚úÖ Cliente atualizado!\n\nEmail tamb√©m foi sincronizado no Auth.");
      }else{
        alert("‚úÖ Cliente atualizado!");
      }

      await loadAll();
      closeModal();
    }catch(e){
      setModalMsg("Erro ao salvar: " + (e?.message || e));
    }finally{
      el("btnSave").disabled = false;
    }
  }

  // fecha clicando fora
  el("modalBack").addEventListener("click", (e)=>{
    if(e.target === el("modalBack")) closeModal();
  });

  // ===== UI binds =====
  document.querySelectorAll(".tab").forEach(b=>{
    b.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      tab = b.dataset.tab;
      renderList();
    });
  });

  el("search").addEventListener("input", renderList);

  el("btnLogin").onclick = signInEmail;
  el("btnGoogle").onclick = signInGoogle;
  el("btnLogout").onclick = logout;
  el("btnReload").onclick = async ()=>{ await loadAll(); };

  el("btnCloseModal").onclick = closeModal;
  el("btnCancel").onclick = closeModal;
  el("btnSave").onclick = saveEdit;

  el("m_logo_url").addEventListener("input", updateLogoPreview);
  el("btnLinkSenhaModal").onclick = ()=>{
    const email = el("m_email").value.trim();
    if(!email) return setModalMsg("Preencha o email para gerar link de senha.");
    resetSenhaCliente(email);
  };

  // Boot
  (async ()=>{
    const { data } = await sb.auth.getSession();
    session = data.session;

    if (session){
      hide("login"); show("app");
      await loadAll();
    }else{
      show("login"); hide("app");
    }

    sb.auth.onAuthStateChange(async (_event, s)=>{
      session = s;
      if(session){
        hide("login"); show("app");
        await loadAll();
      }
    });

    // ESC fecha modal
    window.addEventListener("keydown", (e)=>{
      if(e.key === "Escape" && el("modalBack").style.display === "flex"){
        closeModal();
      }
    });
  })();
</script>

</body>
</html>
