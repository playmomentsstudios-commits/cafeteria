<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Alfa ‚Äî Card√°pio Digital</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0b1320;
      --card:#ffffff;
      --muted:#6b7280;
      --text:#0f172a;
      --line:#e5e7eb;
      --brand:#2563eb;
      --brand2:#1d4ed8;
      --danger:#ef4444;
      --shadow: 0 24px 70px rgba(0,0,0,.18);
      --radius: 18px;
      --radius2: 14px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font);
      background: radial-gradient(900px 600px at 20% 10%, rgba(37,99,235,.18), transparent 55%),
                  radial-gradient(900px 600px at 90% 20%, rgba(34,197,94,.12), transparent 55%),
                  linear-gradient(180deg, #07101c, #0b1320);
      color:#e5e7eb;
      min-height:100vh;
      padding: 28px 16px 60px;
    }
    .wrap{max-width:1100px; margin:0 auto}
    .hidden{display:none!important}

    /* LOGIN (estilo iFood, card branco) */
    .loginShell{display:grid; place-items:center; min-height: calc(100vh - 120px);}
    .loginCard{
      width:min(920px, 100%);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 26px;
      box-shadow: 0 40px 120px rgba(0,0,0,.45);
      backdrop-filter: blur(12px);
      padding: 22px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
    }
    .loginLeft{
      background: rgba(255,255,255,.06);
      border: 1px dashed rgba(255,255,255,.20);
      border-radius: 22px;
      padding: 22px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      justify-content:center;
    }
    .logo{
      width:88px; height:88px; border-radius: 24px;
      background: linear-gradient(135deg, rgba(37,99,235,.35), rgba(34,197,94,.18));
      border: 1px solid rgba(255,255,255,.18);
      display:grid; place-items:center;
      font-weight:900; letter-spacing:1px;
    }
    .loginLeft h1{margin:0; font-size:28px}
    .loginLeft p{margin:0; color:rgba(229,231,235,.78); line-height:1.35}

    .loginRight{
      background: #fff;
      border-radius: 22px;
      padding: 26px;
      color: var(--text);
      box-shadow: var(--shadow);
    }
    .loginRight h2{margin:0 0 6px; font-size:22px}
    .loginRight .sub{margin:0 0 16px; color:var(--muted); font-size:14px}
    label{display:block; font-weight:800; font-size:13px; margin:10px 0 6px}
    input{
      width:100%;
      padding: 12px 12px;
      border: 1px solid var(--line);
      border-radius: 12px;
      outline:none;
      font-size: 14px;
    }
    input:focus{border-color: rgba(37,99,235,.55); box-shadow: 0 0 0 4px rgba(37,99,235,.12);}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top: 14px}

    .btn{
      cursor:pointer;
      border:none;
      padding: 12px 14px;
      border-radius: 12px;
      font-weight:900;
      display:inline-flex; gap:10px; align-items:center; justify-content:center;
      transition: transform .12s ease, filter .12s ease;
      user-select:none;
    }
    .btn:active{transform: translateY(1px)}
    .btn.primary{background: linear-gradient(135deg, var(--brand), var(--brand2)); color:#fff; flex:1}
    .btn.ghost{background:#fff; border:1px solid var(--line); color:#111827; flex:1}
    .btn.danger{background: var(--danger); color:#fff}
    .msg{margin-top:12px; font-weight:800; font-size:13px}
    .msg.err{color:#b91c1c}
    .msg.ok{color:#065f46}

    /* APP */
    .app{
      margin-top: 18px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 22px;
      padding: 16px;
      backdrop-filter: blur(12px);
      box-shadow: 0 40px 120px rgba(0,0,0,.35);
    }
    .top{
      display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;
      padding: 10px 12px;
    }
    .top .who{
      color:rgba(229,231,235,.80);
      font-size:13px;
    }
    .tabs{
      display:flex; gap:10px; flex-wrap:wrap;
      padding: 0 12px 12px;
    }
    .tab{
      cursor:pointer;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      color:#e5e7eb;
      font-weight:900;
    }
    .tab.active{
      background: rgba(37,99,235,.22);
      border-color: rgba(37,99,235,.35);
    }

    .panel{
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      padding: 14px;
      margin: 0 12px 14px;
    }
    .panel h3{margin:0 0 10px}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    .grid3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px}
    .field label{color:rgba(229,231,235,.85)}
    .field input, .field select, .field textarea{
      background: rgba(255,255,255,.06);
      color:#e5e7eb;
      border: 1px solid rgba(255,255,255,.16);
      border-radius: 12px;
      padding: 12px;
      width:100%;
      outline:none;
    }
    .field textarea{min-height:84px}
    .list{
      margin-top: 12px;
      border-radius: 16px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.12);
    }
    .headRow, .itemRow{
      display:grid;
      grid-template-columns: 2fr 1.3fr 1.2fr 120px;
      gap: 10px;
      align-items:center;
      padding: 10px 12px;
    }
    .headRow{
      background: rgba(255,255,255,.06);
      font-weight:900;
      color: rgba(229,231,235,.72);
      font-size: 12px;
    }
    .itemRow{
      background: rgba(0,0,0,.14);
      border-top: 1px solid rgba(255,255,255,.08);
    }
    .pill{
      display:inline-flex;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight:900;
      font-size: 12px;
      background: rgba(34,197,94,.16);
      border: 1px solid rgba(34,197,94,.30);
      justify-content:center;
      width: fit-content;
    }
    .pill.off{
      background: rgba(239,68,68,.16);
      border-color: rgba(239,68,68,.30);
    }
    .actions{display:flex; gap:8px; justify-content:flex-end}
    .iconBtn{
      width:36px; height:36px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color:#e5e7eb;
      cursor:pointer;
      display:grid; place-items:center;
      font-weight:900;
    }
    .iconBtn:hover{filter:brightness(1.08)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    @media (max-width: 920px){
      .loginCard{grid-template-columns: 1fr}
      .grid2,.grid3{grid-template-columns:1fr}
      .headRow,.itemRow{grid-template-columns: 1.6fr 1fr .9fr 120px}
    }
  </style>
</head>

<body>
<div class="wrap">

  <!-- LOGIN -->
  <section id="loginView" class="loginShell">
    <div class="loginCard">
      <div class="loginLeft">
        <div class="logo">ADM</div>
        <h1>Admin Alfa</h1>
        <p>Gerencie clientes, categorias e produtos (Supabase + Vercel API).</p>
        <p style="opacity:.8;font-size:13px">Login por email/senha ou Google.</p>
      </div>

      <div class="loginRight">
        <h2>Entre na sua conta</h2>
        <p class="sub" id="loginStepHint">Digite seu e-mail para continuar.</p>

        <!-- step 1 -->
        <div id="stepEmail">
          <label>Email</label>
          <input id="email" type="email" placeholder="nome@email.com" autocomplete="email" />
          <div class="row">
            <button class="btn primary" id="btnNext">Continuar</button>
          </div>
        </div>

        <!-- step 2 -->
        <div id="stepSenha" class="hidden">
          <label>Senha</label>
          <input id="senha" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
          <div class="row">
            <button class="btn primary" id="btnLogin">Entrar</button>
            <button class="btn ghost" id="btnGoogle">Entrar com Google</button>
          </div>
          <div class="row" style="justify-content:flex-start">
            <button class="btn ghost" id="btnVoltar">‚Üê Trocar e-mail</button>
          </div>
        </div>

        <div id="msg" class="msg"></div>
      </div>
    </div>
  </section>

  <!-- APP -->
  <section id="appView" class="app hidden">
    <div class="top">
      <div class="who">Logado como: <b id="whoEmail" class="mono">‚Äî</b></div>
      <button class="btn danger" id="btnLogout">Sair</button>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="clientes">Clientes</button>
      <button class="tab" data-tab="categorias">Categorias</button>
      <button class="tab" data-tab="produtos">Produtos</button>
    </div>

    <!-- CLIENTES -->
    <div class="panel" id="tab-clientes">
      <h3>Criar cliente</h3>
      <div class="grid3">
        <div class="field">
          <label>Nome</label>
          <input id="c_nome" placeholder="Ex: Padaria do Jo√£o" />
        </div>
        <div class="field">
          <label>Slug</label>
          <input id="c_slug" placeholder="ex: padaria-do-joao" />
        </div>
        <div class="field">
          <label>WhatsApp</label>
          <input id="c_whats" placeholder="6299..." />
        </div>
      </div>

      <div class="grid3" style="margin-top:10px">
        <div class="field">
          <label>Tipo de neg√≥cio</label>
          <select id="c_tipo_negocio">
            <option value="">Selecione‚Ä¶</option>
            <option>Restaurante</option>
            <option>Padaria</option>
            <option>Lanchonete</option>
            <option>Mercado</option>
            <option>Farm√°cia</option>
            <option>Petshop</option>
            <option>Outros</option>
          </select>
        </div>

        <div class="field">
          <label>Email do cliente</label>
          <input id="c_email" placeholder="cliente@email.com" />
        </div>

        <div class="field">
          <label>Senha do cliente</label>
          <input id="c_senha" type="password" placeholder="Crie uma senha" />
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="btnCriarCliente">Salvar</button>
        <button class="btn ghost" id="btnReloadClientes">Recarregar</button>
      </div>
      <div id="msgClientes" class="msg"></div>

      <div class="list" style="margin-top:14px">
        <div class="headRow">
          <div>Nome</div><div>Slug</div><div>Status</div><div style="text-align:right">A√ß√µes</div>
        </div>
        <div id="listaClientes"></div>
      </div>
    </div>

    <!-- CATEGORIAS -->
    <div class="panel hidden" id="tab-categorias">
      <h3>Categorias (por loja)</h3>
      <div class="grid2">
        <div class="field">
          <label>Cliente (slug)</label>
          <input id="cat_cliente" placeholder="ex: padaria-do-joao" />
        </div>
        <div class="field">
          <label>Nome da categoria</label>
          <input id="cat_nome" placeholder="Ex: P√£es" />
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="btnCriarCategoria">Salvar</button>
        <button class="btn ghost" id="btnReloadCategorias">Recarregar</button>
      </div>
      <div id="msgCategorias" class="msg"></div>

      <div class="list" style="margin-top:14px">
        <div class="headRow">
          <div>Nome</div><div>Cliente</div><div>Status</div><div style="text-align:right">A√ß√µes</div>
        </div>
        <div id="listaCategorias"></div>
      </div>
    </div>

    <!-- PRODUTOS -->
    <div class="panel hidden" id="tab-produtos">
      <h3>Produtos (por loja)</h3>
      <div class="grid3">
        <div class="field">
          <label>Cliente (slug)</label>
          <input id="p_cliente" placeholder="ex: padaria-do-joao" />
        </div>
        <div class="field">
          <label>Categoria (id)</label>
          <input id="p_catid" placeholder="id da categoria" />
        </div>
        <div class="field">
          <label>Nome</label>
          <input id="p_nome" placeholder="Ex: P√£o franc√™s" />
        </div>
      </div>

      <div class="grid3" style="margin-top:10px">
        <div class="field">
          <label>Pre√ßo</label>
          <input id="p_preco" placeholder="4.50" />
        </div>
        <div class="field">
          <label>Imagem URL</label>
          <input id="p_img" placeholder="https://..." />
        </div>
        <div class="field">
          <label>Descri√ß√£o</label>
          <input id="p_desc" placeholder="Opcional" />
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="btnCriarProduto">Salvar</button>
        <button class="btn ghost" id="btnReloadProdutos">Recarregar</button>
      </div>
      <div id="msgProdutos" class="msg"></div>

      <div class="list" style="margin-top:14px">
        <div class="headRow">
          <div>Produto</div><div>Cliente</div><div>Status</div><div style="text-align:right">A√ß√µes</div>
        </div>
        <div id="listaProdutos"></div>
      </div>
    </div>

  </section>
</div>

<script>
  // CONFIG DO SEU PROJETO SUPABASE (public√°vel)
  const SUPABASE_URL = "https://rgsnmxspyywwouhcdwkj.supabase.co";
  const SUPABASE_ANON = "sb_publishable_nHPsCV3y79FgexEMAeANWQ_P6jWRDd1";

  // SUA API VERCEL
  const API_BASE = "https://cafeteria-gamma-orpin.vercel.app";

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true
    }
  });

  const $ = (id)=>document.getElementById(id);
  const showMsg = (el, text, ok=false)=>{
    el.className = "msg " + (ok ? "ok" : "err");
    el.textContent = text || "";
  };

  async function api(path, method="GET", body=null) {
    const { data: { session } } = await sb.auth.getSession();
    const token = session?.access_token || "";

    const res = await fetch(API_BASE + path, {
      method,
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: body ? JSON.stringify(body) : null
    });

    const json = await res.json().catch(()=> ({}));
    if (!res.ok) throw new Error(json.error || ("HTTP " + res.status));
    return json;
  }

  // LOGIN FLOW iFood
  $("btnNext").onclick = ()=>{
    const email = $("email").value.trim();
    if (!email) return showMsg($("msg"), "Informe seu e-mail.");
    $("stepEmail").classList.add("hidden");
    $("stepSenha").classList.remove("hidden");
    $("loginStepHint").textContent = "Agora digite sua senha ou use Google.";
    showMsg($("msg"), "", true);
    $("senha").focus();
  };
  $("btnVoltar").onclick = ()=>{
    $("stepSenha").classList.add("hidden");
    $("stepEmail").classList.remove("hidden");
    $("loginStepHint").textContent = "Digite seu e-mail para continuar.";
    showMsg($("msg"), "", true);
  };

  $("btnLogin").onclick = async ()=>{
    try{
      showMsg($("msg"), "Entrando...", true);
      const email = $("email").value.trim();
      const senha = $("senha").value.trim();
      const { error } = await sb.auth.signInWithPassword({ email, password: senha });
      if (error) throw error;
      showMsg($("msg"), "OK!", true);
    }catch(e){
      showMsg($("msg"), e.message || "Erro no login.");
    }
  };

  $("btnGoogle").onclick = async ()=>{
    try{
      showMsg($("msg"), "Abrindo Google...", true);
      const { error } = await sb.auth.signInWithOAuth({
        provider: "google",
        options: { redirectTo: location.href }
      });
      if (error) throw error;
    }catch(e){
      showMsg($("msg"), e.message || "Erro no Google.");
    }
  };

  $("btnLogout").onclick = async ()=>{
    await sb.auth.signOut();
  };

  // UI tabs
  document.querySelectorAll(".tab").forEach(btn=>{
    btn.onclick = ()=>{
      document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const t = btn.dataset.tab;
      ["clientes","categorias","produtos"].forEach(x=>{
        $("tab-"+x).classList.toggle("hidden", x !== t);
      });
    };
  });

  // RENDER LISTAS
  const pill = (ativo)=> `<span class="pill ${ativo? "":"off"}">${ativo? "Ativo":"Off"}</span>`;
  const icon = (txt)=> txt;

  async function loadClientes(){
    const list = await api("/api/admin/clientes","GET");
    $("listaClientes").innerHTML = list.map(c=>`
      <div class="itemRow">
        <div><b>${escapeHtml(c.nome||"")}</b><div style="opacity:.7;font-size:12px">${escapeHtml(c.tipo_negocio||"")}</div></div>
        <div class="mono">${escapeHtml(c.slug||"")}</div>
        <div>${pill(!!c.ativo)}</div>
        <div class="actions">
          <button class="iconBtn" title="Ativar/Desativar" onclick='toggleCliente("${c.id}", ${!c.ativo})'>${icon("‚èª")}</button>
          <button class="iconBtn" title="Excluir" onclick='delCliente("${c.id}")'>${icon("üóë")}</button>
        </div>
      </div>
    `).join("");
  }

  async function toggleCliente(id, ativo){
    try{
      await api("/api/admin/clientes","PATCH",{id, ativo});
      await loadClientes();
    }catch(e){ showMsg($("msgClientes"), e.message); }
  }
  async function delCliente(id){
    if(!confirm("Excluir cliente?")) return;
    try{
      await api("/api/admin/clientes","DELETE",{id});
      await loadClientes();
    }catch(e){ showMsg($("msgClientes"), e.message); }
  }

  async function loadCategorias(){
    const list = await api("/api/admin/categorias","GET");
    $("listaCategorias").innerHTML = list.map(c=>`
      <div class="itemRow">
        <div><b>${escapeHtml(c.nome||"")}</b></div>
        <div class="mono">${escapeHtml(c.cliente_slug||"")}</div>
        <div>${pill(!!c.ativo)}</div>
        <div class="actions">
          <button class="iconBtn" title="Ativar/Desativar" onclick='toggleCategoria("${c.id}", ${!c.ativo})'>‚èª</button>
          <button class="iconBtn" title="Excluir" onclick='delCategoria("${c.id}")'>üóë</button>
        </div>
      </div>
    `).join("");
  }
  async function toggleCategoria(id, ativo){
    try{ await api("/api/admin/categorias","PATCH",{id, ativo}); await loadCategorias(); }
    catch(e){ showMsg($("msgCategorias"), e.message); }
  }
  async function delCategoria(id){
    if(!confirm("Excluir categoria?")) return;
    try{ await api("/api/admin/categorias","DELETE",{id}); await loadCategorias(); }
    catch(e){ showMsg($("msgCategorias"), e.message); }
  }

  async function loadProdutos(){
    const list = await api("/api/admin/produtos","GET");
    $("listaProdutos").innerHTML = list.map(p=>`
      <div class="itemRow">
        <div><b>${escapeHtml(p.nome||"")}</b><div style="opacity:.7;font-size:12px">${escapeHtml(p.descricao||"")}</div></div>
        <div class="mono">${escapeHtml(p.cliente_slug||"")}</div>
        <div>${pill(!!p.ativo)}</div>
        <div class="actions">
          <button class="iconBtn" title="Ativar/Desativar" onclick='toggleProduto("${p.id}", ${!p.ativo})'>‚èª</button>
          <button class="iconBtn" title="Excluir" onclick='delProduto("${p.id}")'>üóë</button>
        </div>
      </div>
    `).join("");
  }
  async function toggleProduto(id, ativo){
    try{ await api("/api/admin/produtos","PATCH",{id, ativo}); await loadProdutos(); }
    catch(e){ showMsg($("msgProdutos"), e.message); }
  }
  async function delProduto(id){
    if(!confirm("Excluir produto?")) return;
    try{ await api("/api/admin/produtos","DELETE",{id}); await loadProdutos(); }
    catch(e){ showMsg($("msgProdutos"), e.message); }
  }

  // CREATE
  $("btnCriarCliente").onclick = async ()=>{
    try{
      showMsg($("msgClientes"), "Salvando...", true);
      const payload = {
        nome: $("c_nome").value.trim(),
        slug: $("c_slug").value.trim(),
        whatsapp: $("c_whats").value.trim(),
        tipo_negocio: $("c_tipo_negocio").value.trim(),
        email: $("c_email").value.trim(),
        senha: $("c_senha").value.trim(),
        ativo: true
      };
      await api("/api/admin/clientes","POST", payload);
      showMsg($("msgClientes"), "Cliente criado ‚úÖ", true);
      $("c_nome").value = $("c_slug").value = $("c_whats").value = $("c_email").value = $("c_senha").value = "";
      $("c_tipo_negocio").value = "";
      await loadClientes();
    }catch(e){
      showMsg($("msgClientes"), e.message);
    }
  };
  $("btnReloadClientes").onclick = loadClientes;

  $("btnCriarCategoria").onclick = async ()=>{
    try{
      showMsg($("msgCategorias"), "Salvando...", true);
      await api("/api/admin/categorias","POST", {
        cliente_slug: $("cat_cliente").value.trim(),
        nome: $("cat_nome").value.trim(),
        ordem: 0,
        ativo: true
      });
      showMsg($("msgCategorias"), "Categoria criada ‚úÖ", true);
      $("cat_nome").value = "";
      await loadCategorias();
    }catch(e){ showMsg($("msgCategorias"), e.message); }
  };
  $("btnReloadCategorias").onclick = loadCategorias;

  $("btnCriarProduto").onclick = async ()=>{
    try{
      showMsg($("msgProdutos"), "Salvando...", true);
      await api("/api/admin/produtos","POST", {
        cliente_slug: $("p_cliente").value.trim(),
        categoria_id: $("p_catid").value.trim() || null,
        nome: $("p_nome").value.trim(),
        descricao: $("p_desc").value.trim(),
        preco: Number(($("p_preco").value || "0").replace(",", ".")),
        imagem_url: $("p_img").value.trim(),
        ativo: true
      });
      showMsg($("msgProdutos"), "Produto criado ‚úÖ", true);
      $("p_nome").value = $("p_desc").value = $("p_preco").value = $("p_img").value = "";
      await loadProdutos();
    }catch(e){ showMsg($("msgProdutos"), e.message); }
  };
  $("btnReloadProdutos").onclick = loadProdutos;

  function escapeHtml(str){
    return String(str ?? "").replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  // SESSION WATCH
  async function refreshUI(){
    const { data: { session } } = await sb.auth.getSession();
    const logged = !!session;

    $("loginView").classList.toggle("hidden", logged);
    $("appView").classList.toggle("hidden", !logged);

    if (logged){
      $("whoEmail").textContent = session.user.email || "‚Äî";
      // carrega dados
      await Promise.allSettled([loadClientes(), loadCategorias(), loadProdutos()]);
    }
  }

  sb.auth.onAuthStateChange(()=> refreshUI());
  refreshUI();
</script>
</body>
</html>
