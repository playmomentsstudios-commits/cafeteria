<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Alfa ‚Ä¢ Portal da Chapada</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#0a0f18;
      --card: rgba(0,0,0,.25);
      --bd: rgba(255,255,255,.10);
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --y:#f1c40f;
      --ok:#2ecc71;
      --bad:#e74c3c;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--txt);
      background: radial-gradient(1200px 600px at 10% 10%, rgba(241,196,15,.12), transparent 60%),
                  radial-gradient(900px 500px at 80% 30%, rgba(46,204,113,.08), transparent 55%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
      overflow-x:hidden;
    }

    /* ===== Layout ===== */
    .wrap{max-width:1180px;margin:0 auto;padding:22px}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding:14px 16px;border:1px solid var(--bd);border-radius:18px;background:rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .brand .logo{
      width:46px;height:46px;border-radius:14px;overflow:hidden;
      border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);
      display:flex;align-items:center;justify-content:center;
    }
    .brand .logo img{width:100%;height:100%;object-fit:cover}
    .brand h1{font-size:16px;margin:0;line-height:1.2}
    .brand p{margin:0;font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:520px}

    .row{display:flex;align-items:center;gap:10px}
    .btn{
      cursor:pointer;border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--txt);
      padding:10px 12px;border-radius:12px;
      font-weight:650;font-size:13px;
      display:inline-flex;align-items:center;gap:8px;
    }
    .btn:hover{background:rgba(255,255,255,.09)}
    .btn.y{background:rgba(241,196,15,.95);color:#101010;border-color:rgba(241,196,15,.55)}
    .btn.y:hover{background:rgba(241,196,15,1)}
    .btn.small{padding:8px 10px;font-size:12px;border-radius:10px}

    .tabs{
      display:flex;gap:8px;flex-wrap:wrap;margin:14px 0 0;
    }
    .tab{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--txt);
      padding:8px 12px;border-radius:999px;
      font-weight:750;font-size:12px;
    }
    .tab.active{
      background:rgba(241,196,15,.18);
      border-color:rgba(241,196,15,.45);
    }

    .listWrap{
      margin-top:14px;
      border:1px solid var(--bd);
      border-radius:18px;
      background:rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
      padding:14px;
    }
    .listTop{
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
      margin-bottom:10px;
    }
    .ttl{font-weight:850;font-size:14px}
    .meta{color:var(--muted);font-size:12px}
    .link{color:var(--y);text-decoration:none}
    .link:hover{text-decoration:underline}

    .items{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:12px;
    }
    @media (max-width: 1100px){ .items{grid-template-columns: repeat(3, 1fr)} }
    @media (max-width: 820px){ .items{grid-template-columns: repeat(2, 1fr)} }
    @media (max-width: 520px){ .items{grid-template-columns: 1fr} }

    .item{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      border-radius:16px;
      padding:12px;
      min-width:0;
    }

    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.15);
      font-size:12px;
      color:var(--txt);
    }
    .pill.ok{background:rgba(46,204,113,.18)}
    .pill.warn{background:rgba(241,196,15,.18)}
    .pill.bad{background:rgba(231,76,60,.18)}

    .empty{
      opacity:.75;
      padding:14px;
      border:1px dashed rgba(255,255,255,.12);
      border-radius:14px;
    }

    /* ===== Aprova√ß√£o ===== */
    .aprovList{display:flex;flex-direction:column;gap:10px}
    .aprovItem{
      display:flex;justify-content:space-between;gap:12px;align-items:flex-start;
      padding:12px;border:1px solid rgba(255,255,255,.08);border-radius:12px;background:rgba(0,0,0,.18)
    }

    /* ===== Login (central + logo grande) ===== */
    #login{min-height:100vh}
    .loginWrap{
      min-height:100vh;width:100%;
      display:flex;flex-direction:column;
      align-items:center;justify-content:center;
      gap:18px;padding:28px;
    }
    .loginHeroLogo img{
      width:190px;max-width:70vw;height:auto;display:block;
      filter:drop-shadow(0 10px 25px rgba(0,0,0,.35));
    }
    .loginCard{
      width:min(420px,92vw);
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:18px 18px 16px;
      backdrop-filter: blur(10px);
    }
    .loginCard h2{margin:0 0 6px}
    .loginCard p{margin:0 0 12px;color:var(--muted);font-size:12px}
    .loginForm{margin-top:10px;text-align:left}
    .sp10{height:10px}
    .loginActions{justify-content:center;margin-top:14px;gap:10px}
    .btn.gIcon{
      width:44px;min-width:44px;height:40px;padding:0;border-radius:12px;
      display:flex;align-items:center;justify-content:center
    }
    .gMark{font-weight:900;font-size:18px;line-height:1;letter-spacing:-1px}
    .msg{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.25);font-size:13px}
    .msg.err{border-color:rgba(231,76,60,.35)}
  </style>
</head>

<body>

<!-- LOGIN -->
<div id="login">
  <div class="loginWrap">
    <div class="loginHeroLogo">
      <img src="../logo.png" alt="Logo"
           onerror="this.style.display='none';document.getElementById('loginHeroFallback').style.display='block';" />
      <div id="loginHeroFallback" style="display:none;font-weight:800;font-size:28px;letter-spacing:.5px;">Admin Alfa</div>
    </div>

    <div class="loginCard">
      <h2>Entrar</h2>
      <p>Email/senha do Supabase Auth ou Google.</p>

      <div class="loginForm">
        <label>Email</label>
        <input id="email" placeholder="seu@email.com" />
        <div class="sp10"></div>
        <label>Senha</label>
        <input id="senha" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      </div>

      <div class="row loginActions">
        <button class="btn y" id="btnLogin">üîí Entrar</button>
        <button class="btn gIcon" id="btnGoogle" title="Entrar com Google" aria-label="Entrar com Google">
          <span class="gMark">G</span>
        </button>
      </div>

      <div id="loginMsg" class="msg err" style="display:none;margin-top:12px"></div>
    </div>
  </div>
</div>

<!-- APP -->
<div class="wrap" id="app" style="display:none">

  <div class="top">
    <div class="brand">
      <div class="logo">
        <img src="../logo.png" onerror="this.style.display='none';this.parentElement.textContent='ADM'">
      </div>
      <div style="min-width:0">
        <h1>Admin Alfa</h1>
        <p>Gerencie clientes e aprova√ß√µes.</p>
      </div>
    </div>

    <div class="row">
      <button class="btn" id="btnReload">üîÑ Recarregar</button>
      <button class="btn y" id="btnLogout">üö™ Sair</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="clientes">Clientes</button>
    <button class="tab" data-tab="cadastros">Cadastros</button>
  </div>

  <div class="listWrap">
    <div class="listTop">
      <div>
        <div class="ttl" id="listTitle">Clientes</div>
        <div class="meta" id="listSubtitle">Link de senha √© a forma certa (n√£o existe ‚Äúver senha‚Äù).</div>
      </div>
      <input id="search" placeholder="Buscar..." style="min-width:240px">
    </div>

    <div class="items" id="list"></div>
  </div>

</div>

<script>
  // ===== CONFIG (j√° preenchido com seus dados) =====
  const SUPABASE_URL = "https://rgsnmxspyywwouhcdwkj.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJnc25teHNweXl3d291aGNkd2tqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MzI3NzIsImV4cCI6MjA4MzUwODc3Mn0.dxj35rJ_g_952_VvwV4mjFraB1b0BLdsxHw_wYiQNQI";

  // Sua API da Vercel (base /api)
  const API_BASE = "https://cafeteria-gamma-orpin.vercel.app/api";

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  let session = null;

  let tab = "clientes";
  let clientes = [];
  let cadastros = [];

  function el(id){ return document.getElementById(id); }
  function show(id){ el(id).style.display="block"; }
  function hide(id){ el(id).style.display="none"; }

  function escapeHtml(str){
    return String(str ?? "")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  async function apiFetch(path, options = {}){
    const token = session?.access_token;
    const headers = {
      "Content-Type": "application/json",
      ...(options.headers || {})
    };
    if (token) headers["Authorization"] = "Bearer " + token;

    const res = await fetch(API_BASE + path, { ...options, headers });
    const json = await res.json().catch(()=> ({}));
    if (!res.ok) throw new Error(json.error || ("HTTP " + res.status));
    return json;
  }

  async function signInEmail(){
    const email = el("email").value.trim();
    const password = el("senha").value;
    const box = el("loginMsg");
    box.style.display="none";

    const { data, error } = await sb.auth.signInWithPassword({ email, password });
    if(error){
      box.style.display="block";
      box.textContent = error.message;
      return;
    }
    session = data.session;
    await afterLogin();
  }

  async function signInGoogle(){
    const box = el("loginMsg");
    box.style.display="none";

    const { error } = await sb.auth.signInWithOAuth({
      provider: "google",
      options: { redirectTo: window.location.href }
    });
    if(error){
      box.style.display="block";
      box.textContent = error.message;
    }
  }

  async function logout(){
    await sb.auth.signOut();
    session = null;
    hide("app");
    show("login");
  }

  async function loadAll(){
    // precisa existir na Vercel: /api/admin/listar
    const data = await apiFetch("/admin/listar");
    clientes = data.clientes || [];
    cadastros = data.cadastros || [];
    renderList();
  }

  function renderClientes(q){
    el("listTitle").textContent = "Clientes";
    el("listSubtitle").textContent = "Editar dados + gerar link para definir senha.";

    let list = clientes.slice();
    if (q) list = list.filter(x =>
      (x.nome||"").toLowerCase().includes(q) ||
      (x.slug||"").toLowerCase().includes(q) ||
      (x.email||"").toLowerCase().includes(q)
    );

    if(!list.length){
      el("list").innerHTML = `<div class="empty">Nenhum cliente encontrado.</div>`;
      return;
    }

    el("list").innerHTML = list.map(c=>{
      const ativoPill = c.ativo ? `<span class="pill ok">Ativo</span>` : `<span class="pill bad">Inativo</span>`;
      const email = c.email ? escapeHtml(c.email) : "‚Äî";

      return `
        <div class="item">
          <div class="ttl">${escapeHtml(c.nome||"‚Äî")}</div>
          <div class="meta">${escapeHtml(c.slug||"")} ‚Ä¢ ${escapeHtml(c.cidade||"")}</div>

          <div class="meta" style="margin-top:8px">
            ${ativoPill}
            <span class="pill warn">${escapeHtml(c.tipo_negocio||c.tipo||"")}</span>
          </div>

          <div class="meta" style="margin-top:8px">Email: <strong>${email}</strong></div>

          <div class="row" style="margin-top:10px;flex-wrap:wrap">
            <button class="btn small" onclick="editarClientePrompt('${escapeHtml(c.slug)}')">‚úèÔ∏è Editar</button>
            <button class="btn y small" onclick="resetSenhaClientePrompt('${escapeHtml(c.email||"")}')">üîë Link de senha</button>
          </div>
        </div>
      `;
    }).join("");
  }

  function renderCadastros(q){
    el("listTitle").textContent = "Cadastros (aprova√ß√£o)";
    el("listSubtitle").textContent = "Aprovar cria usu√°rio Auth e gera link de senha.";

    let rows = cadastros.slice();
    if(q){
      rows = rows.filter(r=>{
        const blob = [r.nome_negocio,r.cidade,r.categoria,r.whatsapp,r.email,r.instagram,r.endereco,r.mensagem,r.status]
          .filter(Boolean).join(" ").toLowerCase();
        return blob.includes(q);
      });
    }

    if(!rows.length){
      el("list").innerHTML = `<div class="empty">Nenhum cadastro encontrado.</div>`;
      return;
    }

    el("list").innerHTML = `<div class="aprovList">` + rows.map(r=>{
      const st = String(r.status||"pendente").toLowerCase();
      const badge = st==="pendente" ? `<span class="pill warn">Pendente</span>` : st==="aprovado" ? `<span class="pill ok">Aprovado</span>` : `<span class="pill bad">Rejeitado</span>`;
      const when = r.created_at ? new Date(r.created_at).toLocaleString() : "";
      return `
        <div class="aprovItem">
          <div>
            <div class="row" style="gap:10px;align-items:center;flex-wrap:wrap">
              <div class="ttl">${escapeHtml(r.nome_negocio||"‚Äî")}</div>
              ${badge}
            </div>
            <div class="meta">${escapeHtml(r.cidade||"‚Äî")} ‚Ä¢ ${escapeHtml(r.categoria||"‚Äî")} ‚Ä¢ ${escapeHtml(r.whatsapp||"‚Äî")}</div>
            <div class="meta">${when}${r.email ? " ‚Ä¢ "+escapeHtml(r.email) : ""}${r.instagram ? " ‚Ä¢ @"+escapeHtml(r.instagram) : ""}</div>
            ${r.endereco ? `<div class="meta"><strong>Endere√ßo:</strong> ${escapeHtml(r.endereco)}</div>` : ``}
            ${r.mensagem ? `<div class="meta"><strong>Mensagem:</strong> ${escapeHtml(r.mensagem)}</div>` : ``}
          </div>

          <div class="row" style="gap:10px;flex-wrap:wrap;justify-content:flex-end">
            ${st==="pendente" ? `
              <button class="btn y small" onclick="aprovarCadastro('${r.id}')">Aprovar</button>
            ` : ``}
          </div>
        </div>
      `;
    }).join("") + `</div>`;
  }

  function renderList(){
    const q = (el("search").value||"").trim().toLowerCase();
    if(tab==="clientes") return renderClientes(q);
    if(tab==="cadastros") return renderCadastros(q);
  }

  async function aprovarCadastro(id){
    try{
      // precisa existir na Vercel: /api/admin/aprovar-cadastro
      const resp = await apiFetch("/admin/aprovar-cadastro", {
        method:"POST",
        body: JSON.stringify({ cadastro_id: id })
      });

      if(resp.recovery_link){
        alert("‚úÖ Aprovado!\n\nLink de senha (copie e envie ao cliente):\n\n" + resp.recovery_link);
      }else{
        alert("‚úÖ Aprovado! Usu√°rio criado/vinculado.");
      }

      await loadAll();
    }catch(e){
      alert("Falha ao aprovar: " + (e?.message || e));
    }
  }

  async function resetSenhaClientePrompt(email){
    const em = (email||"").trim();
    const alvo = prompt("Email do cliente para gerar link de senha:", em);
    if(!alvo) return;
    try{
      // precisa existir na Vercel: /api/admin/reset-senha
      const resp = await apiFetch("/admin/reset-senha", {
        method:"POST",
        body: JSON.stringify({ email: alvo })
      });
      alert("üîë Link de senha gerado:\n\n" + (resp.recovery_link || "(sem link)"));
    }catch(e){
      alert("Falha ao gerar link: " + (e?.message || e));
    }
  }

  // Edi√ß√£o (por enquanto prompt). Pr√≥ximo passo: modal + endpoint PUT.
  async function editarClientePrompt(slug){
    const c = clientes.find(x => x.slug === slug);
    if(!c) return alert("Cliente n√£o encontrado.");

    const novoNome = prompt("Nome:", c.nome || "");
    if(novoNome === null) return;

    const novoWhats = prompt("WhatsApp:", c.whatsapp || "");
    if(novoWhats === null) return;

    const novaCidade = prompt("Cidade:", c.cidade || "");
    if(novaCidade === null) return;

    const novoTipo = prompt("Tipo de neg√≥cio:", c.tipo_negocio || "");
    if(novoTipo === null) return;

    const novoEmail = prompt("Email:", c.email || "");
    if(novoEmail === null) return;

    // Endpoint de update (vamos criar j√° no pr√≥ximo passo):
    // /api/admin/editar-cliente
    try{
      await apiFetch("/admin/editar-cliente",{
        method:"POST",
        body: JSON.stringify({
          slug,
          nome: novoNome,
          whatsapp: novoWhats,
          cidade: novaCidade,
          tipo_negocio: novoTipo,
          email: novoEmail
        })
      });
      alert("‚úÖ Cliente atualizado!");
      await loadAll();
    }catch(e){
      alert("Ainda n√£o existe o endpoint /admin/editar-cliente.\n\nPr√≥ximo passo: eu te mando ele agora.\n\nErro: " + (e?.message||e));
    }
  }
  window.editarClientePrompt = editarClientePrompt;
  window.resetSenhaClientePrompt = resetSenhaClientePrompt;
  window.aprovarCadastro = aprovarCadastro;

  async function afterLogin(){
    hide("login");
    show("app");
    await loadAll();
  }

  // Tabs
  document.querySelectorAll(".tab").forEach(b=>{
    b.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      tab = b.dataset.tab;
      renderList();
    });
  });

  el("search").addEventListener("input", renderList);
  el("btnLogin").onclick = signInEmail;
  el("btnGoogle").onclick = signInGoogle;
  el("btnLogout").onclick = logout;
  el("btnReload").onclick = async ()=>{ await loadAll(); };

  // Boot
  (async ()=>{
    const { data } = await sb.auth.getSession();
    session = data.session;

    if (session){
      await afterLogin();
    }else{
      show("login"); hide("app");
    }

    sb.auth.onAuthStateChange(async (_event, s)=>{
      session = s;
      if(session){
        await afterLogin();
      }
    });
  })();
</script>

</body>
</html>
