<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel do Cliente</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0b1220;
      --card:rgba(255,255,255,.06);
      --line:rgba(255,255,255,.12);
      --text:#fff;
      --muted:rgba(255,255,255,.7);
      --y:#ffd24a; --y2:#ffbb1a;
      --shadow:0 18px 60px rgba(0,0,0,.45);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text);
      background:
        radial-gradient(900px 600px at 20% 0%, rgba(255,210,74,.18), transparent 55%),
        linear-gradient(180deg, #070b14, var(--bg));
      padding:18px 14px 90px;
    }
    .wrap{max-width:1100px;margin:0 auto}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 16px;border-radius:22px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);box-shadow:var(--shadow);
      backdrop-filter: blur(12px);
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:46px;height:46px;border-radius:16px;overflow:hidden;
      background:rgba(255,255,255,.06);border:1px solid var(--line);
      display:flex;align-items:center;justify-content:center;
    }
    .logo img{width:100%;height:100%;object-fit:cover}
    .btn{
      border:none;cursor:pointer;
      padding:10px 12px;border-radius:14px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      font-weight:800;
      display:inline-flex;align-items:center;gap:8px;
    }
    .btn.y{background:linear-gradient(135deg,var(--y),var(--y2));color:#201400;border-color:rgba(0,0,0,.08)}
    .card{
      margin-top:14px;
      border-radius:22px;padding:16px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      backdrop-filter: blur(12px);
    }
    .sub{color:var(--muted);font-size:12px;margin:6px 0 0}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input,select{
      width:100%;padding:11px 12px;border-radius:14px;
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--text);outline:none;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .field{flex:1;min-width:220px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .tab{
      padding:10px 12px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.05);color:var(--muted);font-weight:900;cursor:pointer;
    }
    .tab.active{background:rgba(255,210,74,.18);color:var(--text);border-color:rgba(255,210,74,.45)}
    .grid4{
      display:grid;grid-template-columns:repeat(4,minmax(0,1fr));
      gap:12px;margin-top:12px;
    }
    .item{
      border-radius:18px;padding:12px;
      background:rgba(255,255,255,.05);
      border:1px solid var(--line);
      min-height:150px;
      display:flex;flex-direction:column;gap:10px;
    }
    .ttl{font-weight:900}
    .meta{color:var(--muted);font-size:12px}
    @media (max-width:1050px){ .grid4{grid-template-columns:repeat(2,minmax(0,1fr))} }
    @media (max-width:720px){ .grid4{grid-template-columns:1fr} }
    .msg{margin-top:10px;padding:10px;border-radius:14px;border:1px solid var(--line);background:rgba(0,0,0,.2);color:var(--muted)}
    .msg.err{border-color:rgba(255,90,103,.45);color:#ffd0d5}
    .msg.ok{border-color:rgba(29,214,164,.40);color:#c9fff0}
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <div class="logo"><img src="../logo.png" onerror="this.style.display='none';this.parentElement.textContent='LO'"></div>
      <div>
        <div style="font-weight:900">Painel do Cliente</div>
        <div class="sub">Gerencie categorias e produtos da sua loja.</div>
      </div>
    </div>
    <button class="btn y" id="btnSair">üö™ Sair</button>
  </div>

  <div class="card" id="loginCard">
    <div style="font-weight:900;font-size:18px">Entrar</div>
    <p class="sub">Use email/senha (criado pelo Admin) ou Google.</p>

    <div class="row" style="margin-top:10px">
      <div class="field">
        <label>Email</label>
        <input id="email" placeholder="cliente@dominio.com" />
      </div>
      <div class="field">
        <label>Senha</label>
        <input id="senha" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn y" id="btnLogin">üîí Entrar</button>
      <button class="btn" id="btnGoogle">üü¶ Entrar com Google</button>
    </div>

    <div id="loginMsg" class="msg err" style="display:none"></div>
  </div>

  <div class="card" id="app" style="display:none">
    <div style="display:flex;align-items:flex-end;justify-content:space-between;gap:10px;flex-wrap:wrap">
      <div>
        <div style="font-weight:900;font-size:18px" id="lojaNome">‚Äî</div>
        <div class="sub">Slug: <span id="lojaSlug">‚Äî</span></div>
      </div>
      <div class="tabs">
        <button class="tab active" data-tab="categorias">Categorias</button>
        <button class="tab" data-tab="produtos">Produtos</button>
      </div>
    </div>

    <div id="msg" class="msg" style="display:none"></div>

    <div class="row" style="margin-top:12px">
      <div class="field">
        <label>Nova categoria</label>
        <input id="cat_nome" placeholder="Ex: Bebidas" />
      </div>
      <div class="field">
        <label>Ordem</label>
        <input id="cat_ordem" type="number" value="0" />
      </div>
      <div class="field" style="min-width:160px">
        <label>&nbsp;</label>
        <button class="btn y" id="btnCriarCat">üìÅ Criar</button>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div class="field">
        <label>Categoria (para produto)</label>
        <select id="selCat"></select>
      </div>
      <div class="field">
        <label>Produto</label>
        <input id="p_nome" placeholder="Ex: P√£o de queijo" />
      </div>
      <div class="field">
        <label>Pre√ßo</label>
        <input id="p_preco" type="number" step="0.01" value="0" />
      </div>
      <div class="field">
        <label>Imagem URL (opcional)</label>
        <input id="p_img" placeholder="https://.../foto.jpg" />
      </div>
      <div class="field" style="min-width:160px">
        <label>&nbsp;</label>
        <button class="btn y" id="btnCriarProd">üßæ Criar</button>
      </div>
    </div>

    <div class="grid4" id="grid"></div>
  </div>
</div>

<script>
  const SUPABASE_URL = "https://rgsnmxspyywwouhcdwkj.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_nHPsCV3y79FgexEMAeANWQ_P6jWRDd1";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const el = (id)=>document.getElementById(id);

  let session=null;
  let cliente_slug=null;
  let tab="categorias";
  let categorias=[];
  let produtos=[];

  function showMsg(text,type=""){
    const m=el("msg");
    m.style.display="block";
    m.className="msg "+(type||"");
    m.textContent=text;
    setTimeout(()=>m.style.display="none",3500);
  }

  async function resolveClienteSlug(){
    const { data: userData } = await sb.auth.getUser();
    const uid = userData?.user?.id;
    if (!uid) throw new Error("Sem usu√°rio");

    const { data, error } = await sb
      .from("cliente_usuarios")
      .select("cliente_slug,role,ativo")
      .eq("user_id", uid)
      .eq("ativo", true)
      .single();

    if (error || !data?.cliente_slug) throw new Error("Usu√°rio n√£o vinculado a uma loja");
    return data.cliente_slug;
  }

  async function loadLoja(){
    const { data: cli, error } = await sb
      .from("clientes")
      .select("*")
      .eq("slug", cliente_slug)
      .single();

    if (error || !cli) throw new Error("Loja n√£o encontrada");

    el("lojaNome").textContent = cli.nome || "Minha loja";
    el("lojaSlug").textContent = cli.slug || "‚Äî";
  }

  async function loadData(){
    const { data: cats } = await sb
      .from("categorias")
      .select("*")
      .eq("cliente_slug", cliente_slug)
      .order("ordem", { ascending:true });

    const { data: prods } = await sb
      .from("produtos")
      .select("*")
      .eq("cliente_slug", cliente_slug)
      .order("created_at", { ascending:false });

    categorias = cats || [];
    produtos = prods || [];

    el("selCat").innerHTML = categorias.map(c=>`<option value="${c.id}">${c.nome}</option>`).join("");
    render();
  }

  function render(){
    const grid = el("grid");
    if (tab==="categorias"){
      grid.innerHTML = categorias.map(c=>`
        <div class="item">
          <div class="ttl">${escapeHtml(c.nome||"‚Äî")}</div>
          <div class="meta">ordem: ${Number(c.ordem||0)}</div>
          <div class="meta">status: ${c.ativo ? "ativo":"inativo"}</div>
        </div>
      `).join("");
      return;
    }

    grid.innerHTML = produtos.map(p=>`
      <div class="item">
        <div class="ttl">${escapeHtml(p.nome||"‚Äî")}</div>
        <div class="meta">R$ ${Number(p.preco||0).toFixed(2)}</div>
        <div class="meta">${escapeHtml(p.descricao||"")}</div>
      </div>
    `).join("");
  }

  function escapeHtml(str){
    return String(str ?? "").replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  // tabs
  document.querySelectorAll(".tab").forEach(b=>{
    b.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      tab = b.dataset.tab;
      render();
    });
  });

  // login
  el("btnLogin").addEventListener("click", async ()=>{
    try{
      el("loginMsg").style.display="none";
      const email = el("email").value.trim();
      const password = el("senha").value.trim();
      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      if (error) throw error;
      session = data.session;
      await afterLogin();
    }catch(e){
      el("loginMsg").style.display="block";
      el("loginMsg").textContent = e.message || "Falha no login";
    }
  });

  el("btnGoogle").addEventListener("click", async ()=>{
    await sb.auth.signInWithOAuth({
      provider:"google",
      options:{ redirectTo: window.location.href }
    });
  });

  async function afterLogin(){
    el("loginCard").style.display="none";
    el("app").style.display="block";

    cliente_slug = await resolveClienteSlug();
    await loadLoja();
    await loadData();
  }

  el("btnSair").addEventListener("click", async ()=>{
    await sb.auth.signOut();
    session=null; cliente_slug=null;
    el("app").style.display="none";
    el("loginCard").style.display="block";
  });

  // criar categoria/produto (RLS precisa permitir)
  el("btnCriarCat").addEventListener("click", async ()=>{
    try{
      const nome = el("cat_nome").value.trim();
      const ordem = Number(el("cat_ordem").value||0);
      if (!nome) throw new Error("Nome obrigat√≥rio");
      const { error } = await sb.from("categorias").insert({ cliente_slug, nome, ordem, ativo:true });
      if (error) throw error;
      el("cat_nome").value="";
      showMsg("Categoria criada ‚úÖ","ok");
      await loadData();
    }catch(e){
      showMsg("Erro: "+e.message,"err");
    }
  });

  el("btnCriarProd").addEventListener("click", async ()=>{
    try{
      const categoria_id = el("selCat").value;
      if (!categoria_id) throw new Error("Selecione uma categoria");
      const nome = el("p_nome").value.trim();
      const preco = Number(el("p_preco").value||0);
      const imagem_url = el("p_img").value.trim() || null;
      if (!nome) throw new Error("Nome obrigat√≥rio");

      const { error } = await sb.from("produtos").insert({
        cliente_slug, categoria_id, nome, preco, ativo:true, imagem_url
      });
      if (error) throw error;

      el("p_nome").value=""; el("p_preco").value="0"; el("p_img").value="";
      showMsg("Produto criado ‚úÖ","ok");
      await loadData();
    }catch(e){
      showMsg("Erro: "+e.message,"err");
    }
  });

  // init
  (async ()=>{
    const { data } = await sb.auth.getSession();
    session = data.session || null;
    if (session) await afterLogin();
  })();
</script>
</body>
</html>
