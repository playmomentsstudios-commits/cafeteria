<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Card√°pio Digital</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#fffdf2;
      --card:#ffffff;
      --line:#f1e7bf;
      --text:#111827;
      --muted:#6b7280;

      --brand:#ffcc00;     /* amarelo */
      --brand2:#ffb100;    /* amarelo mais forte */
      --ink:#111827;
      --shadow: 0 16px 40px rgba(17,24,39,.10);
      --radius: 18px;
      --radius2: 14px;

      --green:#22c55e;
      --red:#ef4444;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--font);
      color: var(--text);
      background:
        radial-gradient(900px 500px at 10% 0%, rgba(255,204,0,.18), transparent 60%),
        radial-gradient(800px 460px at 90% 10%, rgba(255,177,0,.16), transparent 60%),
        linear-gradient(180deg, #fffdf2, #fff8dc);
      padding: 14px 12px 86px;
    }

    a{color:inherit; text-decoration:none}
    .wrap{max-width: 1180px; margin: 0 auto;}

    /* App bar */
    .appbar{
      position: sticky;
      top: 10px;
      z-index: 30;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 12px 14px;
      border-radius: var(--radius);
      background: rgba(255,255,255,.72);
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width:0;
    }
    .brand img{
      width: 44px;
      height: 44px;
      object-fit: contain;
      border-radius: 12px;
      background: #fff;
      border: 1px solid var(--line);
      padding: 6px;
    }
    .brandTxt{min-width:0}
    .brandTxt .t{font-weight: 950; letter-spacing:.2px; line-height:1.1}
    .brandTxt .s{
      font-size: 12.5px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .btn{
      cursor:pointer;
      border: 0;
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 900;
      display:inline-flex;
      align-items:center;
      gap: 10px;
      background: #fff;
      border: 1px solid var(--line);
      box-shadow: 0 10px 25px rgba(17,24,39,.06);
      transition: transform .12s ease, filter .12s ease;
      white-space:nowrap;
    }
    .btn:active{transform: translateY(1px)}
    .btn.brand{
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      border-color: rgba(0,0,0,.06);
    }

    /* Hero */
    .hero{
      margin-top: 12px;
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.66));
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
      padding: 16px;
      overflow:hidden;
      position: relative;
    }
    .hero:after{
      content:"";
      position:absolute;
      width: 340px;
      height: 340px;
      right:-140px;
      top:-180px;
      background: radial-gradient(circle at 30% 30%, rgba(255,204,0,.30), transparent 60%);
      transform: rotate(10deg);
      pointer-events:none;
    }
    .heroGrid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 12px;
      align-items:center;
    }
    .hero h1{
      margin:0;
      font-size: 26px;
      letter-spacing: -0.2px;
    }
    .hero p{
      margin: 8px 0 0;
      color: var(--muted);
      line-height: 1.4;
    }

    .searchRow{
      display:flex;
      gap: 10px;
      align-items:center;
      margin-top: 12px;
      flex-wrap:wrap;
    }
    .search{
      flex: 1;
      min-width: 240px;
      display:flex;
      align-items:center;
      gap: 10px;
      background:#fff;
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px 12px;
      box-shadow: 0 10px 25px rgba(17,24,39,.05);
    }
    .search input{
      width: 100%;
      border:0;
      outline:0;
      font-size: 14px;
      background:transparent;
    }

    /* Sections */
    .section{
      margin-top: 12px;
      border-radius: var(--radius);
      background: rgba(255,255,255,.78);
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .sectionHead{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap: 10px;
      margin-bottom: 10px;
    }
    .sectionHead h2{margin:0; font-size: 16px; font-weight: 950;}
    .sub{margin:0; color: var(--muted); font-size: 12.5px;}
    .count{font-family: var(--mono); font-weight: 900; font-size: 12.5px; color: #374151;}

    /* business category chips */
    .chips{
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
      padding: 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
    }
    .chipBtn{
      cursor:pointer;
      border: 1px solid transparent;
      background: transparent;
      padding: 9px 12px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 13px;
      color: #374151;
    }
    .chipBtn.active{
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      border-color: rgba(0,0,0,.06);
      color: #111827;
    }

    /* Clientes grid: 2 por linha */
    .gridClientes{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }
    .clienteCard{
      padding: 12px;
      border-radius: var(--radius2);
      background:#fff;
      border: 1px solid var(--line);
      box-shadow: 0 12px 28px rgba(17,24,39,.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      transition: transform .12s ease;
      min-width:0;
    }
    .clienteCard:hover{transform: translateY(-2px)}
    .cliLeft{
      display:flex;
      gap: 10px;
      align-items:center;
      min-width:0;
    }
    .avatar{
      width: 44px;
      height: 44px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(255,204,0,.55), rgba(255,177,0,.35));
      border: 1px solid rgba(0,0,0,.06);
      display:grid;
      place-items:center;
      font-weight: 950;
      flex:0 0 auto;
    }
    .cliTxt{min-width:0}
    .cliTxt .name{
      font-weight: 950;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .cliTxt .meta{
      margin-top: 3px;
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      font-weight: 900;
      color: #374151;
    }
    .dot{width:8px; height:8px; border-radius:99px; background: var(--green);}

    /* Vitrine */
    .hidden{display:none!important}

    .vitrineTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .vLeft{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .vTitle .n{font-weight: 950; font-size: 18px;}
    .vTitle .m{font-size: 12.5px; color: var(--muted);}

    .gridProdutos{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    .prodCard{
      border-radius: var(--radius2);
      background:#fff;
      border: 1px solid var(--line);
      box-shadow: 0 12px 28px rgba(17,24,39,.06);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 220px;
    }
    .prodImg{
      height: 120px;
      background: linear-gradient(135deg, rgba(255,204,0,.20), rgba(255,177,0,.12));
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:center;
      color: #9ca3af;
      font-weight: 950;
    }
    .prodImg img{width:100%; height:100%; object-fit: cover;}
    .prodBody{
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap: 7px;
      flex:1;
    }
    .prodName{font-weight: 950; line-height:1.2}
    .prodDesc{color: var(--muted); font-size: 12.5px; line-height:1.35; min-height: 34px;}
    .prodBottom{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-top:auto;
    }
    .price{font-family: var(--mono); font-weight: 950;}
    .store{font-size: 12px; color: var(--muted);}

    /* cart */
    .cartBar{
      position: fixed;
      left:0; right:0; bottom:0;
      padding: 12px;
      background: rgba(255,255,255,.92);
      border-top: 1px solid var(--line);
      backdrop-filter: blur(10px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      z-index: 50;
    }
    .cartBar .total{font-weight: 950; font-family: var(--mono);}
    .cartBar .muted{color: var(--muted); font-size: 12.5px;}

    footer{
      margin-top: 12px;
      border-radius: var(--radius);
      border: 1px solid var(--line);
      background: rgba(255,255,255,.72);
      box-shadow: var(--shadow);
      padding: 14px;
      color: #374151;
    }

    @media (max-width: 980px){
      .heroGrid{grid-template-columns: 1fr}
      .gridProdutos{grid-template-columns: repeat(2, minmax(0,1fr))}
    }
    @media (max-width: 720px){
      .gridClientes{grid-template-columns: 1fr}
      .gridProdutos{grid-template-columns: 1fr}
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- APPBAR -->
    <div class="appbar">
      <div class="brand">
        <img src="./logo.png" alt="Logo" />
        <div class="brandTxt">
          <div class="t">Card√°pio Digital</div>
          <div class="s">Encontre lojas e produtos e finalize pelo WhatsApp.</div>
        </div>
      </div>

      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end">
        <a class="btn" href="./admin/" target="_blank">üõ†Ô∏è Painel Admin</a>
      </div>
    </div>

    <!-- HERO -->
    <div class="hero" id="hero">
      <h1>Estilo ‚ÄúiFood‚Äù: simples, moderno e r√°pido.</h1>
      <p>Filtre por tipo de neg√≥cio (restaurante, mercado, padaria‚Ä¶) e veja produtos por categoria. Checkout direto no WhatsApp.</p>

      <div class="searchRow">
        <div class="search">
          üîé <input id="searchClientes" placeholder="Buscar loja (nome ou slug)..." />
        </div>
        <button class="btn brand" id="btnReload">‚ö° Atualizar</button>
      </div>
    </div>

    <!-- CATEGORIAS (TIPO DE NEG√ìCIO) -->
    <div class="section">
      <div class="sectionHead">
        <div>
          <h2>Categorias</h2>
          <p class="sub">Filtre as lojas por tipo de neg√≥cio.</p>
        </div>
        <div class="count" id="countClientes">‚Äî</div>
      </div>
      <div class="chips" id="bizChips"></div>
    </div>

    <!-- LOJAS -->
    <div class="section" id="secClientes">
      <div class="sectionHead">
        <div>
          <h2>Lojas em destaque</h2>
          <p class="sub" id="clientesSub">Carregando lojas...</p>
        </div>
        <div class="count"><span id="countAtivas">‚Äî</span> lojas</div>
      </div>
      <div class="gridClientes" id="clientesGrid"></div>
    </div>

    <!-- VITRINE (PRODUTOS) -->
    <div class="section hidden" id="secProdutos">
      <div class="vitrineTop">
        <div class="vLeft">
          <div class="avatar" id="cliAvatar">LO</div>
          <div class="vTitle">
            <div class="n" id="cliNome">Loja</div>
            <div class="m">
              slug: <span class="count" id="cliSlug">‚Äî</span> ‚Ä¢ WhatsApp: <span class="count" id="cliWhats">‚Äî</span>
            </div>
          </div>
          <span class="tag"><span class="dot"></span>Ativa</span>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
          <div class="search" style="min-width:260px">
            üîé <input id="searchProdutos" placeholder="Buscar produtos..." />
          </div>
          <button class="btn" id="btnBack">‚¨Ö Voltar</button>
        </div>
      </div>

      <div class="chips" id="catChips"></div>
      <div class="gridProdutos" id="prodGrid"></div>
    </div>

    <footer>
      <b>Card√°pio Digital</b> ‚Ä¢ marketplace multi-lojas.<br/>
      <span style="color:var(--muted); font-size:12.5px">
        Dica: lojas e produtos aparecem aqui automaticamente (somente ativos).
      </span>
    </footer>
  </div>

  <!-- CARRINHO -->
  <div class="cartBar" id="cartBar">
    <div>
      <div class="total" id="total">Total: R$ 0,00</div>
      <div class="muted" id="cartCount">0 itens</div>
    </div>
    <div style="display:flex; gap:10px; align-items:center">
      <button class="btn" id="btnLimpar">üßπ Limpar</button>
      <button class="btn brand" id="finalizar">üì≤ Finalizar</button>
    </div>
  </div>

<script>
  /* ================================
     SUPABASE (PUBLIC)
  ================================= */
  const SUPABASE_URL = "https://rgsnmxspyywwouhcdwkj.supabase.co";
  const SUPABASE_KEY = "sb_publishable_nHPsCV3y79FgexEMAeANWQ_P6jWRDd1";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  /* ================================
     STATE
  ================================= */
  let clientes = [];
  let categorias = [];
  let produtos = [];
  let clienteAtual = null;

  let carrinho = [];
  let catAtivaId = "all";
  let tipoNegocioAtivo = "all";

  /* ================================
     HELPERS
  ================================= */
  const el = (id)=>document.getElementById(id);
  const money = (v)=>Number(v||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});

  function escapeHtml(str){
    return String(str ?? "").replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }
  function initials(name){
    const s = (name||"").trim().split(/\s+/).slice(0,2).map(x=>x[0]?.toUpperCase()||"").join("");
    return s || "LO";
  }
  function getParamSlug(){
    return new URLSearchParams(window.location.search).get("u");
  }
  function setParamSlug(slug){
    const url = new URL(window.location.href);
    if (slug) url.searchParams.set("u", slug);
    else url.searchParams.delete("u");
    history.pushState({}, "", url.toString());
  }

  // retry simples (reduz AbortError)
  async function withRetry(fn, tries=3){
    let last;
    for (let i=0;i<tries;i++){
      try { return await fn(); }
      catch(e){ last=e; await new Promise(r=>setTimeout(r, 350*(i+1))); }
    }
    throw last;
  }

  function showHome(){
    clienteAtual = null;
    categorias = [];
    produtos = [];
    catAtivaId = "all";
    setParamSlug(null);

    el("secProdutos").classList.add("hidden");
    el("secClientes").classList.remove("hidden");
  }

  function showVitrine(){
    el("secClientes").classList.add("hidden");
    el("secProdutos").classList.remove("hidden");
  }

  /* ================================
     LOAD CLIENTES (HOME)
  ================================= */
  async function loadClientes(){
    el("clientesSub").textContent = "Carregando lojas...";
    try{
      const { data, error } = await withRetry(()=>sb
        .from("clientes")
        .select("id,nome,slug,whatsapp,ativo,tipo_negocio")
        .eq("ativo", true)
        .order("nome", { ascending:true })
      );

      if (error) throw error;

      clientes = data || [];
      el("countAtivas").textContent = clientes.length;
      el("countClientes").textContent = `${clientes.length} lojas`;

      buildBizChips();
      renderClientes();
    }catch(err){
      console.error(err);
      el("clientesSub").textContent = "Erro ao carregar lojas.";
      el("clientesGrid").innerHTML = `<div style="color:#6b7280">N√£o foi poss√≠vel carregar.</div>`;
    }
  }

  function buildBizChips(){
    const all = ["all","restaurante","mercado","padaria","lanchonete","farmacia","petshop"];
    const labels = {
      all:"Todos",
      restaurante:"Restaurante",
      mercado:"Mercado",
      padaria:"Padaria",
      lanchonete:"Lanchonete",
      farmacia:"Farm√°cia",
      petshop:"Pet shop",
    };

    el("bizChips").innerHTML = all.map(t=>`
      <button class="chipBtn ${t===tipoNegocioAtivo ? "active":""}" onclick="setBiz('${t}')">
        ${labels[t] || t}
      </button>
    `).join("");
  }

  function setBiz(t){
    tipoNegocioAtivo = t;
    buildBizChips();
    renderClientes();
  }

  function renderClientes(){
    const q = (el("searchClientes").value||"").trim().toLowerCase();

    let list = clientes.slice();

    if (tipoNegocioAtivo !== "all"){
      list = list.filter(c => String(c.tipo_negocio||"").toLowerCase() === tipoNegocioAtivo);
    }
    if (q){
      list = list.filter(c =>
        (c.nome||"").toLowerCase().includes(q) ||
        (c.slug||"").toLowerCase().includes(q)
      );
    }

    el("clientesSub").textContent = list.length ? "Toque para abrir a loja." : "Nenhuma loja encontrada.";
    el("clientesGrid").innerHTML = list.map(c => `
      <div class="clienteCard" onclick="openLoja('${c.slug}')">
        <div class="cliLeft">
          <div class="avatar">${initials(c.nome)}</div>
          <div class="cliTxt">
            <div class="name">${escapeHtml(c.nome||"Loja")}</div>
            <div class="meta">${escapeHtml(c.tipo_negocio||"")} ‚Ä¢ ${escapeHtml(c.slug||"")}</div>
          </div>
        </div>
        <span class="tag"><span class="dot"></span>Ver</span>
      </div>
    `).join("");
  }

  /* ================================
     LOAD VITRINE
  ================================= */
  async function openLoja(slug){
    setParamSlug(slug);
    await loadVitrine(slug);
  }

  async function loadVitrine(slug){
    try{
      const { data: cli, error: e1 } = await withRetry(()=>sb
        .from("clientes")
        .select("*")
        .eq("slug", slug)
        .eq("ativo", true)
        .single()
      );
      if (e1 || !cli) throw (e1||new Error("Loja n√£o encontrada"));

      clienteAtual = cli;

      const { data: cats, error: e2 } = await withRetry(()=>sb
        .from("categorias")
        .select("*")
        .eq("cliente_slug", slug)
        .eq("ativo", true)
        .order("ordem", { ascending:true })
      );
      if (e2) throw e2;

      const { data: prods, error: e3 } = await withRetry(()=>sb
        .from("produtos")
        .select("*")
        .eq("cliente_slug", slug)
        .eq("ativo", true)
        .order("ordem", { ascending:true })
      );
      if (e3) throw e3;

      categorias = cats || [];
      produtos = prods || [];

      el("cliAvatar").textContent = initials(cli.nome);
      el("cliNome").textContent = cli.nome || "Loja";
      el("cliSlug").textContent = cli.slug || "‚Äî";
      el("cliWhats").textContent = cli.whatsapp || "‚Äî";

      catAtivaId = "all";
      buildCatChips();
      renderProdutos();
      showVitrine();
    }catch(err){
      console.error(err);
      showHome();
    }
  }

  function buildCatChips(){
    el("catChips").innerHTML = `
      <button class="chipBtn ${catAtivaId==="all" ? "active":""}" onclick="setCategoria('all')">Todos</button>
      ${categorias.map(c=>`
        <button class="chipBtn ${String(catAtivaId)===String(c.id) ? "active":""}" onclick="setCategoria('${c.id}')">
          ${escapeHtml(c.nome)}
        </button>
      `).join("")}
    `;
  }

  function setCategoria(id){
    catAtivaId = id;
    buildCatChips();
    renderProdutos();
  }

  function getImagemProduto(p){
    // compat: se existir imagem_url usa, sen√£o tenta imagem
    const url = p?.imagem_url || p?.imagem || "";
    return String(url||"").trim();
  }

  function renderProdutos(){
    const q = (el("searchProdutos").value||"").trim().toLowerCase();

    let list = produtos.slice();
    if (catAtivaId !== "all"){
      list = list.filter(p => String(p.categoria_id) === String(catAtivaId));
    }
    if (q){
      list = list.filter(p =>
        (p.nome||"").toLowerCase().includes(q) ||
        (p.descricao||"").toLowerCase().includes(q)
      );
    }

    if (!list.length){
      el("prodGrid").innerHTML = `<div style="color:#6b7280">Nenhum produto encontrado.</div>`;
      return;
    }

    el("prodGrid").innerHTML = list.map(p=>{
      const img = getImagemProduto(p);
      return `
        <div class="prodCard">
          <div class="prodImg">
            ${img ? `<img src="${escapeHtml(img)}" alt="">` : "Sem imagem"}
          </div>
          <div class="prodBody">
            <div class="prodName">${escapeHtml(p.nome)}</div>
            <div class="prodDesc">${escapeHtml(p.descricao||"")}</div>
            <div class="prodBottom">
              <div>
                <div class="price">${money(p.preco)}</div>
                <div class="store">${escapeHtml(clienteAtual?.nome || "")}</div>
              </div>
              <button class="btn brand" style="padding:10px 12px" onclick="addCarrinho('${p.id}')">‚ûï</button>
            </div>
          </div>
        </div>
      `;
    }).join("");
  }

  /* ================================
     CARRINHO
  ================================= */
  function addCarrinho(prodId){
    const p = produtos.find(x => String(x.id) === String(prodId));
    if (!p) return;
    carrinho.push(p);
    updateCart();
  }
  function updateCart(){
    const total = carrinho.reduce((s,p)=>s+Number(p.preco||0),0);
    el("total").textContent = "Total: " + money(total);
    el("cartCount").textContent = carrinho.length + (carrinho.length===1 ? " item" : " itens");
  }
  function limparCarrinho(){ carrinho=[]; updateCart(); }

  function finalizarPedido(){
    if (!clienteAtual) return alert("Escolha uma loja primeiro.");
    if (!clienteAtual.whatsapp) return alert("Esta loja n√£o tem WhatsApp cadastrado.");
    if (carrinho.length === 0) return;

    const linhas = carrinho.map(p => `‚Ä¢ ${p.nome} - ${money(p.preco)}`).join("%0A");
    const total = carrinho.reduce((s,p)=>s+Number(p.preco||0),0);
    const texto = `Pedido:%0A${linhas}%0A%0ATotal: ${money(total)}`;
    window.open(`https://wa.me/55${clienteAtual.whatsapp}?text=${texto}`, "_blank");
  }

  /* ================================
     NAV
  ================================= */
  window.addEventListener("popstate", async ()=>{
    const slug = getParamSlug();
    if (slug) await loadVitrine(slug);
    else showHome();
  });

  /* ================================
     INIT
  ================================= */
  (async function init(){
    el("btnReload").addEventListener("click", loadClientes);
    el("searchClientes").addEventListener("input", renderClientes);
    el("btnBack").addEventListener("click", showHome);
    el("searchProdutos").addEventListener("input", renderProdutos);

    el("btnLimpar").addEventListener("click", limparCarrinho);
    el("finalizar").addEventListener("click", finalizarPedido);

    updateCart();
    await loadClientes();

    const slug = getParamSlug();
    if (slug) await loadVitrine(slug);
  })();
</script>
</body>
</html>
