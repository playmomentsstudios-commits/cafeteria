<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CardÃ¡pio Digital</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#fff7d6;
      --bg2:#fff2bf;
      --card:#ffffff;
      --line:rgba(0,0,0,.08);
      --text:#1b1b22;
      --muted:rgba(27,27,34,.65);

      --y:#ffd24a;
      --y2:#ffbb1a;
      --dark:#141622;

      --shadow: 0 18px 60px rgba(20,22,34,.14);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 20% 0%, rgba(255,210,74,.55), transparent 60%),
        radial-gradient(800px 500px at 80% 15%, rgba(255,187,26,.35), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      padding:14px 12px 90px;
    }
    .wrap{max-width:1200px;margin:0 auto}

    .topbar{
      position:sticky; top:10px; z-index:50;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px 12px;border-radius:24px;
      background:rgba(255,255,255,.72);
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .logo{
      width:44px;height:44px;border-radius:16px;overflow:hidden;
      background:rgba(255,255,255,.9);border:1px solid var(--line);
      display:flex;align-items:center;justify-content:center;
      flex:0 0 auto;
    }
    .logo img{width:100%;height:100%;object-fit:cover}
    .brandTxt{min-width:0}
    .brandTxt b{display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .brandTxt span{display:block;color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .btn{
      border:none;cursor:pointer;
      padding:10px 12px;border-radius:14px;
      background:rgba(0,0,0,.06);
      border:1px solid rgba(0,0,0,.08);
      color:var(--text);
      font-weight:900;
      display:inline-flex;align-items:center;gap:8px;
      white-space:nowrap;
    }
    .btn.y{background:linear-gradient(135deg,var(--y),var(--y2));border-color:rgba(0,0,0,.08)}
    .btn.dark{background:var(--dark);color:#fff;border-color:rgba(0,0,0,.12)}

    .hero{
      margin-top:12px;
      padding:16px;border-radius:24px;
      background:rgba(255,255,255,.72);
      border:1px solid var(--line);
      box-shadow:var(--shadow);
    }
    .hero h1{margin:0;font-size:22px}
    .hero p{margin:8px 0 0;color:var(--muted);line-height:1.4}

    .filters{
      margin-top:12px;
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
    }
    .search{
      flex:1;min-width:220px;
      padding:11px 12px;border-radius:14px;
      background:#fff;border:1px solid var(--line);
      outline:none;
    }
    .chips{
      display:flex;gap:8px;overflow:auto;max-width:100%;
      padding:6px;border-radius:999px;
      background:rgba(0,0,0,.04);
      border:1px solid rgba(0,0,0,.06);
      scrollbar-width:none;
    }
    .chips::-webkit-scrollbar{display:none}
    .chip{
      border:none;cursor:pointer;
      padding:9px 12px;border-radius:999px;
      background:transparent;
      color:rgba(27,27,34,.75);
      font-weight:900;
      white-space:nowrap;
    }
    .chip.active{background:rgba(255,210,74,.55); color:#16161b}

    .section{
      margin-top:12px;
      padding:14px;border-radius:24px;
      background:rgba(255,255,255,.72);
      border:1px solid var(--line);
      box-shadow:var(--shadow);
    }
    .sectionHead{
      display:flex;align-items:flex-end;justify-content:space-between;gap:10px;flex-wrap:wrap;
      margin-bottom:10px;
    }
    .sectionHead h2{margin:0;font-size:16px}
    .sectionHead span{color:var(--muted);font-size:12px}

    /* LOJAS: grid 4 */
    .gridLojas{
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:12px;
    }
    .loja{
      border-radius:18px;
      background:#fff;
      border:1px solid var(--line);
      overflow:hidden;
      display:flex;flex-direction:column;
      min-height:220px;
      transition: transform .12s ease;
    }
    .loja:hover{transform: translateY(-2px)}
    .lojaCover{
      height:120px;
      background:linear-gradient(135deg, rgba(255,210,74,.55), rgba(255,187,26,.35));
      display:flex;align-items:center;justify-content:center;
      position:relative;
    }
    .lojaCover img{
      width:100%;height:100%;object-fit:cover;display:block;
    }
    .lojaBody{padding:12px;display:flex;flex-direction:column;gap:8px;flex:1}
    .lojaNome{font-weight:1000;line-height:1.1}
    .lojaMeta{color:var(--muted);font-size:12px}
    .lojaBtns{margin-top:auto;display:flex;gap:8px}
    .lojaBtns .btn{flex:1;justify-content:center}

    /* VITRINE: produtos 4 */
    .barLoja{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      margin-bottom:10px;
    }
    .barLoja .info b{display:block;font-size:16px}
    .barLoja .info span{display:block;color:var(--muted);font-size:12px}
    .gridProd{
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:12px;
      margin-top:12px;
    }
    .prod{
      border-radius:18px;
      background:#fff;
      border:1px solid var(--line);
      overflow:hidden;
      min-height:220px;
      display:flex;flex-direction:column;
    }
    .prodImg{
      height:120px;
      background:rgba(0,0,0,.04);
    }
    .prodImg img{width:100%;height:100%;object-fit:cover;display:block}
    .prodBody{padding:12px;display:flex;flex-direction:column;gap:8px;flex:1}
    .prodNome{font-weight:1000;line-height:1.1}
    .prodDesc{color:var(--muted);font-size:12px;min-height:32px}
    .prodBottom{margin-top:auto;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .price{font-weight:1000}
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:7px 10px;border-radius:999px;
      background:rgba(0,0,0,.05);
      border:1px solid rgba(0,0,0,.06);
      font-weight:900;font-size:12px;
      white-space:nowrap;
    }

    .cart{
      position:fixed;left:0;right:0;bottom:0;
      padding:12px 14px;
      background:rgba(255,255,255,.85);
      border-top:1px solid rgba(0,0,0,.08);
      backdrop-filter: blur(10px);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .cart b{display:block}
    .cart span{display:block;color:var(--muted);font-size:12px}

    .hidden{display:none !important}

    @media (max-width:1050px){
      .gridLojas,.gridProd{grid-template-columns:repeat(2,minmax(0,1fr))}
    }
    @media (max-width:720px){
      .gridLojas,.gridProd{grid-template-columns:1fr}
      .topbar{top:6px}
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div class="brand">
      <div class="logo">
        <img src="./logo.png" onerror="this.style.display='none';this.parentElement.textContent='CD'">
      </div>
      <div class="brandTxt">
        <b>CardÃ¡pio Digital</b>
        <span>Encontre lojas e produtos da Chapada dos Veadeiros.</span>
      </div>
    </div>

    <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
      <a class="btn dark" href="./cliente/">ðŸ‘¤ Login do Comerciante</a>
    </div>
  </div>

  <div class="hero">
    <h1>Encontre aqui comÃ©rcios da Chapada dos Veadeiros</h1>
    <p>Escolha uma loja ativa, filtre por tipo de negÃ³cio e veja produtos por categoria. Finalize o pedido no WhatsApp.</p>

    <div class="filters">
      <div class="chips" id="chipsNegocio"></div>
      <input class="search" id="searchLojas" placeholder="Buscar loja (nome ou slug)..." />
      <button class="btn y" id="btnReload">ðŸ”„ Atualizar</button>
    </div>
  </div>

  <div class="section" id="secLojas">
    <div class="sectionHead">
      <h2>Lojas em destaque</h2>
      <span><b id="countLojas">â€”</b> lojas</span>
    </div>
    <div class="gridLojas" id="gridLojas"></div>
  </div>

  <div class="section hidden" id="secVitrine">
    <div class="barLoja">
      <div class="info">
        <b id="lojaNome">â€”</b>
        <span>Tipo: <span id="lojaTipo">â€”</span> â€¢ WhatsApp: <span id="lojaWhats">â€”</span></span>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <input class="search" id="searchProd" placeholder="Buscar produtos..." style="max-width:360px" />
        <button class="btn" id="btnBack">â¬… Voltar</button>
      </div>
    </div>

    <div class="chips" id="chipsCat"></div>
    <div class="gridProd" id="gridProd"></div>
  </div>

</div>

<div class="cart" id="cart">
  <div>
    <b id="total">Total: R$ 0,00</b>
    <span id="qtd">0 itens</span>
  </div>
  <div style="display:flex;gap:8px">
    <button class="btn" id="btnLimpar">ðŸ§¹ Limpar</button>
    <button class="btn y" id="btnFinalizar">ðŸ“² Finalizar</button>
  </div>
</div>

<script>
  const SUPABASE_URL = "https://rgsnmxspyywwouhcdwkj.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_nHPsCV3y79FgexEMAeANWQ_P6jWRDd1";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const el = (id)=>document.getElementById(id);
  const money = (v)=>Number(v||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});

  let lojas = [];
  let filtroTipo = "Todos";

  let lojaAtual = null;
  let categorias = [];
  let produtos = [];
  let catAtiva = "all";

  let carrinho = [];

  function setUrlSlug(slug){
    const url = new URL(window.location.href);
    if (slug) url.searchParams.set("u", slug);
    else url.searchParams.delete("u");
    history.pushState({}, "", url.toString());
  }
  function getUrlSlug(){
    const p = new URLSearchParams(location.search);
    return p.get("u");
  }

  function renderChipsNegocio(){
    const tipos = ["Todos", ...Array.from(new Set(lojas.map(x=>x.tipo_negocio).filter(Boolean)))];
    const wrap = el("chipsNegocio");
    wrap.innerHTML = tipos.map(t=>`
      <button class="chip ${t===filtroTipo?"active":""}" onclick="setTipo('${escapeHtml(t)}')">${escapeHtml(t)}</button>
    `).join("");
  }
  window.setTipo = (t)=>{ filtroTipo=t; renderLojas(); renderChipsNegocio(); };

  async function loadLojas(){
    const { data, error } = await sb
      .from("clientes")
      .select("nome,slug,whatsapp,ativo,tipo_negocio,logo_url")
      .eq("ativo", true)
      .order("nome", { ascending:true });

    if (error){
      el("gridLojas").innerHTML = `<div>Erro ao carregar lojas: ${escapeHtml(error.message)}</div>`;
      return;
    }
    lojas = data || [];
    el("countLojas").textContent = lojas.length;
    renderChipsNegocio();
    renderLojas();
  }

  function renderLojas(){
    const q = (el("searchLojas").value||"").trim().toLowerCase();
    let list = lojas.slice();

    if (filtroTipo !== "Todos"){
      list = list.filter(x=>String(x.tipo_negocio||"").toLowerCase() === String(filtroTipo).toLowerCase());
    }
    if (q){
      list = list.filter(x=>
        (x.nome||"").toLowerCase().includes(q) ||
        (x.slug||"").toLowerCase().includes(q)
      );
    }

    const grid = el("gridLojas");
    if (!list.length){
      grid.innerHTML = `<div style="color:rgba(27,27,34,.65)">Nenhuma loja encontrada.</div>`;
      return;
    }

    grid.innerHTML = list.map(c=>`
      <div class="loja">
        <div class="lojaCover">
          ${c.logo_url ? `<img src="${escapeHtml(c.logo_url)}" alt="">` : `<div class="pill">Sem logo</div>`}
        </div>
        <div class="lojaBody">
          <div class="lojaNome">${escapeHtml(c.nome||"Loja")}</div>
          <div class="lojaMeta">${escapeHtml(c.tipo_negocio||"")}</div>
          <div class="lojaBtns">
            <button class="btn y" onclick="abrirLoja('${c.slug}')">Ver produtos</button>
          </div>
        </div>
      </div>
    `).join("");
  }

  window.abrirLoja = async (slug)=>{
    setUrlSlug(slug);
    await loadVitrine(slug);
  };

  async function loadVitrine(slug){
    const { data: cli, error: e1 } = await sb
      .from("clientes")
      .select("*")
      .eq("slug", slug)
      .eq("ativo", true)
      .single();

    if (e1 || !cli){
      setUrlSlug(null);
      showHome();
      return;
    }

    lojaAtual = cli;

    const { data: cats } = await sb
      .from("categorias")
      .select("*")
      .eq("cliente_slug", slug)
      .eq("ativo", true)
      .order("ordem", { ascending:true });

    const { data: prods } = await sb
      .from("produtos")
      .select("*")
      .eq("cliente_slug", slug)
      .eq("ativo", true);

    categorias = cats || [];
    produtos = prods || [];
    catAtiva = "all";

    el("lojaNome").textContent = cli.nome || "Loja";
    el("lojaTipo").textContent = cli.tipo_negocio || "â€”";
    el("lojaWhats").textContent = cli.whatsapp || "â€”";

    renderChipsCat();
    renderProdutos();

    el("secLojas").classList.add("hidden");
    el("secVitrine").classList.remove("hidden");
  }

  function renderChipsCat(){
    const wrap = el("chipsCat");
    wrap.innerHTML = `
      <button class="chip ${catAtiva==="all"?"active":""}" onclick="setCat('all')">Todos</button>
      ${categorias.map(c=>`
        <button class="chip ${String(catAtiva)===String(c.id)?"active":""}" onclick="setCat('${c.id}')">${escapeHtml(c.nome)}</button>
      `).join("")}
    `;
  }
  window.setCat = (id)=>{ catAtiva=id; renderChipsCat(); renderProdutos(); };

  function renderProdutos(){
    const q = (el("searchProd").value||"").trim().toLowerCase();
    let list = produtos.slice();

    if (catAtiva !== "all"){
      list = list.filter(p=>String(p.categoria_id)===String(catAtiva));
    }
    if (q){
      list = list.filter(p=>
        (p.nome||"").toLowerCase().includes(q) ||
        (p.descricao||"").toLowerCase().includes(q)
      );
    }

    const grid = el("gridProd");
    if (!list.length){
      grid.innerHTML = `<div style="color:rgba(27,27,34,.65)">Nenhum produto encontrado.</div>`;
      return;
    }

    grid.innerHTML = list.map(p=>`
      <div class="prod">
        <div class="prodImg">
          ${p.imagem_url ? `<img src="${escapeHtml(p.imagem_url)}" alt="">` : ""}
        </div>
        <div class="prodBody">
          <div class="prodNome">${escapeHtml(p.nome||"Produto")}</div>
          <div class="prodDesc">${escapeHtml(p.descricao||"")}</div>
          <div class="prodBottom">
            <div class="price">${money(p.preco)}</div>
            <button class="btn y" onclick="add('${p.id}')">âž•</button>
          </div>
          <div class="pill">Loja: ${escapeHtml(lojaAtual?.nome||"")}</div>
        </div>
      </div>
    `).join("");
  }

  window.add = (id)=>{
    const p = produtos.find(x=>String(x.id)===String(id));
    if (!p) return;
    carrinho.push(p);
    updateCart();
  };

  function updateCart(){
    const total = carrinho.reduce((s,p)=>s+Number(p.preco||0),0);
    el("total").textContent = "Total: " + money(total);
    el("qtd").textContent = carrinho.length + (carrinho.length===1 ? " item" : " itens");
  }

  function showHome(){
    lojaAtual=null; categorias=[]; produtos=[]; catAtiva="all";
    el("secVitrine").classList.add("hidden");
    el("secLojas").classList.remove("hidden");
  }

  function escapeHtml(str){
    return String(str ?? "").replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  el("btnReload").addEventListener("click", loadLojas);
  el("searchLojas").addEventListener("input", renderLojas);
  el("searchProd").addEventListener("input", renderProdutos);

  el("btnBack").addEventListener("click", ()=>{
    setUrlSlug(null);
    showHome();
  });

  el("btnLimpar").addEventListener("click", ()=>{ carrinho=[]; updateCart(); });

  el("btnFinalizar").addEventListener("click", ()=>{
    if (!lojaAtual) return alert("Escolha uma loja primeiro.");
    if (!lojaAtual.whatsapp) return alert("Esta loja nÃ£o tem WhatsApp cadastrado.");
    if (!carrinho.length) return;

    const itens = carrinho.map(p=>`â€¢ ${p.nome} - ${money(p.preco)}`).join("%0A");
    const total = carrinho.reduce((s,p)=>s+Number(p.preco||0),0);
    const texto = `Pedido:%0A${itens}%0A%0ATotal: ${money(total)}`;
    window.open(`https://wa.me/55${lojaAtual.whatsapp}?text=${texto}`, "_blank");
  });

  window.addEventListener("popstate", async ()=>{
    const slug = getUrlSlug();
    if (slug) await loadVitrine(slug);
    else showHome();
  });

  (async ()=>{
    updateCart();
    await loadLojas();

    const slug = getUrlSlug();
    if (slug) await loadVitrine(slug);
  })();
</script>
</body>
</html>
